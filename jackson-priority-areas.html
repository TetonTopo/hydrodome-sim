<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>V25 - HydroDome Fort St. James Demo (Client Demo Mode)</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; display:flex; height:100vh; overflow:hidden; background:#1a1a2e; }

#sidebar {
  width: 340px; min-width: 340px;
  background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
  color: #e0e0e0; display:flex; flex-direction:column;
  z-index: 1000; overflow-y:auto;
  border-right: 2px solid #2D5016;
}
#sidebar::-webkit-scrollbar { width:6px; }
#sidebar::-webkit-scrollbar-thumb { background:#2D5016; border-radius:3px; }

.logo-area {
  padding: 20px; text-align:center;
  background: linear-gradient(135deg, #2D5016 0%, #1a3a0a 100%);
  border-bottom: 3px solid #FF6B35;
}
.logo-area h1 { font-size:28px; color:#fff; letter-spacing:2px; margin-bottom:2px; }
.logo-area .dome-icon { font-size:36px; margin-bottom:4px; }
.logo-area .subtitle { font-size:12px; color:#FF6B35; text-transform:uppercase; letter-spacing:3px; }
.logo-area .location { font-size:11px; color:#8fbc8f; margin-top:6px; }

.section {
  padding:14px 18px; border-bottom:1px solid rgba(255,255,255,0.08);
  transition: background 0.2s;
}
.section.drag-over { background: rgba(255,107,53,0.1); border-top: 2px solid #FF6B35; }
.section-header {
  display:flex; align-items:center; cursor:pointer; user-select:none;
}
.section-header .drag-handle {
  cursor:grab; margin-right:8px; color:#555; font-size:14px; line-height:1;
}
.section-header .drag-handle:active { cursor:grabbing; }
.section-header h3 {
  font-size:12px; text-transform:uppercase; letter-spacing:2px; color:#FF6B35; margin:0; flex:1;
}
.section-header .collapse-arrow {
  font-size:10px; color:#666; transition:transform 0.2s; margin-left:8px;
}
.section.collapsed .section-body { display:none; }
.section.collapsed .collapse-arrow { transform:rotate(-90deg); }
.section-body { margin-top:10px; }

.btn {
  display:block; width:100%; padding:10px 14px; margin-bottom:8px;
  border:none; border-radius:6px; font-size:13px; font-weight:600;
  cursor:pointer; transition: all 0.2s; text-align:center;
}
.btn-primary { background:#2D5016; color:#fff; }
.btn-primary:hover { background:#3a6b1e; }
.btn-primary.active { background:#FF6B35; color:#fff; box-shadow:0 0 12px rgba(255,107,53,0.4); }
.btn-orange { background:#FF6B35; color:#fff; }
.btn-orange:hover { background:#ff8555; }
.btn-danger { background:#c0392b; color:#fff; }
.btn-danger:hover { background:#e74c3c; }
.btn-outline { background:transparent; color:#8fbc8f; border:1px solid #2D5016; }
.btn-outline:hover { background:rgba(45,80,22,0.3); }
.btn-sim { background: linear-gradient(135deg, #2D5016, #FF6B35); color:#fff; }
.btn-sim:hover { opacity:0.9; }
.btn-timesim { background: linear-gradient(135deg, #3498db, #2ecc71); color:#fff; }
.btn-timesim:hover { opacity:0.9; }
.btn-fire { background: linear-gradient(135deg, #e74c3c, #f39c12); color:#fff; }
.btn-fire:hover { opacity:0.9; }
.btn-fire.active { box-shadow:0 0 12px rgba(231,76,60,0.6); }
.btn-scada { background: linear-gradient(135deg, #1a1a2e, #2c3e50); color:#2ecc71; border:1px solid #2ecc71; }
.btn-scada:hover { background:#2c3e50; }
.btn-evac { background: linear-gradient(135deg, #c0392b, #e67e22); color:#fff; border:1px solid #e74c3c; }
.btn-evac:hover { opacity:0.9; }
.btn-evac.active { box-shadow:0 0 12px rgba(231,76,60,0.5); }

.stat-grid { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
.stat-card {
  background: rgba(255,255,255,0.05); border-radius:8px; padding:10px;
  text-align:center; border:1px solid rgba(45,80,22,0.3);
}
.stat-card .value { font-size:22px; font-weight:700; color:#fff; }
.stat-card .label { font-size:10px; color:#aaa; text-transform:uppercase; letter-spacing:1px; margin-top:2px; }
.stat-card.full { grid-column:1/-1; }

.capacity-bar { height:8px; background:rgba(255,255,255,0.1); border-radius:4px; margin-top:6px; overflow:hidden; }
.capacity-fill { height:100%; border-radius:4px; transition: width 0.5s, background 0.5s; }
.capacity-label { font-size:11px; margin-top:4px; text-align:center; }

.status-badge {
  display:inline-block; padding:4px 12px; border-radius:12px;
  font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:1px;
}
.status-green { background:rgba(46,204,113,0.2); color:#2ecc71; border:1px solid #2ecc71; }
.status-yellow { background:rgba(241,196,15,0.2); color:#f1c40f; border:1px solid #f1c40f; }
.status-red { background:rgba(231,76,60,0.2); color:#e74c3c; border:1px solid #e74c3c; }

#map-container { flex:1; position:relative; }
#map { width:100%; height:100%; }

#map-tooltip {
  position:absolute; top:10px; left:50%; transform:translateX(-50%);
  background:rgba(26,26,46,0.9); color:#FF6B35; padding:8px 20px;
  border-radius:20px; font-size:13px; font-weight:600; z-index:999;
  pointer-events:none; transition:opacity 0.3s; border:1px solid #FF6B35;
}
#map-tooltip.hidden { opacity:0; }

#legend {
  position:absolute; bottom:20px; right:10px; z-index:999;
  background:rgba(26,26,46,0.92); padding:12px 16px; border-radius:8px;
  font-size:11px; color:#ccc; border:1px solid rgba(45,80,22,0.5);
}
#legend h4 { color:#FF6B35; margin-bottom:6px; font-size:11px; text-transform:uppercase; letter-spacing:1px; }
.legend-item { display:flex; align-items:center; margin:4px 0; }
.legend-color { width:24px; height:4px; border-radius:2px; margin-right:8px; }
.legend-circle { width:12px; height:12px; border-radius:50%; margin-right:8px; border:2px solid; }

#coverage-display {
  position:absolute; top:10px; right:10px; z-index:999;
  background:rgba(26,26,46,0.92); padding:12px 16px; border-radius:8px;
  font-size:13px; color:#fff; border:1px solid #2D5016; min-width:140px; text-align:center;
}
#coverage-display .cov-val { font-size:28px; font-weight:700; color:#2ecc71; }
#coverage-display .cov-lbl { font-size:10px; color:#aaa; text-transform:uppercase; letter-spacing:1px; }

#cost-overlay {
  position:absolute; top:80px; right:10px; z-index:999;
  background:rgba(26,26,46,0.92); padding:14px 18px; border-radius:8px;
  font-size:13px; color:#fff; border:1px solid #FF6B35; min-width:200px;
}
#cost-overlay .cost-title { font-size:10px; color:#FF6B35; text-transform:uppercase; letter-spacing:1px; margin-bottom:8px; }
#cost-overlay .cost-row { display:flex; justify-content:space-between; margin:4px 0; }
#cost-overlay .cost-label { color:#aaa; font-size:12px; }
#cost-overlay .cost-value { font-weight:700; font-size:14px; }
#cost-overlay .roi-value { font-size:22px; font-weight:700; color:#2ecc71; text-align:center; margin-top:6px; }

#reservoir-gauge {
  position:absolute; z-index:800; pointer-events:none;
  display:none;
}
.res-gauge-inner {
  width:40px; height:100px; background:rgba(26,26,46,0.9); border-radius:6px;
  border:1px solid #3498db; overflow:hidden; position:relative; pointer-events:auto;
}
.res-gauge-fill {
  position:absolute; bottom:0; left:0; right:0;
  background: linear-gradient(to top, #3498db, #5dade2);
  transition: height 0.3s, background 0.5s;
}
.res-gauge-label {
  position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
  font-size:10px; font-weight:700; color:#fff; text-shadow:0 1px 3px rgba(0,0,0,0.8);
  z-index:2; white-space:nowrap;
}
.res-gauge-title {
  font-size:8px; color:#aaa; text-align:center; margin-top:2px; pointer-events:auto;
}

#sim-clock {
  position:absolute; top:10px; left:50%; transform:translateX(-50%);
  background:rgba(26,26,46,0.95); color:#3498db; padding:10px 24px;
  border-radius:12px; font-size:22px; font-weight:700; z-index:999;
  border:2px solid #3498db; display:none; font-family:monospace;
}

#timeline-bar {
  position:absolute; bottom:0; left:0; right:0; height:40px;
  background:rgba(16,16,30,0.95); z-index:999; display:none;
  border-top:1px solid rgba(52,152,219,0.5); cursor:pointer;
}
#timeline-bar .tl-fill {
  position:absolute; top:0; left:0; bottom:0;
  background:linear-gradient(90deg, rgba(52,152,219,0.3), rgba(46,204,113,0.3));
  pointer-events:none;
}
#timeline-bar .tl-markers {
  position:absolute; top:0; left:0; right:0; bottom:0;
  display:flex; justify-content:space-between; align-items:center;
  padding:0 20px; pointer-events:none;
}
#timeline-bar .tl-mark { font-size:10px; color:#aaa; font-family:monospace; }
#timeline-bar .tl-playhead {
  position:absolute; top:0; bottom:0; width:3px;
  background:#3498db; box-shadow:0 0 8px rgba(52,152,219,0.6);
  pointer-events:none;
}

#wind-arrow {
  position:absolute; top:60px; left:10px; z-index:999;
  width:50px; height:50px; background:rgba(26,26,46,0.9);
  border-radius:50%; border:1px solid rgba(255,255,255,0.2);
  display:none; align-items:center; justify-content:center;
  font-size:24px;
}

.pipe-tooltip { font-size:12px; }

#scada-panel {
  position:absolute; bottom:50px; left:10px; right:10px; z-index:998;
  background:rgba(5,5,15,0.96); border:2px solid #1a5c1a; border-radius:8px;
  color:#33ff33; font-family:'Courier New',monospace; padding:16px;
  display:none; max-height:280px; overflow-y:auto;
}
#scada-panel::-webkit-scrollbar { width:4px; }
#scada-panel::-webkit-scrollbar-thumb { background:#1a5c1a; }
#scada-panel .scada-header {
  display:flex; justify-content:space-between; align-items:center;
  border-bottom:1px solid #1a5c1a; padding-bottom:8px; margin-bottom:10px;
}
#scada-panel .scada-title { font-size:14px; font-weight:700; color:#33ff33; letter-spacing:2px; }
#scada-panel .scada-close { cursor:pointer; color:#ff3333; font-size:16px; }
.scada-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:10px; }
.scada-meter {
  background:rgba(10,30,10,0.8); border:1px solid #1a5c1a; border-radius:4px;
  padding:8px 10px; text-align:center;
}
.scada-meter .sm-label { font-size:9px; color:#66aa66; text-transform:uppercase; letter-spacing:1px; }
.scada-meter .sm-value { font-size:20px; font-weight:700; margin:4px 0; }
.scada-meter .sm-unit { font-size:10px; color:#448844; }
.scada-meter.alert-yellow .sm-value { color:#ffaa00; }
.scada-meter.alert-red .sm-value { color:#ff3333; animation:scada-blink 0.8s infinite; }
@keyframes scada-blink { 0%,100%{opacity:1;} 50%{opacity:0.4;} }
.scada-valve { display:inline-block; width:12px; height:12px; border-radius:50%; margin:0 3px; border:1px solid #448844; }
.scada-valve.open { background:#33ff33; box-shadow:0 0 4px #33ff33; }
.scada-valve.closed { background:#333; }
.scada-zone-row { display:flex; align-items:center; gap:6px; font-size:11px; margin:3px 0; }

@keyframes building-pulse {
  0%, 100% { fill-opacity:0.7; }
  50% { fill-opacity:0.4; }
}
.building-protected path { animation: building-pulse 2s infinite; }

.ember-dot {
  width:6px; height:6px; border-radius:50%;
  background:radial-gradient(#ffee00, #ff6600);
  box-shadow:0 0 4px #ff6600;
  animation: ember-flicker 0.4s infinite alternate;
}
@keyframes ember-flicker { 0%{opacity:1;transform:scale(1)} 100%{opacity:0.6;transform:scale(0.7)} }

@media (max-width:768px) {
  body { flex-direction:column; }
  #sidebar { width:100%; min-width:auto; max-height:45vh; order:2; }
  #map-container { order:1; flex:1; }
  .stat-grid { grid-template-columns:1fr 1fr; }
}
@media print { #sidebar { display:none; } #map { width:100vw; height:100vh; } }

.wind-row { display:flex; gap:8px; align-items:center; margin:6px 0; }
.wind-row label { font-size:11px; min-width:50px; }
.wind-row select, .wind-row input[type=range] { flex:1; }
.wind-row select {
  background:#1a1a2e; color:#e0e0e0; border:1px solid #2D5016;
  padding:4px 6px; border-radius:4px; font-size:11px;
}
.wind-speed-val { font-size:11px; min-width:40px; text-align:right; color:#3498db; }

.sim-zone-row { display:flex; align-items:center; gap:6px; margin:4px 0; font-size:12px; }
.sim-zone-dot { width:10px; height:10px; border-radius:50%; flex-shrink:0; }
.sim-zone-status { font-weight:600; }
.sim-stat-row { display:flex; justify-content:space-between; font-size:12px; margin:3px 0; }
.sim-stat-val { font-weight:700; color:#fff; }
.cistern-bar-mini { display:inline-block; width:60px; height:8px; background:rgba(255,255,255,0.1); border-radius:4px; overflow:hidden; vertical-align:middle; }
.cistern-bar-mini-fill { height:100%; border-radius:4px; transition:width 0.3s; }

.fire-row { display:flex; gap:8px; align-items:center; margin:6px 0; }
.fire-row label { font-size:11px; min-width:60px; }
.fire-row input[type=range] { flex:1; }
.fire-speed-val { font-size:11px; min-width:30px; text-align:right; color:#e74c3c; }
/* Fullscreen Toggle Button */
#fullscreen-toggle {
  position: absolute;
  top: 80px;
  right: 10px;
  z-index: 1000;
  background: linear-gradient(135deg, #2D5016 0%, #1a3a0a 100%);
  border: 2px solid #FF6B35;
  border-radius: 8px;
  padding: 10px 14px;
  cursor: pointer;
  color: #fff;
  font-size: 20px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  transition: all 0.3s ease;
}
#fullscreen-toggle:hover {
  background: linear-gradient(135deg, #3a6b1e 0%, #234d0c 100%);
  transform: scale(1.05);
  box-shadow: 0 6px 16px rgba(0,0,0,0.4);
}
#fullscreen-toggle .fs-icon {
  display: block;
  line-height: 1;
}

/* Fullscreen Mode */
body.fullscreen-mode #sidebar {
  display: none;
}
body.fullscreen-mode #map-container {
  width: 100% !important;
}
body.fullscreen-mode #legend,
body.fullscreen-mode .stats-overlay,
body.fullscreen-mode #coverage-display,
body.fullscreen-mode #cost-overlay,
body.fullscreen-mode #north-arrow,
body.fullscreen-mode #wind-arrow,
body.fullscreen-mode #sim-clock,
body.fullscreen-mode #timeline-bar {
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;
}
body.fullscreen-mode #fullscreen-toggle .fs-icon::before {
  content: '‚õ∂';
}

</style>
</head>
<body>

<div id="sidebar">
  <div class="logo-area">
    <div class="dome-icon">&#x1f6e1;&#xfe0f;</div>
    <h1>V21 HYDRODOME</h1>
    <div class="subtitle">Wildfire Defense System</div>
    <div class="location">&#x1f4cd; Fort St. James, BC</div>
  </div>

  <div class="section" data-panel="controls">
    <div class="section-header" onclick="toggleSectionCollapse(this)">
      <span class="drag-handle" draggable="true">&#x2807;</span>
      <h3>Controls</h3>
      <span class="collapse-arrow">&#x25bc;</span>
    </div>
    <div class="section-body">
      <button class="btn btn-primary" id="btn-place" onclick="togglePlaceMode()">&#x1f5fc; Place Tower Mode</button>
      <div style="margin:8px 0;padding:8px;background:rgba(255,255,255,0.05);border-radius:6px;">
        <div style="font-size:10px;color:#aaa;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;">üíß Sprinkler Type</div>
        <select id="sprinkler-type-select" onchange="changeSprinklerType(this.value)" style="width:100%;padding:6px 10px;background:#16213e;color:#fff;border:1px solid #2D5016;border-radius:4px;font-size:13px;cursor:pointer;">
          <option value="BG100">Big Gun 100 (180 GPM, 55m)</option>
          <option value="BG150" selected>Big Gun 150 (400 GPM, 70m)</option>
          <option value="BG200">Big Gun 200 (700 GPM, 90m)</option>
        </select>
        <div id="sprinkler-info" style="font-size:10px;color:#8fbc8f;margin-top:4px;">‚úì 400 GPM @ 100 PSI | 1.54 ha coverage</div>
      </div>
      <div style="margin:8px 0;padding:8px;background:rgba(255,255,255,0.05);border-radius:6px;">
        <div style="font-size:10px;color:#aaa;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;">üå¨Ô∏è Wind Speed: <span id="wind-speed-display" style="color:#fff;font-weight:600;">25 km/h</span></div>
        <input type="range" id="wind-speed" min="0" max="60" value="25" step="5" style="width:100%;accent-color:#FF6B35;cursor:pointer;" oninput="setWindSpeed(this.value)">
        <div style="display:flex;justify-content:space-between;font-size:9px;color:#666;margin-top:4px;">
          <span>Calm</span>
          <span>Moderate</span>
          <span>Extreme</span>
        </div>
      </div>
      <button class="btn btn-outline" onclick="exportTowers()" style="border-color:#2ecc71;color:#2ecc71;">üíæ Save Layout</button>
      <button class="btn btn-outline" onclick="importTowers()" style="border-color:#3498db;color:#3498db;">üìÇ Load Layout</button>
      <button class="btn btn-fire" id="btn-ignition" onclick="toggleIgnitionMode()">&#x1f525; Set Ignition Point</button>
      <button class="btn btn-outline" id="btn-force-all" onclick="toggleForceAllOn()" style="border-color:#e67e22;color:#e67e22;">‚ö° Force All On</button>
      <button class="btn btn-outline" id="btn-fire-toggle" onclick="toggleFireBehavior()" style="display:none;">&#x1f525; Fire Model: ON</button>
      <button class="btn btn-sim" id="btn-sim" onclick="runSimulation()">&#x26a1; Run Simulation</button>
      <button class="btn btn-timesim" id="btn-timesim" onclick="toggleTimeSim()">&#x25b6; Run Time Simulation</button>
      <div id="speed-controls" style="display:none;margin-bottom:8px;">
        <div style="font-size:10px;color:#aaa;text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;">Playback Speed: <span id="speed-label" style="color:#fff;font-weight:bold;">1x</span></div>
        <div style="display:flex;align-items:center;gap:8px;">
          <span style="font-size:10px;color:#888;">1x</span>
          <input type="range" id="speed-slider" min="0" max="100" value="0" style="flex:1;accent-color:#3498db;cursor:pointer;" oninput="setSimSpeedFromSlider(this.value)">
          <span style="font-size:10px;color:#888;">100x</span>
        </div>
      </div>
      <button class="btn btn-outline" id="btn-auto-activate" onclick="toggleAutoActivate()" style="border-color:#9b59b6;color:#9b59b6;">üéØ Auto-Activate: ON</button>
      <!-- V17: Evacuation mode removed - was a hydraulic slope parameter (0.01 vs 0.005) for pipe capacity calculations. Not needed for demos. -->
      <button class="btn btn-orange" onclick="loadRecommended()">&#x1f4cb; Load Recommended Layout</button>
      <div style="display:flex; gap:6px; margin-top:4px;">
        <button class="btn btn-outline" style="flex:1" onclick="resetAll()">&#x21ba; Reset</button>
        <button class="btn btn-outline" style="flex:1" onclick="exportReport()">&#x1f4c4; Export</button>
      </div>
      <div style="display:flex; gap:6px; margin-top:4px;">
        <button class="btn btn-outline" style="flex:1" onclick="exportPDF()">&#x1f4c4; Export PDF</button>
        <button class="btn btn-scada" style="flex:1" onclick="toggleSCADA()">&#x1f4ca; SCADA Dashboard</button>
      </div>
      <button class="btn btn-outline" id="btn-spray-anim" onclick="toggleSprayAnimation()" style="margin-top:4px;">&#x1f4a8; Spray Animation: ON</button>
    </div>
  </div>

  <div class="section" data-panel="summary">
    <div class="section-header" onclick="toggleSectionCollapse(this)">
      <span class="drag-handle" draggable="true">&#x2807;</span>
      <h3>System Summary</h3>
      <span class="collapse-arrow">&#x25bc;</span>
    </div>
    <div class="section-body">
      <div class="stat-grid">
        <div class="stat-card">
          <div class="value" id="stat-towers">0</div>
          <div class="label">Towers</div>
        </div>
        <div class="stat-card">
          <div class="value" id="stat-zones">0</div>
          <div class="label">Zones</div>
        </div>
        <div class="stat-card">
          <div class="value" id="stat-flow">0</div>
          <div class="label">GPM Demand</div>
        </div>
        <div class="stat-card">
          <div class="value" id="stat-coverage">0</div>
          <div class="label">Ha Coverage</div>
        </div>
        <div class="stat-card full">
          <div class="value" id="stat-cost">$0</div>
          <div class="label">Est. Cost (CAD)</div>
        </div>
      </div>
      <div style="margin-top:8px;text-align:center;">
        <span id="stat-protected" style="font-size:13px;color:#3498db;font-weight:600;">0/118 structures protected</span>
      </div>
    </div>
  </div>

  <!-- V8: Triage panel moved ABOVE duty cycle and capacity -->
  <div class="section" id="zone-triage-section" style="display:none;" data-panel="triage">
    <div class="section-header" onclick="toggleSectionCollapse(this)">
      <span class="drag-handle" draggable="true">&#x2807;</span>
      <h3>&#x1f3af; Zone Triage</h3>
      <span class="collapse-arrow">&#x25bc;</span>
    </div>
    <div class="section-body">
      <div id="zone-triage-panel" style="font-size:12px; line-height:1.6; color:#bbb;">
        Manual zone control available during simulation.
      </div>
    </div>
  </div>

  <div class="section" id="sim-live-section" style="display:none;" data-panel="simlive">
    <div class="section-header" onclick="toggleSectionCollapse(this)">
      <span class="drag-handle" draggable="true">&#x2807;</span>
      <h3>&#x23f1; Live Simulation</h3>
      <span class="collapse-arrow">&#x25bc;</span>
    </div>
    <div class="section-body">
      <div id="sim-live-panel" style="font-size:12px; line-height:1.6; color:#bbb;"></div>
    </div>
  </div>

  <div class="section" data-panel="capacity">
    <div class="section-header" onclick="toggleSectionCollapse(this)">
      <span class="drag-handle" draggable="true">&#x2807;</span>
      <h3>System Capacity</h3>
      <span class="collapse-arrow">&#x25bc;</span>
    </div>
    <div class="section-body">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <span style="font-size:12px;">Hydraulic Load</span>
        <span class="status-badge status-green" id="status-badge">STANDBY</span>
      </div>
      <div class="capacity-bar"><div class="capacity-fill" id="capacity-fill" style="width:0%;background:#2ecc71;"></div></div>
      <div class="capacity-label" id="capacity-label">No towers placed</div>
    </div>
  </div>

  <div class="section" data-panel="cistern">
    <div class="section-header" onclick="toggleSectionCollapse(this)">
      <span class="drag-handle" draggable="true">&#x2807;</span>
      <h3>Cistern Storage</h3>
      <span class="collapse-arrow">&#x25bc;</span>
    </div>
    <div class="section-body">
      <div id="cistern-info" style="font-size:12px; line-height:1.6; color:#bbb;">
        Place towers to see cistern analysis.
      </div>
    </div>
  </div>

  <div class="section" id="duty-section" data-panel="duty">
    <div class="section-header" onclick="toggleSectionCollapse(this)">
      <span class="drag-handle" draggable="true">&#x2807;</span>
      <h3>Duty Cycle</h3>
      <span class="collapse-arrow">&#x25bc;</span>
    </div>
    <div class="section-body">
      <div id="duty-info" style="font-size:12px; line-height:1.6; color:#bbb;">
        Place towers and run simulation to see duty cycle recommendations.
      </div>
    </div>
  </div>

  <div class="section" id="fire-section" style="display:none;" data-panel="fire">
    <div class="section-header" onclick="toggleSectionCollapse(this)">
      <span class="drag-handle" draggable="true">&#x2807;</span>
      <h3>&#x1f525; Fire Simulation</h3>
      <span class="collapse-arrow">&#x25bc;</span>
    </div>
    <div class="section-body">
      <div class="fire-row">
        <label>Speed</label>
        <input type="range" id="fire-speed-mult" min="0.25" max="5" step="0.25" value="0.25" oninput="document.getElementById('fire-speed-val').textContent=this.value+'x'">
        <span class="fire-speed-val" id="fire-speed-val">0.25x</span>
      </div>
      <div id="fire-info" style="font-size:12px; line-height:1.6; color:#bbb;"></div>
    </div>
  </div>

  <div class="section" data-panel="wind">
    <div class="section-header" onclick="toggleSectionCollapse(this)">
      <span class="drag-handle" draggable="true">&#x2807;</span>
      <h3>Wind</h3>
      <span class="collapse-arrow">&#x25bc;</span>
    </div>
    <div class="section-body">
      <div class="wind-row">
        <label>Direction</label>
        <select id="wind-dir" onchange="updateWind()">
          <option value="-1">Calm</option>
          <option value="0">N</option><option value="45">NE</option>
          <option value="90">E</option><option value="135">SE</option>
          <option value="180">S</option><option value="225" selected>SW</option>
          <option value="270">W</option><option value="315">NW</option>
        </select>
      </div>
      <div class="wind-row">
        <label>Speed</label>
        <input type="range" id="wind-speed" min="0" max="30" value="25" oninput="updateWind()">
        <span class="wind-speed-val" id="wind-speed-val">25 km/h</span>
      </div>
    </div>
  </div>

  <div class="section" data-panel="layers">
    <div class="section-header" onclick="toggleSectionCollapse(this)">
      <span class="drag-handle" draggable="true">&#x2807;</span>
      <h3>Map Layers</h3>
      <span class="collapse-arrow">&#x25bc;</span>
    </div>
    <div class="section-body">
      <label style="display:flex;align-items:center;gap:8px;font-size:12px;margin:4px 0;cursor:pointer;">
        <input type="checkbox" checked onchange="toggleLayer('pipes',this.checked)"> Water Mains
      </label>
      <label style="display:flex;align-items:center;gap:8px;font-size:12px;margin:4px 0;cursor:pointer;">
        <input type="checkbox" checked onchange="toggleLayer('hydrants',this.checked)"> Hydrants
      </label>
      <label style="display:flex;align-items:center;gap:8px;font-size:12px;margin:4px 0;cursor:pointer;">
        <input type="checkbox" checked onchange="toggleLayer('buildings',this.checked)"> Buildings
      </label>
      <label style="display:flex;align-items:center;gap:8px;font-size:12px;margin:4px 0;cursor:pointer;">
        <input type="checkbox" checked onchange="toggleLayer('coverage',this.checked)"> Coverage Circles
      </label>
      <label style="display:flex;align-items:center;gap:8px;font-size:12px;margin:4px 0;cursor:pointer;">
        <input type="checkbox" checked onchange="toggleLayer('fire',this.checked)"> Fire Layer
      </label>
      <label style="display:flex;align-items:center;gap:8px;font-size:12px;margin:4px 0;cursor:pointer;">
        <input type="checkbox" id="chk-spray-anim" onchange="setSprayAnimation(this.checked)"> Spray Animation
      </label>
    </div>
  </div>

  <div class="section" style="border-bottom:none;" data-panel="about">
    <div class="section-header" onclick="toggleSectionCollapse(this)">
      <span class="drag-handle" draggable="true">&#x2807;</span>
      <h3>About</h3>
      <span class="collapse-arrow">&#x25bc;</span>
    </div>
    <div class="section-body">
      <p style="font-size:11px; line-height:1.5; color:#888;">
        HydroDome uses Nelson Big Gun 150 Series sprinklers mounted on 30ft towers to create humidity domes that protect structures from wildfire. Each tower covers ~1.54 ha (140m diameter) at 400 GPM, 100 PSI. Towers operate on duty cycling via Capstone C65 microturbine-powered zones. V21 fixes <b style="color:#3498db;">Buildings Protected display</b> (replaced Harrison data with Fort St. James building grid - 118 structures - now shows actual coverage %), ember-only activation (zones spray when embers within 100m), strategic 16-tower layout (hospital SE coverage), ultra-slow fire (0.25x), organic geometry, force field protection. Click "Load Recommended Layout" for instant deployment showing 40-50% coverage. Water network from OpenStreetMap (409 Fort St. James roads).
      </p>
      <p style="font-size:10px; color:#555; margin-top:8px;">&copy; 2025 Carmanah Wildfire Defense</p>
    </div>
  </div>
</div>

<div id="map-container">
  <div id="map"></div>
  <button id="fullscreen-toggle" title="Toggle Fullscreen Map" aria-label="Toggle fullscreen">
    <span class="fs-icon">‚õ∂</span>
  </button>
  <canvas id="spray-canvas" style="position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:450;"></canvas>
  <div id="map-tooltip" class="hidden">Click map to place tower</div>
  <div id="sim-clock">T+00:00</div>
  <div id="coverage-display">
    <div class="cov-val" id="cov-pct">0%</div>
    <div class="cov-lbl">Buildings Protected</div>
    <div style="font-size:9px;color:#666;margin-top:2px;" id="cov-sub">Place towers to protect</div>
  </div>
  <div id="cost-overlay">
    <div class="cost-title">Cost vs Damage</div>
    <div class="cost-row"><span class="cost-label">System Cost:</span><span class="cost-value" id="cost-system" style="color:#FF6B35;">$0</span></div>
    <div class="cost-row"><span class="cost-label">Protects Against:</span><span class="cost-value" style="color:#e74c3c;">$500M+</span></div>
    <div class="roi-value" id="cost-roi">--</div>
    <div style="font-size:9px;color:#666;text-align:center;">Return on Investment</div>
  </div>
  <div id="north-arrow" style="
    position:absolute; top:80px; right:10px; z-index:999;
    width:44px; height:44px; background:rgba(26,26,46,0.9);
    border-radius:50%; border:1px solid rgba(255,255,255,0.3);
    display:flex; align-items:center; justify-content:center;
    flex-direction:column; pointer-events:none;
  ">
    <div style="font-size:9px;color:#e74c3c;font-weight:900;line-height:1;margin-bottom:-2px;">N</div>
    <div style="width:0;height:0;border-left:6px solid transparent;border-right:6px solid transparent;border-bottom:12px solid #e74c3c;margin-bottom:-1px;"></div>
    <div style="width:0;height:0;border-left:6px solid transparent;border-right:6px solid transparent;border-top:12px solid #fff;"></div>
  </div>
  <div id="wind-arrow">&#x2b07;</div>
  <div id="reservoir-gauge"></div>
  <div id="legend">
    <h4>Legend</h4>
    <div class="legend-item"><div class="legend-color" style="background:#1a75ff;height:5px;"></div> Trunk/Main (8"-10")</div>
    <div class="legend-item"><div class="legend-color" style="background:#4da6ff;"></div> Secondary (6")</div>
    <div class="legend-item"><div class="legend-color" style="background:#2ecc71;"></div> Pipe &lt;60% load</div>
    <div class="legend-item"><div class="legend-color" style="background:#f1c40f;"></div> Pipe 60-85% load</div>
    <div class="legend-item"><div class="legend-color" style="background:#e74c3c;"></div> Pipe &gt;85% load</div>
    <div class="legend-item"><div class="legend-circle" style="background:rgba(45,80,22,0.3);border-color:#2D5016;width:10px;height:10px;"></div> Tower Coverage</div>
    <div class="legend-item"><div class="legend-circle" style="background:#e74c3c;border-color:#e74c3c;width:8px;height:8px;"></div> Hydrant</div>
    <div class="legend-item"><div class="legend-color" style="background:linear-gradient(90deg,#ff4400,#ff8800);height:6px;"></div> Fire Front</div>
    <div class="legend-item"><div class="legend-circle" style="background:#ffaa00;border-color:#ff6600;width:8px;height:8px;"></div> Ember Zone</div>
    <div class="legend-item"><div class="legend-circle" style="background:#ff6600;border-color:#ff6600;width:8px;height:8px;border-style:dashed;"></div> Spot Fire</div>
    <div class="legend-item" style="margin-top:4px;font-size:10px;color:#aaa;">Pipe Load (during sim):</div>
    <div class="legend-item"><div style="width:20px;height:3px;background:#2ecc71;border-radius:2px;margin-right:6px;"></div> &lt;50%</div>
    <div class="legend-item"><div style="width:20px;height:4px;background:#f1c40f;border-radius:2px;margin-right:6px;"></div> 50-80%</div>
    <div class="legend-item"><div style="width:20px;height:5px;background:#e74c3c;border-radius:2px;margin-right:6px;"></div> &gt;80%</div>
  </div>
  <div id="timeline-bar" onclick="seekTimeline(event)">
    <div class="tl-fill" id="tl-fill"></div>
    <div class="tl-playhead" id="tl-playhead" style="left:0"></div>
    <div class="tl-markers">
      <span class="tl-mark">0:00</span>
      <span class="tl-mark">0:30</span>
      <span class="tl-mark">1:00</span>
      <span class="tl-mark">1:30</span>
      <span class="tl-mark">2:00</span>
      <span class="tl-mark">2:30</span>
      <span class="tl-mark">3:00</span>
    </div>
  </div>
  <div id="scada-panel">
    <div class="scada-header">
      <span class="scada-title">&#x25a3; HYDRODOME SCADA -- SYSTEM MONITOR</span>
      <span class="scada-close" onclick="toggleSCADA()">&#x2715;</span>
    </div>
    <div id="scada-content" class="scada-grid"></div>
  </div>
</div>

<script>
// ===================== MAP SETUP =====================
const FSJ_CENTER = [54.4378, -124.2565];
const map = L.map('map', { zoomControl: true }).setView(FSJ_CENTER, 14);

const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '¬© OpenStreetMap', maxZoom: 19
});
const satLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
  attribution: '¬© Esri', maxZoom: 19
});
const topoLayer = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
  attribution: '¬© OpenTopoMap', maxZoom: 17
});
satLayer.addTo(map);
L.control.layers({ 'Satellite': satLayer, 'Street': osmLayer, 'Topo': topoLayer }, {}, { position:'topleft' }).addTo(map);


// ===================== DATA: WATER NETWORK (Fort St. James - Road Grid) =====================
// Major roads: 8", Minor roads: 6"
const waterMains = [
  // === REAL OSM ROAD NETWORK - 409 ACTUAL FORT ST. JAMES STREETS ===

  { id:'OSM-1', pts:[[54.451829,-124.262953],[54.452169,-124.262906],[54.452615,-124.262845]], diam:0.15, label:'7th Avenue West (6")' },
  { id:'OSM-2', pts:[[54.440403,-124.247556],[54.441402,-124.247544]], diam:0.15, label:'3rd Avenue East (6")' },
  { id:'OSM-3', pts:[[54.444628,-124.251499],[54.445453,-124.25257]], diam:0.15, label:'Dease Avenue (6")' },
  { id:'OSM-4', pts:[[54.446215,-124.250944],[54.446311,-124.250943]], diam:0.2, label:'Douglas Avenue (8")' },
  { id:'OSM-5', pts:[[54.443315,-124.254411],[54.443377,-124.254274],[54.443656,-124.253659],[54.443984,-124.252938]], diam:0.15, label:'Ogden Street (6")' },
  { id:'OSM-6', pts:[[54.438918,-124.245801],[54.439794,-124.245803]], diam:0.15, label:'4th Avenue East (6")' },
  { id:'OSM-7', pts:[[54.434798,-124.245672],[54.435422,-124.245993],[54.435849,-124.246465],[54.4362,-124.247221]], diam:0.15, label:'Mountainview Road (6")' },
  { id:'OSM-8', pts:[[54.437807,-124.25191],[54.437809,-124.252272]], diam:0.15, label:'Middle Road (6")' },
  { id:'OSM-9', pts:[[54.433997,-124.253581],[54.434344,-124.254805]], diam:0.15, label:'Greenview Drive (6")' },
  { id:'OSM-10', pts:[[54.448858,-124.256612],[54.448863,-124.260094],[54.448902,-124.260285],[54.448949,-124.26039]], diam:0.15, label:'Dogwood Street West (6")' },
  { id:'OSM-11', pts:[[54.449195,-124.26425],[54.450844,-124.267604],[54.451013,-124.267946],[54.451219,-124.268498],[54.452196,-124.27111],[54.452205,-124.271166],[54.452235,-124.271343],[54.452289,-124.271666],[54.452484,-124.273761],[54.452638,-124.274473],[54.452711,-124.275058],[54.452712,-124.276225],[54.452751,-124.276445],[54.452846,-124.276738],[54.453317,-124.277562],[54.453982,-124.278891],[54.454456,-124.27969],[54.454727,-124.280451],[54.454986,-124.281179]], diam:0.15, label:'Lakeshore Drive (6")' },
  { id:'OSM-12', pts:[[54.439774,-124.244414],[54.439794,-124.245803]], diam:0.15, label:'Junkers Street (6")' },
  { id:'OSM-13', pts:[[54.441951,-124.242935],[54.442102,-124.243168],[54.442265,-124.243576]], diam:0.2, label:'Stuart Drive East (8")' },
  { id:'OSM-14', pts:[[54.435441,-124.252359],[54.435524,-124.252289],[54.436313,-124.251619]], diam:0.15, label:'Sampson Road (6")' },
  { id:'OSM-15', pts:[[54.448851,-124.252451],[54.449316,-124.252447],[54.449766,-124.252443]], diam:0.15, label:'2nd Avenue West (6")' },
  { id:'OSM-16', pts:[[54.446312,-124.252479],[54.446315,-124.256666]], diam:0.2, label:'Ash Street West (8")' },
  { id:'OSM-17', pts:[[54.446312,-124.252479],[54.446915,-124.252472]], diam:0.15, label:'2nd Avenue West (6")' },
  { id:'OSM-18', pts:[[54.446311,-124.250943],[54.4476,-124.250932]], diam:0.2, label:'Douglas Avenue (8")' },
  { id:'OSM-19', pts:[[54.44742,-124.262173],[54.449784,-124.262162]], diam:0.15, label:'7th Avenue West (6")' },
  { id:'OSM-20', pts:[[54.438918,-124.245801],[54.438919,-124.247573]], diam:0.15, label:'Kwah Road East (6")' },
  { id:'OSM-21', pts:[[54.439715,-124.252249],[54.439882,-124.252242],[54.440278,-124.252223],[54.440692,-124.252205],[54.441321,-124.252224],[54.441527,-124.252215],[54.441743,-124.252237],[54.441968,-124.252229],[54.442098,-124.252233],[54.442174,-124.252235],[54.442383,-124.252226],[54.442482,-124.252229],[54.442518,-124.25223]], diam:0.15, label:'Road 43004625 (6")' },
  { id:'OSM-22', pts:[[54.458834,-124.2472],[54.458829,-124.248247],[54.458825,-124.2491],[54.458866,-124.249469],[54.458891,-124.249531],[54.458927,-124.249621],[54.458985,-124.249766],[54.459131,-124.249968],[54.459246,-124.250005]], diam:0.15, label:'Hoy Sub Road (6")' },
  { id:'OSM-23', pts:[[54.457783,-124.264351],[54.457998,-124.264025],[54.45826,-124.263448],[54.458307,-124.263343],[54.458327,-124.263289]], diam:0.15, label:'Road 43004627 (6")' },
  { id:'OSM-24', pts:[[54.441127,-124.24212],[54.441266,-124.24222],[54.441388,-124.242307]], diam:0.15, label:'Stuart Drive East (6")' },
  { id:'OSM-25', pts:[[54.440403,-124.247556],[54.440415,-124.245799]], diam:0.15, label:'Murray Street East (6")' },
  { id:'OSM-26', pts:[[54.438919,-124.244427],[54.439774,-124.244414]], diam:0.15, label:'5th Avenue East (6")' },
  { id:'OSM-27', pts:[[54.437419,-124.246274],[54.438262,-124.245954]], diam:0.15, label:'Sunset Court (6")' },
  { id:'OSM-28', pts:[[54.452406,-124.258201],[54.452526,-124.260862],[54.452615,-124.262845]], diam:0.15, label:'Heathmont Road (6")' },
  { id:'OSM-29', pts:[[54.44774,-124.249477],[54.448377,-124.248337]], diam:0.15, label:'Murray Subdivision Street (6")' },
  { id:'OSM-30', pts:[[54.439999,-124.25349],[54.440163,-124.254121],[54.440326,-124.254747],[54.44046,-124.255072]], diam:0.15, label:'Bay Lane (6")' },
  { id:'OSM-31', pts:[[54.444003,-124.257942],[54.444113,-124.257707],[54.444182,-124.257558],[54.444442,-124.256997],[54.444727,-124.256384]], diam:0.15, label:'Manson Street (6")' },
  { id:'OSM-32', pts:[[54.456995,-124.262943],[54.457298,-124.264082],[54.457439,-124.264899],[54.457517,-124.265936],[54.45754,-124.276198],[54.45754,-124.27626],[54.457545,-124.278327],[54.457551,-124.281161]], diam:0.15, label:'Stones Bay Road (6")' },
  { id:'OSM-33', pts:[[54.441374,-124.24943],[54.441402,-124.247544]], diam:0.15, label:'Alexander Street (6")' },
  { id:'OSM-34', pts:[[54.449766,-124.252443],[54.449773,-124.256612]], diam:0.2, label:'Elm Street West (8")' },
  { id:'OSM-35', pts:[[54.440415,-124.245799],[54.442501,-124.2458]], diam:0.15, label:'4th Avenue East (6")' },
  { id:'OSM-36', pts:[[54.449778,-124.250958],[54.449832,-124.250957]], diam:0.15, label:'Road 43004718 (6")' },
  { id:'OSM-37', pts:[[54.4362,-124.247221],[54.436617,-124.246816]], diam:0.15, label:'Cougar Court (6")' },
  { id:'OSM-38', pts:[[54.451656,-124.259337],[54.451829,-124.262953]], diam:0.15, label:'Grove Street (6")' },
  { id:'OSM-39', pts:[[54.429249,-124.25283],[54.430879,-124.252003],[54.430963,-124.251907],[54.431005,-124.251747],[54.431009,-124.251511],[54.430345,-124.247975],[54.430262,-124.247536],[54.430094,-124.246457],[54.430096,-124.246364],[54.430098,-124.246245],[54.430158,-124.246072],[54.430274,-124.245918]], diam:0.15, label:'Road 43004731 (6")' },
  { id:'OSM-40', pts:[[54.439774,-124.244414],[54.440422,-124.244403]], diam:0.15, label:'5th Avenue East (6")' },
  { id:'OSM-41', pts:[[54.445378,-124.254833],[54.44542,-124.25457],[54.445435,-124.253693],[54.445453,-124.25257]], diam:0.15, label:'Connolly Street West (6")' },
  { id:'OSM-42', pts:[[54.445378,-124.254833],[54.445428,-124.254874],[54.445497,-124.25556]], diam:0.15, label:'Connolly Street West (6")' },
  { id:'OSM-43', pts:[[54.442515,-124.250974],[54.442518,-124.252009],[54.442518,-124.25223],[54.442522,-124.25348],[54.442523,-124.253772],[54.442528,-124.255666],[54.44262,-124.255996],[54.442801,-124.256296],[54.443284,-124.256956],[54.444003,-124.257942],[54.444056,-124.258014],[54.444482,-124.258592],[54.44482,-124.259051],[54.445113,-124.25945],[54.445143,-124.259508],[54.445343,-124.259896],[54.445561,-124.260349]], diam:0.2, label:'Stuart Drive West (8")' },
  { id:'OSM-44', pts:[[54.444727,-124.256384],[54.445045,-124.256834]], diam:0.15, label:'Morice Avenue (6")' },
  { id:'OSM-45', pts:[[54.446878,-124.256654],[54.446892,-124.252961],[54.446915,-124.252472]], diam:0.15, label:'Road 43004784 (6")' },
  { id:'OSM-46', pts:[[54.450205,-124.24946],[54.450712,-124.249557],[54.450975,-124.249732],[54.451179,-124.250032],[54.451292,-124.250318],[54.451303,-124.250561],[54.451304,-124.25096]], diam:0.15, label:'Road 43004852 (6")' },
  { id:'OSM-47', pts:[[54.441402,-124.247544],[54.442506,-124.247531]], diam:0.15, label:'3rd Avenue East (6")' },
  { id:'OSM-48', pts:[[54.4476,-124.250932],[54.448192,-124.250939],[54.449752,-124.250958],[54.449778,-124.250958]], diam:0.2, label:'Douglas Avenue (8")' },
  { id:'OSM-49', pts:[[54.446315,-124.256666],[54.446317,-124.258623],[54.446318,-124.259161],[54.4462,-124.259913],[54.445951,-124.260766],[54.445858,-124.261025]], diam:0.2, label:'Ash Street West (8")' },
  { id:'OSM-50', pts:[[54.442756,-124.250948],[54.442863,-124.251416],[54.443236,-124.251921],[54.443984,-124.252938]], diam:0.15, label:'Simon Fraser Avenue South (6")' },
  { id:'OSM-51', pts:[[54.441388,-124.242307],[54.441835,-124.242759],[54.441951,-124.242935]], diam:0.2, label:'Stuart Drive East (8")' },
  { id:'OSM-52', pts:[[54.440742,-124.24184],[54.441127,-124.24212]], diam:0.15, label:'Hospital Hill Road (6")' },
  { id:'OSM-53', pts:[[54.459658,-124.247193],[54.46024,-124.247261]], diam:0.15, label:'Road 43004926 (6")' },
  { id:'OSM-54', pts:[[54.442501,-124.2458],[54.442506,-124.247531]], diam:0.2, label:'Stuart Drive East (8")' },
  { id:'OSM-55', pts:[[54.442554,-124.256323],[54.442602,-124.256084],[54.44262,-124.255996]], diam:0.15, label:'Stuart Drive West (6")' },
  { id:'OSM-56', pts:[[54.436603,-124.248698],[54.436684,-124.248994],[54.436736,-124.249185],[54.436857,-124.249627],[54.436902,-124.249793],[54.436974,-124.250053],[54.437104,-124.250532]], diam:0.15, label:'Mountainview Road (6")' },
  { id:'OSM-57', pts:[[54.449781,-124.260465],[54.449782,-124.261212]], diam:0.2, label:'Elm Street West (8")' },
  { id:'OSM-58', pts:[[54.446815,-124.262178],[54.44742,-124.262173]], diam:0.15, label:'7th Avenue West (6")' },
  { id:'OSM-59', pts:[[54.446915,-124.252472],[54.44742,-124.252466]], diam:0.15, label:'2nd Avenue West (6")' },
  { id:'OSM-60', pts:[[54.448418,-124.252469],[54.448851,-124.252451]], diam:0.15, label:'2nd Avenue West (6")' },
  { id:'OSM-61', pts:[[54.437809,-124.252272],[54.43869,-124.251536]], diam:0.15, label:'Carrier Road (6")' },
  { id:'OSM-62', pts:[[54.429756,-124.256522],[54.429939,-124.256426],[54.430075,-124.256354],[54.430209,-124.256283],[54.430305,-124.256232],[54.430456,-124.256152],[54.430546,-124.256104],[54.430811,-124.255964],[54.430894,-124.25592],[54.430943,-124.255894]], diam:0.15, label:'Knots Landing (6")' },
  { id:'OSM-63', pts:[[54.44072,-124.249432],[54.441374,-124.24943]], diam:0.15, label:'2nd Avenue East (6")' },
  { id:'OSM-64', pts:[[54.448949,-124.26039],[54.449132,-124.260483],[54.449336,-124.260477],[54.449781,-124.260465]], diam:0.15, label:'6th Avenue West (6")' },
  { id:'OSM-65', pts:[[54.44742,-124.261252],[54.447977,-124.261249],[54.448354,-124.26123],[54.44839,-124.261231],[54.448561,-124.261206],[54.448687,-124.26121],[54.448876,-124.261231],[54.449028,-124.261235],[54.449226,-124.261226],[54.449433,-124.261217],[54.449586,-124.261206],[54.449782,-124.261212]], diam:0.15, label:'Road 43005067 (6")' },
  { id:'OSM-66', pts:[[54.462608,-124.24933],[54.462779,-124.248299],[54.46283,-124.247992],[54.462962,-124.247193],[54.463035,-124.246753],[54.463127,-124.246192],[54.463205,-124.245722]], diam:0.15, label:'Robin Road (6")' },
  { id:'OSM-67', pts:[[54.458834,-124.2472],[54.459658,-124.247193]], diam:0.15, label:'Road 43005082 (6")' },
  { id:'OSM-68', pts:[[54.444452,-124.250904],[54.444455,-124.251132],[54.444456,-124.251233],[54.444628,-124.251499]], diam:0.15, label:'Dease Avenue (6")' },
  { id:'OSM-69', pts:[[54.428877,-124.25938],[54.42899,-124.259786],[54.429018,-124.259887],[54.429035,-124.259905],[54.429198,-124.26007],[54.429455,-124.26018],[54.429802,-124.260329],[54.429996,-124.260412],[54.430118,-124.260464],[54.430198,-124.260499],[54.430309,-124.260505],[54.430385,-124.260472],[54.430442,-124.260447],[54.430567,-124.260336],[54.430603,-124.260304],[54.430753,-124.2601],[54.430869,-124.259943],[54.431024,-124.259733],[54.431399,-124.259224],[54.43161,-124.258938],[54.431647,-124.258888],[54.431772,-124.258719],[54.431797,-124.258684],[54.431968,-124.258525],[54.432224,-124.258288],[54.432478,-124.258203],[54.433156,-124.25835],[54.43345,-124.258413],[54.433688,-124.258465],[54.433968,-124.258526],[54.434107,-124.258555],[54.434225,-124.258538],[54.434404,-124.258512],[54.434654,-124.258379],[54.435125,-124.258127],[54.43515,-124.258114]], diam:0.15, label:'Lower Road (6")' },
  { id:'OSM-70', pts:[[54.46053,-124.248663],[54.460792,-124.248632],[54.461029,-124.24865],[54.461316,-124.24875]], diam:0.15, label:'Mowbay Road (6")' },
  { id:'OSM-71', pts:[[54.434436,-124.255094],[54.434536,-124.255518],[54.434761,-124.25648]], diam:0.15, label:'Hill Drive (6")' },
  { id:'OSM-72', pts:[[54.441388,-124.242307],[54.441518,-124.241985],[54.441655,-124.241855],[54.442268,-124.241626],[54.442333,-124.241602],[54.442594,-124.241629],[54.44395,-124.242007]], diam:0.15, label:'Pineridge Way (6")' },
  { id:'OSM-73', pts:[[54.457433,-124.262545],[54.457543,-124.262978],[54.45758,-124.263192],[54.457783,-124.264351]], diam:0.15, label:'Road 43005153 (6")' },
  { id:'OSM-74', pts:[[54.434761,-124.25648],[54.435313,-124.256175],[54.435724,-124.255948],[54.435825,-124.255892],[54.436008,-124.255791],[54.436197,-124.255687],[54.436278,-124.255642],[54.436545,-124.255495],[54.436719,-124.255399],[54.436916,-124.25529],[54.437119,-124.255178],[54.43743,-124.255006],[54.437696,-124.25486],[54.43772,-124.254847],[54.437798,-124.254738],[54.437806,-124.254702],[54.437826,-124.254613],[54.437821,-124.253904],[54.437818,-124.253585],[54.437814,-124.253043],[54.437809,-124.252272]], diam:0.15, label:'Middle Road (6")' },
  { id:'OSM-75', pts:[[54.457433,-124.262545],[54.458255,-124.261786],[54.458587,-124.261406],[54.458891,-124.260926],[54.458998,-124.260712],[54.459128,-124.260455],[54.459358,-124.259873],[54.459571,-124.259078],[54.460034,-124.256339],[54.461316,-124.24875],[54.461441,-124.247951],[54.461452,-124.247878],[54.461528,-124.247393],[54.461677,-124.246446],[54.46173,-124.246108],[54.461733,-124.246088],[54.461863,-124.245555],[54.461987,-124.245216],[54.462043,-124.245064],[54.462275,-124.244615],[54.462625,-124.243941],[54.462675,-124.243807],[54.462802,-124.243465],[54.462945,-124.242844],[54.462953,-124.242809],[54.46309,-124.241582],[54.463128,-124.241244],[54.463286,-124.239832],[54.463388,-124.238923]], diam:0.2, label:'Germansen Landing Road (8")' },
  { id:'OSM-76', pts:[[54.43519,-124.251604],[54.435217,-124.251686],[54.435273,-124.251853],[54.435441,-124.252359]], diam:0.15, label:'Rainbow Court (6")' },
  { id:'OSM-77', pts:[[54.459246,-124.250005],[54.459354,-124.249939],[54.459819,-124.249186],[54.460037,-124.248927],[54.460261,-124.248763],[54.46053,-124.248663]], diam:0.15, label:'Mowbay Road (6")' },
  { id:'OSM-78', pts:[[54.461316,-124.24875],[54.462251,-124.249169],[54.462608,-124.24933]], diam:0.15, label:'Osprey Road (6")' },
  { id:'OSM-79', pts:[[54.439999,-124.25349],[54.440585,-124.253487],[54.441185,-124.253485],[54.441586,-124.253483],[54.441628,-124.253483],[54.442093,-124.253481],[54.442372,-124.25348],[54.442478,-124.253479],[54.442522,-124.25348]], diam:0.15, label:'2nd Avenue West (6")' },
  { id:'OSM-80', pts:[[54.44742,-124.261252],[54.44742,-124.262173]], diam:0.15, label:'Birch Street West (6")' },
  { id:'OSM-81', pts:[[54.433997,-124.253581],[54.434006,-124.253579],[54.434149,-124.253458],[54.434445,-124.253206],[54.434626,-124.253052],[54.434666,-124.253018],[54.434897,-124.252822],[54.435136,-124.252619],[54.435262,-124.252511],[54.435294,-124.252484],[54.435441,-124.252359]], diam:0.15, label:'Sampson Road (6")' },
  { id:'OSM-82', pts:[[54.446315,-124.256666],[54.446878,-124.256654]], diam:0.15, label:'4th Avenue West (6")' },
  { id:'OSM-83', pts:[[54.437716,-124.247794],[54.438144,-124.247636],[54.438269,-124.24759],[54.438919,-124.247573]], diam:0.15, label:'Greenview Drive (6")' },
  { id:'OSM-84', pts:[[54.448417,-124.256615],[54.448409,-124.25362],[54.448418,-124.252469]], diam:0.15, label:'Road 43005312 (6")' },
  { id:'OSM-85', pts:[[54.442756,-124.250948],[54.443357,-124.250932],[54.443786,-124.250921],[54.444299,-124.250908],[54.444452,-124.250904]], diam:0.2, label:'Douglas Avenue (8")' },
  { id:'OSM-86', pts:[[54.449785,-124.263229],[54.449789,-124.264194]], diam:0.2, label:'Elm Street West (8")' },
  { id:'OSM-87', pts:[[54.447421,-124.263067],[54.44742,-124.264272]], diam:0.15, label:'Birch Street West (6")' },
  { id:'OSM-88', pts:[[54.441824,-124.256373],[54.442554,-124.256323]], diam:0.15, label:'Fort Avenue (6")' },
  { id:'OSM-89', pts:[[54.439794,-124.245803],[54.440415,-124.245799]], diam:0.15, label:'4th Avenue East (6")' },
  { id:'OSM-90', pts:[[54.437013,-124.246504],[54.437419,-124.246274]], diam:0.15, label:'Sunset Court (6")' },
  { id:'OSM-91', pts:[[54.457783,-124.264351],[54.457866,-124.265128],[54.457948,-124.266596],[54.457915,-124.269106],[54.458024,-124.270586],[54.458026,-124.270923],[54.458034,-124.27211],[54.458037,-124.272621],[54.458039,-124.272897],[54.457995,-124.274202],[54.457918,-124.275218],[54.457901,-124.275762],[54.457885,-124.276302],[54.457806,-124.278877],[54.457798,-124.279125],[54.457802,-124.280542],[54.457806,-124.2821],[54.457807,-124.28264],[54.457811,-124.284136],[54.457818,-124.286836],[54.45782,-124.28753],[54.457829,-124.291082]], diam:0.15, label:'Road 43005382 (6")' },
  { id:'OSM-92', pts:[[54.449766,-124.252443],[54.449772,-124.251731],[54.449778,-124.250958]], diam:0.2, label:'Elm Street West (8")' },
  { id:'OSM-93', pts:[[54.442515,-124.250974],[54.442527,-124.250973],[54.442756,-124.250948]], diam:0.2, label:'Douglas Avenue (8")' },
  { id:'OSM-94', pts:[[54.446878,-124.256654],[54.44742,-124.256642]], diam:0.15, label:'4th Avenue West (6")' },
  { id:'OSM-95', pts:[[54.443315,-124.254411],[54.444727,-124.256384]], diam:0.15, label:'Morice Avenue (6")' },
  { id:'OSM-96', pts:[[54.44742,-124.256642],[54.44742,-124.261252]], diam:0.15, label:'Birch Street West (6")' },
  { id:'OSM-97', pts:[[54.437419,-124.246274],[54.437716,-124.247794]], diam:0.15, label:'Sunset Court (6")' },
  { id:'OSM-98', pts:[[54.451098,-124.26305],[54.451829,-124.262953]], diam:0.15, label:'7th Avenue West (6")' },
  { id:'OSM-99', pts:[[54.44742,-124.252466],[54.44742,-124.256642]], diam:0.15, label:'Birch Street West (6")' },
  { id:'OSM-100', pts:[[54.46024,-124.247261],[54.460422,-124.247697],[54.460434,-124.247745],[54.460502,-124.248038],[54.46053,-124.248663]], diam:0.15, label:'Road 43005454 (6")' },
  { id:'OSM-101', pts:[[54.438917,-124.249431],[54.44072,-124.249432]], diam:0.15, label:'2nd Avenue East (6")' },
  { id:'OSM-102', pts:[[54.4362,-124.247221],[54.436603,-124.248698]], diam:0.15, label:'Mountainview Road (6")' },
  { id:'OSM-103', pts:[[54.442265,-124.243576],[54.442319,-124.243705],[54.442447,-124.244294],[54.442462,-124.244364],[54.4425,-124.244934],[54.442501,-124.2458]], diam:0.2, label:'Stuart Drive East (8")' },
  { id:'OSM-104', pts:[[54.452615,-124.262845],[54.452661,-124.26381]], diam:0.15, label:'Heathmont Road (6")' },
  { id:'OSM-105', pts:[[54.433962,-124.255489],[54.434436,-124.255094]], diam:0.15, label:'Carrier Road (6")' },
  { id:'OSM-106', pts:[[54.448851,-124.252451],[54.448858,-124.256612]], diam:0.15, label:'Dogwood Street West (6")' },
  { id:'OSM-107', pts:[[54.448177,-124.252469],[54.448418,-124.252469]], diam:0.15, label:'2nd Avenue West (6")' },
  { id:'OSM-108', pts:[[54.451098,-124.26305],[54.450903,-124.260077],[54.450911,-124.259543],[54.450973,-124.25944],[54.451057,-124.259382],[54.451656,-124.259337]], diam:0.15, label:'Fir Street (6")' },
  { id:'OSM-109', pts:[[54.451638,-124.258951],[54.451656,-124.259337]], diam:0.15, label:'Grove Street (6")' },
  { id:'OSM-110', pts:[[54.432055,-124.256741],[54.432086,-124.256835],[54.432143,-124.257011],[54.432237,-124.256932],[54.433002,-124.256292],[54.43336,-124.255993],[54.433378,-124.255977],[54.433962,-124.255489]], diam:0.15, label:'Carrier Road (6")' },
  { id:'OSM-111', pts:[[54.447421,-124.263067],[54.449386,-124.263107],[54.449617,-124.263074],[54.449785,-124.26305]], diam:0.15, label:'Road 43005572 (6")' },
  { id:'OSM-112', pts:[[54.449785,-124.26305],[54.449785,-124.263229]], diam:0.2, label:'Elm Street West (8")' },
  { id:'OSM-113', pts:[[54.4476,-124.250932],[54.447609,-124.249814],[54.44774,-124.249477]], diam:0.15, label:'Murray Subdivision Street (6")' },
  { id:'OSM-114', pts:[[54.446215,-124.250944],[54.446218,-124.250277],[54.446224,-124.248919],[54.446242,-124.24872],[54.446297,-124.248509],[54.446393,-124.248304],[54.446681,-124.247824],[54.446759,-124.2476],[54.446799,-124.247374],[54.44681,-124.246443],[54.446969,-124.245879]], diam:0.15, label:'Ash Street East (6")' },
  { id:'OSM-115', pts:[[54.438919,-124.247573],[54.440403,-124.247556]], diam:0.15, label:'3rd Avenue East (6")' },
  { id:'OSM-116', pts:[[54.438924,-124.251058],[54.439045,-124.251023],[54.439163,-124.251007],[54.439426,-124.251003],[54.439887,-124.250998],[54.439964,-124.250997],[54.440312,-124.250993],[54.440736,-124.250988],[54.441419,-124.250983],[54.441941,-124.250978],[54.442515,-124.250974]], diam:0.25, label:'Douglas Avenue (10")' },
  { id:'OSM-117', pts:[[54.444452,-124.250904],[54.445459,-124.250915]], diam:0.2, label:'Douglas Avenue (8")' },
  { id:'OSM-118', pts:[[54.449785,-124.263229],[54.451098,-124.26305]], diam:0.15, label:'7th Avenue West (6")' },
  { id:'OSM-119', pts:[[54.449784,-124.262162],[54.449785,-124.26305]], diam:0.2, label:'Elm Street West (8")' },
  { id:'OSM-120', pts:[[54.44742,-124.256642],[54.448417,-124.256615]], diam:0.15, label:'4th Avenue West (6")' },
  { id:'OSM-121', pts:[[54.438917,-124.249431],[54.438917,-124.249729],[54.438924,-124.251058]], diam:0.15, label:'Kwah Road East (6")' },
  { id:'OSM-122', pts:[[54.442506,-124.247531],[54.442509,-124.249298],[54.442515,-124.250974]], diam:0.2, label:'Stuart Drive East (8")' },
  { id:'OSM-123', pts:[[54.434761,-124.25648],[54.434814,-124.256704],[54.43515,-124.258114]], diam:0.15, label:'Hill Drive (6")' },
  { id:'OSM-124', pts:[[54.448179,-124.251743],[54.448177,-124.252469]], diam:0.15, label:'Cedar Street West (6")' },
  { id:'OSM-125', pts:[[54.449782,-124.261212],[54.449784,-124.262162]], diam:0.2, label:'Elm Street West (8")' },
  { id:'OSM-126', pts:[[54.437104,-124.250532],[54.437123,-124.250601],[54.437212,-124.250925],[54.437329,-124.251354],[54.437395,-124.251592],[54.437542,-124.25213]], diam:0.15, label:'Mountainview Road (6")' },
  { id:'OSM-127', pts:[[54.436313,-124.251619],[54.436604,-124.251371],[54.436678,-124.251308],[54.436707,-124.251283],[54.436887,-124.251022],[54.43705,-124.250654],[54.437104,-124.250532]], diam:0.15, label:'Sampson Road (6")' },
  { id:'OSM-128', pts:[[54.443984,-124.252938],[54.444309,-124.252212],[54.444628,-124.251499]], diam:0.15, label:'Ogden Street (6")' },
  { id:'OSM-129', pts:[[54.44072,-124.249432],[54.440736,-124.250988]], diam:0.15, label:'Portage Street East (6")' },
  { id:'OSM-130', pts:[[54.44774,-124.249477],[54.449096,-124.249468],[54.449726,-124.249463],[54.450205,-124.24946]], diam:0.15, label:'Murray Subdivision Street (6")' },
  { id:'OSM-131', pts:[[54.44625,-124.264055],[54.446153,-124.264465],[54.446268,-124.265616],[54.446362,-124.265755]], diam:0.15, label:'Ash Street West (6")' },
  { id:'OSM-132', pts:[[54.436217,-124.250723],[54.436162,-124.250661],[54.436057,-124.250797],[54.43617,-124.251159],[54.436313,-124.251619]], diam:0.15, label:'Osprey Court (6")' },
  { id:'OSM-133', pts:[[54.439426,-124.251003],[54.439715,-124.252249]], diam:0.15, label:'Bay Lane (6")' },
  { id:'OSM-134', pts:[[54.443984,-124.252938],[54.445378,-124.254833]], diam:0.15, label:'Simon Fraser Avenue South (6")' },
  { id:'OSM-135', pts:[[54.448858,-124.256612],[54.449327,-124.256611],[54.449773,-124.256612],[54.450197,-124.256612]], diam:0.15, label:'4th Avenue West (6")' },
  { id:'OSM-136', pts:[[54.445561,-124.260349],[54.445789,-124.260856]], diam:0.2, label:'Stuart Drive West (8")' },
  { id:'OSM-137', pts:[[54.44742,-124.262173],[54.447421,-124.263067]], diam:0.15, label:'Birch Street West (6")' },
  { id:'OSM-138', pts:[[54.438918,-124.245801],[54.438919,-124.244427]], diam:0.15, label:'Kwah Road East (6")' },
  { id:'OSM-139', pts:[[54.445459,-124.250915],[54.445917,-124.250955]], diam:0.2, label:'Douglas Avenue (8")' },
  { id:'OSM-140', pts:[[54.440922,-124.243791],[54.442082,-124.243723],[54.442265,-124.243576]], diam:0.15, label:'Eagle Court (6")' },
  { id:'OSM-141', pts:[[54.438917,-124.249431],[54.438918,-124.248027],[54.438919,-124.247573]], diam:0.15, label:'Kwah Road East (6")' },
  { id:'OSM-142', pts:[[54.446311,-124.250943],[54.446312,-124.251722],[54.446312,-124.252479]], diam:0.2, label:'Ash Street West (8")' },
  { id:'OSM-143', pts:[[54.449832,-124.250957],[54.449861,-124.250661]], diam:0.15, label:'Road 43006078 (6")' },
  { id:'OSM-144', pts:[[54.429978,-124.257587],[54.430062,-124.257877]], diam:0.15, label:'Necoslie Road (6")' },
  { id:'OSM-145', pts:[[54.434436,-124.255094],[54.434742,-124.254839],[54.435744,-124.254],[54.435876,-124.253889],[54.436232,-124.253592],[54.436416,-124.253438],[54.436791,-124.253124],[54.436806,-124.253111],[54.437809,-124.252272]], diam:0.15, label:'Carrier Road (6")' },
  { id:'OSM-146', pts:[[54.441319,-124.243018],[54.441828,-124.243092],[54.441951,-124.242935]], diam:0.15, label:'Falcon Court (6")' },
  { id:'OSM-147', pts:[[54.444727,-124.256384],[54.445082,-124.255607],[54.445219,-124.255308],[54.445378,-124.254833]], diam:0.15, label:'Manson Street (6")' },
  { id:'OSM-148', pts:[[54.445789,-124.260856],[54.445858,-124.261025],[54.445928,-124.26128],[54.44598,-124.261846],[54.446075,-124.263441],[54.446117,-124.263689],[54.446172,-124.263886],[54.44625,-124.264055],[54.446359,-124.264188],[54.446495,-124.264265],[54.44677,-124.264273],[54.44742,-124.264272],[54.449195,-124.26425],[54.449789,-124.264194],[54.451195,-124.264006],[54.452661,-124.26381],[54.45619,-124.263332],[54.456625,-124.263209],[54.456995,-124.262943],[54.457397,-124.262578],[54.457433,-124.262545]], diam:0.2, label:'Stuart Drive West (8")' },
  { id:'OSM-149', pts:[[54.448417,-124.256615],[54.448858,-124.256612]], diam:0.15, label:'4th Avenue West (6")' },
  { id:'OSM-150', pts:[[54.445453,-124.25257],[54.445459,-124.250915]], diam:0.15, label:'Connolly Street West (6")' },
  { id:'OSM-151', pts:[[54.44742,-124.252466],[54.448177,-124.252469]], diam:0.15, label:'2nd Avenue West (6")' },
  { id:'OSM-152', pts:[[54.43515,-124.258114],[54.435446,-124.257957],[54.436112,-124.257602],[54.436177,-124.257567],[54.436385,-124.257457],[54.436662,-124.257309],[54.436811,-124.25723],[54.437208,-124.257019],[54.437339,-124.256949],[54.437729,-124.256741],[54.438245,-124.256465],[54.438301,-124.256435],[54.438491,-124.256334],[54.438616,-124.256267],[54.43866,-124.256243],[54.438916,-124.256106]], diam:0.15, label:'Lower Road (6")' },
  { id:'OSM-153', pts:[[54.449773,-124.256612],[54.449776,-124.258189],[54.449778,-124.258821],[54.449781,-124.260465]], diam:0.2, label:'Elm Street West (8")' },
  { id:'OSM-154', pts:[[54.436603,-124.248698],[54.437167,-124.248189],[54.437246,-124.248119],[54.437363,-124.248037],[54.437594,-124.247878],[54.437716,-124.247794]], diam:0.15, label:'Greenview Drive (6")' },
  { id:'OSM-155', pts:[[54.438917,-124.253492],[54.439416,-124.253491],[54.439999,-124.25349]], diam:0.15, label:'2nd Avenue West (6")' },
  { id:'OSM-156', pts:[[54.458834,-124.2472],[54.458837,-124.246665],[54.458848,-124.244737],[54.458858,-124.24298],[54.458862,-124.242238],[54.458871,-124.240609],[54.458887,-124.237889],[54.458893,-124.23673],[54.458896,-124.236185]], diam:0.15, label:'Hoy Sub Road (6")' },
  { id:'OSM-157', pts:[[54.459658,-124.247193],[54.459702,-124.246863],[54.459689,-124.246661],[54.459633,-124.246369],[54.459634,-124.246353],[54.459648,-124.246191],[54.459715,-124.246022],[54.459797,-124.245972],[54.460079,-124.246025],[54.460207,-124.246141],[54.460318,-124.246379],[54.460364,-124.246655],[54.460356,-124.246918],[54.46024,-124.247261]], diam:0.15, label:'Road 43006284 (6")' },
  { id:'OSM-158', pts:[[54.439715,-124.252249],[54.439999,-124.25349]], diam:0.15, label:'Bay Lane (6")' },
  { id:'OSM-159', pts:[[54.433997,-124.253581],[54.433902,-124.253244],[54.433859,-124.252782],[54.433856,-124.252525],[54.433853,-124.252352],[54.433867,-124.252248],[54.43391,-124.251917],[54.433924,-124.251813],[54.433957,-124.25156],[54.433997,-124.251443],[54.43403,-124.251347],[54.434086,-124.251183],[54.434179,-124.250909],[54.434334,-124.250659],[54.43442,-124.250586],[54.434634,-124.2504],[54.434694,-124.250349],[54.434903,-124.250168],[54.435083,-124.250012],[54.43512,-124.249981],[54.435538,-124.249619],[54.435558,-124.249601],[54.435596,-124.249569],[54.435883,-124.249321],[54.436065,-124.249164],[54.436294,-124.248966],[54.436603,-124.248698]], diam:0.15, label:'Greenview Drive (6")' },
  { id:'OSM-160', pts:[[54.433962,-124.255489],[54.434142,-124.256405],[54.434163,-124.256513],[54.434224,-124.25682],[54.434233,-124.256868],[54.434308,-124.257212],[54.43434,-124.257361],[54.43442,-124.257732]], diam:0.15, label:'Church Drive (6")' },
  { id:'OSM-161', pts:[[54.495881,-124.226818],[54.496716,-124.228198],[54.497623,-124.229697],[54.49846,-124.23108],[54.498844,-124.231585],[54.499174,-124.231924],[54.501679,-124.233589],[54.502085,-124.233931],[54.502399,-124.234286],[54.502614,-124.234584],[54.502682,-124.234679],[54.502938,-124.235165],[54.503121,-124.235581],[54.503325,-124.236173],[54.503384,-124.236407],[54.503491,-124.236827],[54.503656,-124.237718],[54.504368,-124.242048],[54.504837,-124.245376],[54.504911,-124.245759],[54.504968,-124.246052],[54.505167,-124.247083],[54.505261,-124.247527],[54.505476,-124.248533],[54.505702,-124.249442],[54.505985,-124.250428],[54.506221,-124.251143],[54.506493,-124.251771],[54.50653,-124.251856],[54.506593,-124.251976],[54.507011,-124.252773],[54.507117,-124.25295],[54.507713,-124.253943],[54.507846,-124.25414],[54.508294,-124.254805],[54.508831,-124.25549],[54.509438,-124.256158],[54.5103,-124.256989],[54.511085,-124.25766],[54.511117,-124.257681],[54.511723,-124.258076],[54.511912,-124.258198],[54.512111,-124.258328],[54.51296,-124.258765],[54.513671,-124.259036],[54.514472,-124.259235],[54.515091,-124.259309],[54.515754,-124.259284],[54.516333,-124.259205],[54.516408,-124.259188],[54.516988,-124.259058],[54.517482,-124.259032],[54.518012,-124.259151],[54.520076,-124.25999],[54.520227,-124.260051],[54.522927,-124.260812],[54.524928,-124.261264],[54.524957,-124.261271],[54.525286,-124.261264],[54.525629,-124.261203],[54.52678,-124.260811],[54.527128,-124.260839],[54.527527,-124.261039],[54.528651,-124.262074],[54.529017,-124.262479],[54.530769,-124.264801],[54.531074,-124.265295],[54.531301,-124.265762],[54.531565,-124.266487],[54.532032,-124.26795],[54.532228,-124.268652],[54.532488,-124.269852],[54.532869,-124.271796],[54.533141,-124.273177],[54.533665,-124.275847],[54.534026,-124.278039],[54.534232,-124.279294],[54.534569,-124.281339],[54.534585,-124.281418],[54.534599,-124.281482],[54.534699,-124.281961],[54.534743,-124.282105],[54.534833,-124.282397],[54.534943,-124.282642],[54.535046,-124.282869],[54.535335,-124.28337],[54.535439,-124.283504],[54.535577,-124.28368],[54.535793,-124.283893],[54.535853,-124.283952],[54.535862,-124.283958],[54.53993,-124.28676],[54.540301,-124.286946],[54.541471,-124.287217],[54.541772,-124.287385],[54.542048,-124.287596],[54.542144,-124.287709],[54.542399,-124.288008],[54.542662,-124.288404],[54.54285,-124.288748],[54.543046,-124.289264],[54.543223,-124.289915],[54.543612,-124.291619],[54.54374,-124.292304],[54.543802,-124.292893],[54.543821,-124.293548],[54.543793,-124.294185],[54.543758,-124.29448],[54.543709,-124.294881],[54.543542,-124.295745],[54.542877,-124.298683],[54.542492,-124.300495],[54.541753,-124.303496],[54.541348,-124.30514],[54.541051,-124.306346],[54.540623,-124.308082],[54.540478,-124.308921],[54.540435,-124.309524],[54.540454,-124.310266],[54.54053,-124.310926],[54.540667,-124.311568],[54.541985,-124.316082],[54.542095,-124.316459],[54.542813,-124.318918],[54.543161,-124.32011],[54.54374,-124.322093],[54.544515,-124.324747],[54.544991,-124.326379],[54.545849,-124.329318],[54.546561,-124.331756],[54.546743,-124.332454],[54.54699,-124.333399],[54.547097,-124.333809],[54.547728,-124.336227],[54.548026,-124.337327],[54.548347,-124.338511],[54.549206,-124.34168],[54.549772,-124.343876],[54.550124,-124.34524],[54.550268,-124.345992],[54.550295,-124.346132],[54.550387,-124.346915],[54.550412,-124.347658],[54.550397,-124.347959],[54.55037,-124.348517],[54.550314,-124.349038],[54.550213,-124.349977],[54.550146,-124.350605],[54.549506,-124.35657],[54.549428,-124.357295],[54.549115,-124.360214],[54.549056,-124.360769],[54.547449,-124.37573],[54.547076,-124.3792],[54.546987,-124.380485],[54.546978,-124.381104],[54.546969,-124.381713],[54.547015,-124.382832],[54.547322,-124.386738],[54.547365,-124.38729],[54.547395,-124.388242],[54.547323,-124.391236],[54.547342,-124.392514],[54.547401,-124.393295],[54.547428,-124.393658],[54.547586,-124.395047],[54.547856,-124.39706],[54.548055,-124.398546]], diam:0.2, label:'Tachie Road (8")' },
  { id:'OSM-162', pts:[[54.433902,-124.255176],[54.433962,-124.255489]], diam:0.15, label:'Church Drive (6")' },
  { id:'OSM-163', pts:[[54.461953,-124.257048],[54.461948,-124.255897],[54.461946,-124.25558],[54.461945,-124.255103],[54.461942,-124.254411],[54.461941,-124.254314],[54.461939,-124.253917],[54.461938,-124.253511],[54.461959,-124.253378],[54.46199,-124.253183],[54.462108,-124.25245],[54.462117,-124.252393],[54.462125,-124.252346],[54.462237,-124.251647],[54.46237,-124.250815],[54.462382,-124.250738],[54.462468,-124.250204],[54.462608,-124.24933]], diam:0.15, label:'Osprey Road (6")' },
  { id:'OSM-164', pts:[[54.438924,-124.251058],[54.43892,-124.252383],[54.438918,-124.253182],[54.438917,-124.253492],[54.438917,-124.253789],[54.438916,-124.254325],[54.438916,-124.254864],[54.438916,-124.254915],[54.438916,-124.25547],[54.438916,-124.255906],[54.438916,-124.256106]], diam:0.15, label:'Kwah Road West (6")' },
  { id:'OSM-165', pts:[[54.427712,-124.259861],[54.428619,-124.259525],[54.428877,-124.25938],[54.429053,-124.259228],[54.429212,-124.259041],[54.429701,-124.258311],[54.429873,-124.258088],[54.430062,-124.257877],[54.430366,-124.257667],[54.4307,-124.257501],[54.430952,-124.257388],[54.431005,-124.257364],[54.431653,-124.257072],[54.432055,-124.256741],[54.43326,-124.255719],[54.433652,-124.255387],[54.433902,-124.255176],[54.434344,-124.254805],[54.437542,-124.25213],[54.437807,-124.25191],[54.438529,-124.251291],[54.438674,-124.251187],[54.438803,-124.251109],[54.438924,-124.251058]], diam:0.25, label:'Stuart Lake Highway (10")' },
  { id:'OSM-166', pts:[[54.445917,-124.250955],[54.446037,-124.250959]], diam:0.2, label:'Douglas Avenue (8")' },
  { id:'OSM-167', pts:[[54.446037,-124.250959],[54.446215,-124.250944]], diam:0.2, label:'Douglas Avenue (8")' },
  { id:'OSM-168', pts:[[54.458871,-124.240609],[54.459131,-124.24048],[54.459574,-124.240048]], diam:0.15, label:'Road 375013000 (6")' },
  { id:'OSM-169', pts:[[54.458848,-124.244737],[54.458998,-124.2447],[54.459329,-124.244737],[54.459595,-124.244998],[54.459736,-124.245092],[54.459888,-124.245008],[54.459925,-124.244841]], diam:0.15, label:'Road 375013002 (6")' },
  { id:'OSM-170', pts:[[54.458837,-124.246665],[54.457793,-124.245923]], diam:0.15, label:'Road 375013003 (6")' },
  { id:'OSM-171', pts:[[54.458862,-124.242238],[54.458053,-124.242234],[54.45792,-124.242595],[54.457695,-124.243205],[54.457576,-124.24328],[54.457516,-124.243131],[54.457521,-124.242906],[54.457787,-124.242635],[54.45792,-124.242595]], diam:0.15, label:'Road 375013005 (6")' },
  { id:'OSM-172', pts:[[54.458858,-124.24298],[54.459074,-124.242972],[54.459422,-124.243018],[54.459834,-124.243112],[54.460127,-124.243457],[54.460328,-124.243429]], diam:0.15, label:'Road 375013006 (6")' },
  { id:'OSM-173', pts:[[54.469818,-124.290865],[54.469975,-124.291014],[54.470226,-124.291333],[54.470579,-124.291663],[54.470689,-124.291793],[54.471115,-124.292476],[54.471177,-124.292534],[54.471271,-124.292546],[54.471459,-124.29248],[54.471547,-124.292541],[54.471628,-124.292716],[54.471827,-124.293736],[54.471888,-124.293924],[54.471941,-124.294007],[54.472013,-124.294045],[54.472111,-124.293988],[54.472158,-124.293918],[54.472195,-124.293817],[54.472247,-124.293165],[54.472264,-124.292704],[54.47226,-124.291874],[54.472317,-124.291488],[54.472373,-124.291245],[54.47243,-124.290749],[54.472587,-124.29006],[54.472581,-124.289416],[54.472459,-124.288679],[54.472423,-124.287632],[54.472361,-124.287075],[54.472267,-124.286641],[54.472211,-124.285986],[54.47217,-124.285095],[54.472179,-124.284787],[54.472268,-124.284147],[54.472273,-124.283994],[54.472237,-124.283428],[54.472212,-124.282365],[54.472138,-124.2817],[54.472135,-124.28141],[54.472185,-124.280769],[54.472177,-124.280261],[54.4722,-124.279972],[54.472355,-124.278913],[54.472526,-124.278338],[54.472565,-124.278085],[54.47258,-124.277677],[54.47249,-124.277194],[54.472238,-124.276294],[54.472178,-124.275801],[54.472149,-124.275712],[54.472081,-124.275622],[54.471914,-124.275506],[54.471857,-124.275433],[54.471816,-124.275338],[54.471808,-124.275231],[54.471843,-124.275136],[54.471972,-124.274952],[54.471984,-124.274885],[54.47198,-124.274691],[54.472007,-124.274559],[54.472147,-124.274346],[54.472402,-124.274075],[54.472453,-124.273998],[54.472482,-124.273904],[54.472555,-124.27343],[54.472703,-124.273046],[54.472895,-124.272388],[54.472957,-124.272281],[54.473162,-124.272035],[54.473226,-124.271913],[54.473385,-124.271281],[54.473297,-124.271106],[54.473252,-124.271082],[54.473195,-124.271142],[54.47276,-124.271778],[54.472246,-124.272022],[54.471877,-124.272111],[54.471775,-124.272201],[54.471584,-124.272474],[54.47144,-124.272746],[54.471208,-124.273057],[54.470889,-124.273574],[54.47083,-124.273638],[54.470767,-124.273651],[54.470703,-124.273587],[54.470599,-124.273373],[54.470538,-124.27333],[54.470488,-124.273337],[54.470425,-124.273393],[54.470265,-124.273638],[54.470177,-124.273658],[54.470135,-124.273578],[54.470125,-124.273411],[54.470167,-124.273049],[54.470198,-124.272561],[54.470201,-124.272253],[54.470244,-124.271917],[54.470249,-124.271828],[54.470224,-124.27162],[54.470107,-124.271129],[54.470027,-124.270946],[54.469832,-124.270608],[54.469754,-124.270424],[54.469649,-124.270042],[54.469564,-124.269411],[54.469505,-124.26916],[54.469399,-124.268859],[54.469201,-124.268408],[54.469141,-124.26797],[54.469119,-124.267659],[54.469079,-124.267579],[54.468869,-124.267589],[54.468811,-124.267525],[54.468775,-124.267455],[54.468651,-124.267053],[54.468478,-124.266571],[54.468249,-124.265985],[54.468199,-124.2659],[54.468143,-124.265866],[54.468033,-124.265981],[54.467963,-124.265982],[54.467861,-124.265884],[54.467814,-124.265794],[54.467654,-124.265301],[54.467565,-124.265089],[54.467399,-124.264835],[54.467184,-124.264646],[54.467113,-124.264616]], diam:0.15, label:'Nature\'s Own (6")' },
  { id:'OSM-174', pts:[[54.439402,-124.256304],[54.439392,-124.256357],[54.439401,-124.25638],[54.439435,-124.256397],[54.439473,-124.256339],[54.439495,-124.256242],[54.439524,-124.256041],[54.439893,-124.256062],[54.439952,-124.255741],[54.439973,-124.255678],[54.440072,-124.255589],[54.440114,-124.255589],[54.440262,-124.255688],[54.440283,-124.255571],[54.440716,-124.255816],[54.440732,-124.255725],[54.44081,-124.255302],[54.441013,-124.25543],[54.441155,-124.255511],[54.441063,-124.256076],[54.440763,-124.255924],[54.440705,-124.255891],[54.440716,-124.255816]], diam:0.15, label:'Road 534299099 (6")' },
  { id:'OSM-175', pts:[[54.441063,-124.256076],[54.441049,-124.25618],[54.441095,-124.256205],[54.440967,-124.256863],[54.440875,-124.257354]], diam:0.15, label:'Road 534299100 (6")' },
  { id:'OSM-176', pts:[[54.440967,-124.256863],[54.440706,-124.256688],[54.440644,-124.256663],[54.440453,-124.256587],[54.440246,-124.256628],[54.440002,-124.256685],[54.439849,-124.256718],[54.439692,-124.256786],[54.439508,-124.256781],[54.439435,-124.25661],[54.439378,-124.25642],[54.439392,-124.256357]], diam:0.15, label:'Road 534299101 (6")' },
  { id:'OSM-177', pts:[[54.439508,-124.256781],[54.43937,-124.25679],[54.439208,-124.256801],[54.439087,-124.256788],[54.43901,-124.25677],[54.438967,-124.256703],[54.438684,-124.256351],[54.438616,-124.256267]], diam:0.15, label:'Road 534299102 (6")' },
  { id:'OSM-178', pts:[[54.440763,-124.255924],[54.440644,-124.256663]], diam:0.15, label:'Road 534299103 (6")' },
  { id:'OSM-179', pts:[[54.441013,-124.25543],[54.440813,-124.255768],[54.440732,-124.255725]], diam:0.15, label:'Road 534299104 (6")' },
  { id:'OSM-180', pts:[[54.440967,-124.256863],[54.441065,-124.256943],[54.441251,-124.257018],[54.441324,-124.256993],[54.441433,-124.256905],[54.441637,-124.256848],[54.441644,-124.256384],[54.441824,-124.256373]], diam:0.15, label:'Road 534299105 (6")' },
  { id:'OSM-181', pts:[[54.442518,-124.252009],[54.442487,-124.251741],[54.442429,-124.251527],[54.442338,-124.251311],[54.442258,-124.251217],[54.442142,-124.251089],[54.442054,-124.25104],[54.441941,-124.250978]], diam:0.15, label:'Road 534327089 (6")' },
  { id:'OSM-182', pts:[[54.437013,-124.246504],[54.436617,-124.246816]], diam:0.15, label:'Cougar Court (6")' },
  { id:'OSM-183', pts:[[54.45826,-124.263448],[54.458407,-124.26349],[54.459043,-124.26388],[54.45912,-124.263979],[54.459224,-124.264188],[54.459384,-124.264434],[54.459555,-124.264589],[54.459598,-124.264664],[54.459615,-124.264821],[54.459577,-124.265198],[54.459576,-124.265315],[54.459597,-124.265424],[54.459668,-124.265478],[54.459712,-124.265342],[54.459743,-124.26513],[54.459778,-124.265044],[54.459814,-124.265008],[54.45986,-124.265076],[54.459881,-124.265396],[54.459985,-124.265959],[54.460074,-124.266222],[54.460178,-124.266444],[54.460165,-124.266572],[54.460084,-124.26669],[54.459951,-124.266775],[54.459892,-124.26684],[54.459677,-124.267263],[54.459659,-124.267358],[54.459686,-124.267501],[54.459884,-124.267763],[54.460112,-124.267868],[54.460161,-124.267955],[54.460404,-124.268728],[54.460491,-124.268877],[54.460598,-124.268988],[54.460661,-124.269111],[54.460793,-124.269636],[54.460811,-124.269754],[54.460821,-124.269993],[54.460824,-124.270059],[54.460847,-124.270203],[54.460895,-124.270329],[54.461096,-124.270676],[54.46114,-124.270782],[54.461196,-124.271113],[54.461208,-124.271286],[54.461247,-124.271408],[54.461359,-124.271566],[54.461427,-124.271615],[54.461537,-124.271605],[54.461592,-124.271641],[54.461697,-124.271986],[54.461766,-124.272111],[54.4618,-124.272128],[54.461871,-124.272051]], diam:0.15, label:'Graveyard Crawl (6")' },
  { id:'OSM-184', pts:[[54.46644,-124.264263],[54.466089,-124.263428],[54.465846,-124.262979],[54.465718,-124.2628],[54.465652,-124.262782],[54.465601,-124.262798],[54.465284,-124.26296],[54.465215,-124.263008],[54.46513,-124.263129],[54.465057,-124.263369],[54.464991,-124.264196],[54.46489,-124.264814],[54.464827,-124.265511],[54.464823,-124.265888],[54.464741,-124.266392],[54.464763,-124.266911],[54.464731,-124.267095],[54.464643,-124.267356],[54.464606,-124.267724],[54.46452,-124.268075],[54.464537,-124.268281],[54.464679,-124.268794],[54.464695,-124.268958],[54.464678,-124.269395]], diam:0.15, label:'Road 545117770 (6")' },
  { id:'OSM-185', pts:[[54.439146,-124.254894],[54.439151,-124.256046]], diam:0.15, label:'Road 613392535 (6")' },
  { id:'OSM-186', pts:[[54.438916,-124.254864],[54.439146,-124.254894],[54.439249,-124.254888],[54.439298,-124.254914],[54.439322,-124.254974],[54.439328,-124.25592],[54.439302,-124.256001],[54.439253,-124.25605],[54.439151,-124.256046],[54.43912,-124.256044],[54.439028,-124.255991],[54.438916,-124.255906]], diam:0.15, label:'Road 613392536 (6")' },
  { id:'OSM-187', pts:[[54.467113,-124.264616],[54.467113,-124.264554],[54.467216,-124.264243],[54.467318,-124.263991],[54.467446,-124.263809],[54.467633,-124.263589],[54.46795,-124.263299],[54.46809,-124.263251],[54.468246,-124.263149],[54.469228,-124.262462],[54.469318,-124.262457],[54.469406,-124.262489],[54.469468,-124.262441],[54.469549,-124.262382],[54.469611,-124.262344],[54.469677,-124.262366],[54.469745,-124.262398],[54.470353,-124.262682],[54.470456,-124.262661],[54.470512,-124.262704],[54.470546,-124.262779],[54.47059,-124.262886],[54.470637,-124.262913],[54.470693,-124.262902],[54.470749,-124.262923],[54.470799,-124.262988],[54.470812,-124.263063],[54.470802,-124.263224],[54.47069,-124.26442],[54.47069,-124.264613],[54.470671,-124.264833],[54.470484,-124.265997],[54.470462,-124.26618],[54.470475,-124.266378],[54.470494,-124.266464],[54.470537,-124.266512],[54.470599,-124.266555],[54.470631,-124.266625],[54.470646,-124.266684],[54.470858,-124.267108],[54.470952,-124.267215],[54.471008,-124.267247],[54.471073,-124.26722],[54.471139,-124.267151],[54.471207,-124.267027],[54.471251,-124.266968],[54.471329,-124.266925],[54.471438,-124.266915],[54.471588,-124.266925],[54.471806,-124.266909],[54.471906,-124.26684],[54.471996,-124.266754],[54.472074,-124.266657],[54.472127,-124.266636],[54.472224,-124.266652],[54.47228,-124.266705],[54.472701,-124.267049],[54.472987,-124.267338],[54.473202,-124.267532],[54.473368,-124.267639],[54.473502,-124.267692],[54.473645,-124.267725],[54.473782,-124.267714],[54.473873,-124.267752],[54.473935,-124.267859],[54.473954,-124.26802],[54.47396,-124.268181],[54.473997,-124.268417],[54.474041,-124.268508],[54.474119,-124.268567],[54.474178,-124.268599],[54.474206,-124.268642],[54.474219,-124.268733],[54.474209,-124.26884],[54.474181,-124.268964],[54.474147,-124.269012],[54.474134,-124.269076],[54.474147,-124.269173],[54.474162,-124.269243],[54.474159,-124.269307],[54.474141,-124.269361],[54.474091,-124.269409],[54.473991,-124.269559],[54.473969,-124.269693],[54.473997,-124.26987],[54.474053,-124.269999],[54.474138,-124.270182],[54.474166,-124.270241],[54.474184,-124.270359],[54.474175,-124.27045],[54.474138,-124.270509],[54.474097,-124.270578],[54.474075,-124.270659],[54.474078,-124.270766],[54.47411,-124.270841],[54.474138,-124.270954],[54.474128,-124.271018],[54.474078,-124.271142],[54.473976,-124.271251]], diam:0.15, label:'New Climbing Trail (6")' },
  { id:'OSM-188', pts:[[54.467113,-124.264616],[54.467031,-124.264609],[54.466883,-124.264648],[54.466766,-124.264647],[54.466651,-124.264584],[54.46644,-124.264263]], diam:0.15, label:'Road 641774601 (6")' },
  { id:'OSM-189', pts:[[54.463418,-124.264713],[54.463742,-124.264745],[54.463805,-124.264771],[54.463858,-124.264857],[54.464138,-124.265608],[54.464216,-124.265973],[54.464238,-124.266199],[54.464235,-124.266504],[54.464176,-124.26681],[54.464079,-124.267218],[54.463914,-124.267979],[54.463904,-124.26814],[54.463926,-124.268366],[54.464004,-124.268575],[54.464163,-124.268859],[54.464294,-124.268993],[54.464603,-124.269251],[54.464678,-124.269395]], diam:0.15, label:'Road 641774602 (6")' },
  { id:'OSM-190', pts:[[54.46513,-124.263129],[54.463758,-124.264246],[54.463696,-124.264267],[54.463605,-124.264251],[54.46354,-124.264289],[54.463471,-124.264434],[54.463449,-124.264589],[54.463418,-124.264713],[54.463359,-124.26482],[54.462901,-124.265512],[54.462829,-124.26578],[54.462807,-124.266086],[54.462826,-124.26635]], diam:0.15, label:'Road 641774603 (6")' },
  { id:'OSM-191', pts:[[54.46644,-124.264263],[54.466348,-124.264363],[54.46629,-124.264478],[54.466257,-124.264668],[54.466253,-124.265348],[54.4662,-124.265756],[54.466137,-124.266007],[54.466032,-124.266288],[54.466008,-124.266398],[54.466048,-124.267091],[54.466153,-124.267603],[54.466161,-124.267778],[54.466122,-124.267913],[54.465957,-124.268233],[54.465903,-124.268534],[54.465904,-124.26862]], diam:0.15, label:'Triple Drop (6")' },
  { id:'OSM-192', pts:[[54.444281,-124.257524],[54.444233,-124.257627],[54.444056,-124.258014],[54.444021,-124.258085],[54.444137,-124.258242],[54.444977,-124.259377]], diam:0.15, label:'Road 1173965840 (6")' },
  { id:'OSM-193', pts:[[54.444137,-124.258242],[54.444088,-124.258342],[54.444062,-124.258397],[54.443896,-124.258468],[54.44382,-124.258641],[54.44378,-124.25867],[54.443753,-124.258701],[54.443711,-124.258729],[54.443674,-124.258743],[54.443656,-124.258781],[54.443683,-124.258849],[54.443726,-124.258893],[54.443776,-124.258926],[54.443851,-124.258945],[54.443885,-124.258946],[54.443916,-124.258947],[54.443989,-124.258906],[54.44405,-124.25883],[54.444084,-124.258763],[54.44412,-124.258674],[54.444136,-124.258579],[54.444137,-124.258477],[54.444088,-124.258342]], diam:0.15, label:'Road 1173965841 (6")' },
  { id:'OSM-194', pts:[[54.443989,-124.258906],[54.44399,-124.258981],[54.44398,-124.25903],[54.443956,-124.259056],[54.443923,-124.259058],[54.443872,-124.259053]], diam:0.15, label:'Road 1173965842 (6")' },
  { id:'OSM-195', pts:[[54.443956,-124.259056],[54.443948,-124.25912],[54.443928,-124.259159],[54.443894,-124.259188],[54.443868,-124.259177],[54.443858,-124.259152],[54.443858,-124.2591],[54.443872,-124.259053],[54.443884,-124.259014],[54.443885,-124.258946]], diam:0.15, label:'Road 1173965843 (6")' },
  { id:'OSM-196', pts:[[54.444021,-124.258085],[54.44318,-124.256927],[54.442743,-124.256337],[54.442602,-124.256084],[54.442537,-124.255918],[54.442485,-124.255615],[54.442482,-124.254336],[54.442482,-124.25429],[54.442478,-124.253479]], diam:0.15, label:'Road 1231319725 (6")' },
  { id:'OSM-197', pts:[[54.442478,-124.253479],[54.44248,-124.252769],[54.442482,-124.252229]], diam:0.15, label:'Road 1231319726 (6")' },
  { id:'OSM-198', pts:[[54.444113,-124.257707],[54.443405,-124.256743],[54.443284,-124.256956]], diam:0.15, label:'Road 1231319727 (6")' },
  { id:'OSM-199', pts:[[54.444182,-124.257558],[54.444233,-124.257627],[54.444283,-124.257696],[54.444911,-124.258552],[54.445001,-124.258464],[54.445065,-124.258524],[54.445059,-124.258659],[54.445004,-124.258737],[54.444939,-124.258808],[54.44482,-124.259051]], diam:0.15, label:'Road 1231319728 (6")' },
  { id:'OSM-200', pts:[[54.445143,-124.259508],[54.445243,-124.259284],[54.444939,-124.258808],[54.444903,-124.258694],[54.444911,-124.258552]], diam:0.15, label:'Road 1231319729 (6")' },
  { id:'OSM-201', pts:[[54.444283,-124.257696],[54.444224,-124.257869],[54.444598,-124.258386],[54.444903,-124.258694]], diam:0.15, label:'Road 1231319730 (6")' },
  { id:'OSM-202', pts:[[54.444598,-124.258386],[54.444482,-124.258592]], diam:0.15, label:'Road 1231319731 (6")' },
  { id:'OSM-203', pts:[[54.443236,-124.251921],[54.443279,-124.252944],[54.443273,-124.254405],[54.443315,-124.254411]], diam:0.15, label:'Road 1231319732 (6")' },
  { id:'OSM-204', pts:[[54.443273,-124.254405],[54.443263,-124.255442],[54.444218,-124.256773],[54.444442,-124.256997]], diam:0.15, label:'Road 1231319733 (6")' },
  { id:'OSM-205', pts:[[54.443656,-124.253659],[54.445082,-124.255607]], diam:0.15, label:'Road 1231319734 (6")' },
  { id:'OSM-206', pts:[[54.445435,-124.253693],[54.445318,-124.253604],[54.444309,-124.252212],[54.443357,-124.250932]], diam:0.15, label:'Road 1231319735 (6")' },
  { id:'OSM-207', pts:[[54.449832,-124.250957],[54.450986,-124.250961],[54.451218,-124.25096],[54.451304,-124.25096],[54.451405,-124.25096],[54.451585,-124.25096],[54.451968,-124.250983],[54.452093,-124.251342],[54.452112,-124.251519],[54.452077,-124.251691],[54.452017,-124.251726],[54.451965,-124.251756],[54.45179,-124.251664],[54.451645,-124.25138],[54.451585,-124.25096]], diam:0.15, label:'Road 1256749327 (6")' },
  { id:'OSM-208', pts:[[54.448179,-124.251743],[54.446312,-124.251722]], diam:0.15, label:'Road 1256749329 (6")' },
  { id:'OSM-209', pts:[[54.449316,-124.252447],[54.449327,-124.256611],[54.449336,-124.260477]], diam:0.15, label:'Road 1256749330 (6")' },
  { id:'OSM-210', pts:[[54.449772,-124.251731],[54.448179,-124.251743]], diam:0.15, label:'Road 1256749331 (6")' },
  { id:'OSM-211', pts:[[54.44395,-124.242007],[54.44413,-124.242086],[54.4443,-124.24207],[54.444356,-124.241943],[54.44442,-124.241658],[54.444461,-124.240773],[54.444512,-124.240527],[54.44488,-124.240187],[54.446177,-124.239159],[54.446912,-124.238669],[54.447018,-124.238527],[54.447055,-124.238258],[54.44706,-124.237831],[54.44705,-124.237601],[54.44711,-124.23723],[54.447266,-124.236083],[54.447354,-124.235102],[54.44734,-124.234058],[54.447345,-124.233299],[54.44746,-124.232706],[54.44774,-124.232042],[54.447754,-124.231781],[54.447703,-124.231401],[54.447515,-124.230231],[54.447496,-124.229772],[54.44747,-124.229169],[54.447473,-124.228918],[54.44745,-124.228008],[54.447368,-124.22702],[54.447363,-124.225256],[54.447423,-124.224766],[54.447602,-124.224062],[54.447657,-124.223564],[54.447731,-124.222615],[54.447855,-124.221215],[54.447883,-124.219886],[54.447823,-124.218344],[54.447915,-124.217427],[54.448021,-124.216865],[54.448274,-124.216098],[54.448504,-124.215038],[54.448669,-124.214374],[54.448747,-124.213868],[54.448812,-124.213132],[54.448779,-124.212523],[54.448733,-124.211558],[54.448738,-124.210878],[54.448784,-124.209921],[54.448779,-124.209613],[54.448664,-124.209225],[54.448485,-124.208743],[54.448375,-124.208466],[54.44831,-124.20796],[54.448319,-124.207398],[54.448315,-124.206868],[54.448306,-124.206457],[54.448241,-124.205785],[54.447809,-124.203049],[54.447473,-124.200684],[54.447441,-124.199964],[54.447648,-124.198359],[54.447795,-124.197703],[54.448232,-124.196374],[54.448425,-124.195536],[54.448434,-124.19514],[54.448458,-124.194357],[54.448674,-124.193551],[54.448871,-124.192839],[54.448908,-124.19238],[54.448899,-124.19208],[54.448926,-124.191558],[54.449032,-124.190877],[54.449172,-124.190134],[54.449713,-124.188473],[54.449799,-124.188269],[54.44986,-124.188214],[54.449928,-124.188205],[54.449999,-124.188249],[54.45004,-124.188284]], diam:0.15, label:'Road 1312535816 (6")' },
  { id:'OSM-212', pts:[[54.451195,-124.264006],[54.451267,-124.264271],[54.451338,-124.264866],[54.451307,-124.265349],[54.451251,-124.265649],[54.451217,-124.265923],[54.451494,-124.26721],[54.45156,-124.267323]], diam:0.15, label:'Road 1346425663 (6")' },
  { id:'OSM-213', pts:[[54.45179,-124.251664],[54.451752,-124.251985],[54.451709,-124.252346]], diam:0.15, label:'Road 1346425672 (6")' },
  { id:'OSM-214', pts:[[54.451645,-124.25138],[54.451487,-124.251512],[54.451306,-124.251662]], diam:0.15, label:'Road 1346425673 (6")' },
  { id:'OSM-215', pts:[[54.45203,-124.252047],[54.451752,-124.251985],[54.451652,-124.25189],[54.451561,-124.251737],[54.451487,-124.251512],[54.451458,-124.251423],[54.451405,-124.25096]], diam:0.15, label:'Road 1346425674 (6")' },
  { id:'OSM-216', pts:[[54.452017,-124.251726],[54.45203,-124.252047],[54.452046,-124.252423],[54.451709,-124.252346],[54.451608,-124.252268],[54.451508,-124.252134],[54.451338,-124.251806],[54.451306,-124.251662],[54.45124,-124.251361],[54.451218,-124.25096]], diam:0.15, label:'Road 1346425675 (6")' },
  { id:'OSM-217', pts:[[54.451968,-124.250983],[54.452062,-124.250742]], diam:0.15, label:'Road 1346425676 (6")' },
  { id:'OSM-218', pts:[[54.492961,-124.217472],[54.492716,-124.217572],[54.492421,-124.217691],[54.49181,-124.217799],[54.490782,-124.2184],[54.489872,-124.219065],[54.489062,-124.21973],[54.488314,-124.220771],[54.487493,-124.221546],[54.487417,-124.221618],[54.48584,-124.223217],[54.485129,-124.224064],[54.484699,-124.225395],[54.484475,-124.225974],[54.484182,-124.226843],[54.483939,-124.227519],[54.483927,-124.228173],[54.484201,-124.229354],[54.484406,-124.230791],[54.484435,-124.231203],[54.484487,-124.231939],[54.484487,-124.233559],[54.484606,-124.234375],[54.484625,-124.235705],[54.484724,-124.238323],[54.48473,-124.239224],[54.48493,-124.239846],[54.485148,-124.240758],[54.485067,-124.241231],[54.484955,-124.242003],[54.485098,-124.243473],[54.485267,-124.245447],[54.485441,-124.245833],[54.485771,-124.246423],[54.485877,-124.247239],[54.485765,-124.248558],[54.485777,-124.249835],[54.485827,-124.250897],[54.485977,-124.25197],[54.485902,-124.253558],[54.48569,-124.256444],[54.485485,-124.257892],[54.485366,-124.259942],[54.485379,-124.260639],[54.485871,-124.264673],[54.48627,-124.267892],[54.486419,-124.268793],[54.486706,-124.269619],[54.489087,-124.272709],[54.489698,-124.27361],[54.489785,-124.273803],[54.489891,-124.2742],[54.489909,-124.27494],[54.490078,-124.282054],[54.49019,-124.282665],[54.49029,-124.283352],[54.490234,-124.284039],[54.490327,-124.284682],[54.490333,-124.285401],[54.490296,-124.286034],[54.490252,-124.286603],[54.490283,-124.28686],[54.490371,-124.287236],[54.490545,-124.287515],[54.496558,-124.29569],[54.498228,-124.296377]], diam:0.15, label:'Road 1346893547 (6")' },
  { id:'OSM-219', pts:[[54.433156,-124.25835],[54.433125,-124.258021]], diam:0.15, label:'Road 1346947190 (6")' },
  { id:'OSM-220', pts:[[54.438918,-124.248027],[54.438786,-124.248011]], diam:0.15, label:'Road 1346947191 (6")' },
  { id:'OSM-221', pts:[[54.437329,-124.251354],[54.437069,-124.251573],[54.436975,-124.251621]], diam:0.15, label:'Road 1346947192 (6")' },
  { id:'OSM-222', pts:[[54.437329,-124.251354],[54.43748,-124.251246]], diam:0.15, label:'Road 1346947193 (6")' },
  { id:'OSM-223', pts:[[54.430811,-124.255964],[54.43078,-124.255808]], diam:0.15, label:'Road 1346947200 (6")' },
  { id:'OSM-224', pts:[[54.430943,-124.255894],[54.430987,-124.255621]], diam:0.15, label:'Road 1346947201 (6")' },
  { id:'OSM-225', pts:[[54.430943,-124.255894],[54.43117,-124.255618]], diam:0.15, label:'Road 1346947202 (6")' },
  { id:'OSM-226', pts:[[54.430943,-124.255894],[54.431161,-124.25587]], diam:0.15, label:'Road 1346947203 (6")' },
  { id:'OSM-227', pts:[[54.430894,-124.25592],[54.430987,-124.256259]], diam:0.15, label:'Road 1346947204 (6")' },
  { id:'OSM-228', pts:[[54.430952,-124.257388],[54.430866,-124.256954]], diam:0.15, label:'Road 1346947205 (6")' },
  { id:'OSM-229', pts:[[54.430456,-124.256152],[54.430502,-124.25642]], diam:0.15, label:'Road 1346947206 (6")' },
  { id:'OSM-230', pts:[[54.430546,-124.256104],[54.430507,-124.255921]], diam:0.15, label:'Road 1346947207 (6")' },
  { id:'OSM-231', pts:[[54.429939,-124.256426],[54.429983,-124.256533],[54.430043,-124.256567]], diam:0.15, label:'Road 1346947208 (6")' },
  { id:'OSM-232', pts:[[54.430209,-124.256283],[54.430256,-124.256602]], diam:0.15, label:'Road 1346947209 (6")' },
  { id:'OSM-233', pts:[[54.430305,-124.256232],[54.430268,-124.256047]], diam:0.15, label:'Road 1346947210 (6")' },
  { id:'OSM-234', pts:[[54.430075,-124.256354],[54.430037,-124.256146]], diam:0.15, label:'Road 1346947211 (6")' },
  { id:'OSM-235', pts:[[54.429996,-124.260412],[54.430149,-124.260285],[54.430293,-124.260036],[54.430402,-124.259864]], diam:0.15, label:'Road 1346947217 (6")' },
  { id:'OSM-236', pts:[[54.430567,-124.260336],[54.430482,-124.260161]], diam:0.15, label:'Road 1346947218 (6")' },
  { id:'OSM-237', pts:[[54.430753,-124.2601],[54.430867,-124.260255]], diam:0.15, label:'Road 1346947219 (6")' },
  { id:'OSM-238', pts:[[54.430869,-124.259943],[54.430771,-124.259767]], diam:0.15, label:'Road 1346947220 (6")' },
  { id:'OSM-239', pts:[[54.431024,-124.259733],[54.430916,-124.259507]], diam:0.15, label:'Road 1346947221 (6")' },
  { id:'OSM-240', pts:[[54.431647,-124.258888],[54.431546,-124.258753],[54.431521,-124.258657]], diam:0.15, label:'Road 1346947222 (6")' },
  { id:'OSM-241', pts:[[54.431399,-124.259224],[54.431335,-124.258941],[54.431351,-124.258861],[54.43141,-124.25881],[54.43161,-124.258938]], diam:0.15, label:'Road 1346947223 (6")' },
  { id:'OSM-242', pts:[[54.431772,-124.258719],[54.431649,-124.258515]], diam:0.15, label:'Road 1346947224 (6")' },
  { id:'OSM-243', pts:[[54.431968,-124.258525],[54.431869,-124.258201]], diam:0.15, label:'Road 1346947225 (6")' },
  { id:'OSM-244', pts:[[54.432086,-124.256835],[54.431742,-124.2573],[54.431572,-124.257621],[54.431488,-124.257729],[54.431229,-124.257882],[54.431092,-124.25786],[54.431023,-124.257705],[54.431005,-124.257364]], diam:0.15, label:'Road 1346947226 (6")' },
  { id:'OSM-245', pts:[[54.432303,-124.257149],[54.432442,-124.257037]], diam:0.15, label:'Road 1346947227 (6")' },
  { id:'OSM-246', pts:[[54.432237,-124.256932],[54.432303,-124.257149],[54.432326,-124.257348],[54.432388,-124.257536],[54.432501,-124.257597],[54.432616,-124.257638]], diam:0.15, label:'Road 1346947228 (6")' },
  { id:'OSM-247', pts:[[54.433754,-124.254589],[54.433499,-124.254806]], diam:0.15, label:'Road 1346947230 (6")' },
  { id:'OSM-248', pts:[[54.433428,-124.25517],[54.433357,-124.254924]], diam:0.15, label:'Road 1346947231 (6")' },
  { id:'OSM-249', pts:[[54.433295,-124.25528],[54.433225,-124.255035]], diam:0.15, label:'Road 1346947232 (6")' },
  { id:'OSM-250', pts:[[54.433167,-124.255387],[54.433295,-124.25528],[54.433428,-124.25517],[54.433565,-124.255056]], diam:0.15, label:'Road 1346947233 (6")' },
  { id:'OSM-251', pts:[[54.43326,-124.255719],[54.433167,-124.255387],[54.433097,-124.255141],[54.432889,-124.254403],[54.433237,-124.254135],[54.433327,-124.254153]], diam:0.15, label:'Road 1346947234 (6")' },
  { id:'OSM-252', pts:[[54.433499,-124.254806],[54.433357,-124.254924],[54.433225,-124.255035],[54.433097,-124.255141]], diam:0.15, label:'Road 1346947235 (6")' },
  { id:'OSM-253', pts:[[54.433902,-124.255176],[54.433754,-124.254589],[54.433587,-124.253931]], diam:0.15, label:'Road 1346947236 (6")' },
  { id:'OSM-254', pts:[[54.433652,-124.255387],[54.433565,-124.255056],[54.433499,-124.254806],[54.433327,-124.254153],[54.433587,-124.253931],[54.433997,-124.253581]], diam:0.15, label:'Road 1346947237 (6")' },
  { id:'OSM-255', pts:[[54.433378,-124.255977],[54.433459,-124.256278],[54.433509,-124.256283]], diam:0.15, label:'Road 1346947238 (6")' },
  { id:'OSM-256', pts:[[54.433184,-124.257198],[54.43319,-124.257447]], diam:0.15, label:'Road 1346947239 (6")' },
  { id:'OSM-257', pts:[[54.433002,-124.256292],[54.433184,-124.257198],[54.433284,-124.257313]], diam:0.15, label:'Road 1346947240 (6")' },
  { id:'OSM-258', pts:[[54.43345,-124.258413],[54.433445,-124.258203]], diam:0.15, label:'Road 1346947247 (6")' },
  { id:'OSM-259', pts:[[54.433688,-124.258465],[54.433689,-124.258255]], diam:0.15, label:'Road 1346947248 (6")' },
  { id:'OSM-260', pts:[[54.433968,-124.258526],[54.433967,-124.258364]], diam:0.15, label:'Road 1346947250 (6")' },
  { id:'OSM-261', pts:[[54.435125,-124.258127],[54.435148,-124.258364]], diam:0.15, label:'Road 1346947251 (6")' },
  { id:'OSM-262', pts:[[54.434654,-124.258379],[54.434691,-124.258665],[54.434739,-124.258826]], diam:0.15, label:'Road 1346947252 (6")' },
  { id:'OSM-263', pts:[[54.434225,-124.258538],[54.434253,-124.258391]], diam:0.15, label:'Road 1346947253 (6")' },
  { id:'OSM-264', pts:[[54.43442,-124.257732],[54.434498,-124.257959]], diam:0.15, label:'Road 1346947254 (6")' },
  { id:'OSM-265', pts:[[54.43434,-124.257361],[54.434585,-124.257369],[54.434647,-124.257334]], diam:0.15, label:'Road 1346947255 (6")' },
  { id:'OSM-266', pts:[[54.434308,-124.257212],[54.434145,-124.25727],[54.434073,-124.257203],[54.433991,-124.256693],[54.434034,-124.256567],[54.434142,-124.256405]], diam:0.15, label:'Road 1346947256 (6")' },
  { id:'OSM-267', pts:[[54.434163,-124.256513],[54.434382,-124.25642]], diam:0.15, label:'Road 1346947257 (6")' },
  { id:'OSM-268', pts:[[54.434783,-124.255496],[54.43485,-124.255819]], diam:0.15, label:'Road 1346947258 (6")' },
  { id:'OSM-269', pts:[[54.434742,-124.254839],[54.43488,-124.255488]], diam:0.15, label:'Road 1346947259 (6")' },
  { id:'OSM-270', pts:[[54.434536,-124.255518],[54.434783,-124.255496],[54.43488,-124.255488],[54.434992,-124.255637],[54.435204,-124.255561],[54.435242,-124.25546]], diam:0.15, label:'Road 1346947260 (6")' },
  { id:'OSM-271', pts:[[54.435876,-124.253889],[54.435931,-124.254121]], diam:0.15, label:'Road 1346947261 (6")' },
  { id:'OSM-272', pts:[[54.435744,-124.254],[54.435852,-124.254352]], diam:0.15, label:'Road 1346947262 (6")' },
  { id:'OSM-273', pts:[[54.436232,-124.253592],[54.436368,-124.254006],[54.436363,-124.254148]], diam:0.15, label:'Road 1346947263 (6")' },
  { id:'OSM-274', pts:[[54.438144,-124.247636],[54.438245,-124.248129]], diam:0.15, label:'Road 1346947265 (6")' },
  { id:'OSM-275', pts:[[54.437594,-124.247878],[54.437683,-124.248212]], diam:0.15, label:'Road 1346947266 (6")' },
  { id:'OSM-276', pts:[[54.437363,-124.248037],[54.437483,-124.248346]], diam:0.15, label:'Road 1346947267 (6")' },
  { id:'OSM-277', pts:[[54.437167,-124.248189],[54.437242,-124.248432]], diam:0.15, label:'Road 1346947268 (6")' },
  { id:'OSM-278', pts:[[54.436294,-124.248966],[54.436251,-124.24876],[54.436248,-124.248684],[54.43628,-124.248621],[54.436287,-124.248588]], diam:0.15, label:'Road 1346947285 (6")' },
  { id:'OSM-279', pts:[[54.436065,-124.249164],[54.436095,-124.249301],[54.436144,-124.249425]], diam:0.15, label:'Road 1346947286 (6")' },
  { id:'OSM-280', pts:[[54.435883,-124.249321],[54.435786,-124.248939]], diam:0.15, label:'Road 1346947287 (6")' },
  { id:'OSM-281', pts:[[54.435538,-124.249619],[54.43544,-124.24921]], diam:0.15, label:'Road 1346947288 (6")' },
  { id:'OSM-282', pts:[[54.435596,-124.249569],[54.435643,-124.249747],[54.435743,-124.249811]], diam:0.15, label:'Road 1346947289 (6")' },
  { id:'OSM-283', pts:[[54.435558,-124.249601],[54.435635,-124.24994]], diam:0.15, label:'Road 1346947290 (6")' },
  { id:'OSM-284', pts:[[54.435083,-124.250012],[54.434963,-124.249698]], diam:0.15, label:'Road 1346947291 (6")' },
  { id:'OSM-285', pts:[[54.43512,-124.249981],[54.435167,-124.250162]], diam:0.15, label:'Road 1346947292 (6")' },
  { id:'OSM-286', pts:[[54.434634,-124.2504],[54.434752,-124.250546],[54.434842,-124.250492],[54.434905,-124.250388],[54.434903,-124.250168]], diam:0.15, label:'Road 1346947293 (6")' },
  { id:'OSM-287', pts:[[54.434623,-124.250076],[54.43454,-124.249958]], diam:0.15, label:'Road 1346947294 (6")' },
  { id:'OSM-288', pts:[[54.434694,-124.250349],[54.434623,-124.250076],[54.434643,-124.249878]], diam:0.15, label:'Road 1346947295 (6")' },
  { id:'OSM-289', pts:[[54.43442,-124.250586],[54.43429,-124.250205]], diam:0.15, label:'Road 1346947296 (6")' },
  { id:'OSM-290', pts:[[54.434179,-124.250909],[54.434303,-124.251071]], diam:0.15, label:'Road 1346947297 (6")' },
  { id:'OSM-291', pts:[[54.434179,-124.250909],[54.433988,-124.25064]], diam:0.15, label:'Road 1346947298 (6")' },
  { id:'OSM-292', pts:[[54.434086,-124.251183],[54.433888,-124.25094]], diam:0.15, label:'Road 1346947299 (6")' },
  { id:'OSM-293', pts:[[54.43403,-124.251347],[54.433917,-124.251232]], diam:0.15, label:'Road 1346947300 (6")' },
  { id:'OSM-294', pts:[[54.433997,-124.251443],[54.434131,-124.251527]], diam:0.15, label:'Road 1346947301 (6")' },
  { id:'OSM-295', pts:[[54.433856,-124.252525],[54.434,-124.252493]], diam:0.15, label:'Road 1346947302 (6")' },
  { id:'OSM-296', pts:[[54.43391,-124.251917],[54.434167,-124.252029]], diam:0.15, label:'Road 1346947303 (6")' },
  { id:'OSM-297', pts:[[54.434445,-124.253206],[54.43442,-124.253005],[54.434446,-124.252933]], diam:0.15, label:'Road 1346947304 (6")' },
  { id:'OSM-298', pts:[[54.434626,-124.253052],[54.434534,-124.252732]], diam:0.15, label:'Road 1346947305 (6")' },
  { id:'OSM-299', pts:[[54.434149,-124.253458],[54.434172,-124.253169]], diam:0.15, label:'Road 1346947306 (6")' },
  { id:'OSM-300', pts:[[54.434666,-124.253018],[54.434772,-124.253327],[54.434816,-124.253354]], diam:0.15, label:'Road 1346947307 (6")' },
  { id:'OSM-301', pts:[[54.434897,-124.252822],[54.434978,-124.253191],[54.435037,-124.253272]], diam:0.15, label:'Road 1346947308 (6")' },
  { id:'OSM-302', pts:[[54.435136,-124.252619],[54.435197,-124.252847],[54.435245,-124.252922],[54.435287,-124.252938],[54.435342,-124.252922]], diam:0.15, label:'Road 1346947309 (6")' },
  { id:'OSM-303', pts:[[54.435294,-124.252484],[54.435381,-124.25286],[54.435419,-124.252912]], diam:0.15, label:'Road 1346947310 (6")' },
  { id:'OSM-304', pts:[[54.435524,-124.252289],[54.435623,-124.252694],[54.435741,-124.25261]], diam:0.15, label:'Road 1346947311 (6")' },
  { id:'OSM-305', pts:[[54.435262,-124.252511],[54.435206,-124.252319]], diam:0.15, label:'Road 1346947312 (6")' },
  { id:'OSM-306', pts:[[54.435273,-124.251853],[54.434995,-124.251645]], diam:0.15, label:'Road 1346947313 (6")' },
  { id:'OSM-307', pts:[[54.43519,-124.251604],[54.435122,-124.251594],[54.435042,-124.25146]], diam:0.15, label:'Road 1346947314 (6")' },
  { id:'OSM-308', pts:[[54.435217,-124.251686],[54.435314,-124.251297]], diam:0.15, label:'Road 1346947315 (6")' },
  { id:'OSM-309', pts:[[54.435728,-124.250867],[54.435613,-124.250693]], diam:0.15, label:'Road 1346947319 (6")' },
  { id:'OSM-310', pts:[[54.435973,-124.250991],[54.43581,-124.251039]], diam:0.15, label:'Road 1346947320 (6")' },
  { id:'OSM-311', pts:[[54.43617,-124.251159],[54.435973,-124.250991],[54.435831,-124.25087],[54.435728,-124.250867],[54.43569,-124.250865],[54.435618,-124.250876]], diam:0.15, label:'Road 1346947321 (6")' },
  { id:'OSM-312', pts:[[54.436678,-124.251308],[54.436618,-124.251098]], diam:0.15, label:'Road 1346947322 (6")' },
  { id:'OSM-313', pts:[[54.436604,-124.251371],[54.436716,-124.251761],[54.436782,-124.251857]], diam:0.15, label:'Road 1346947323 (6")' },
  { id:'OSM-314', pts:[[54.43705,-124.250654],[54.436878,-124.250559]], diam:0.15, label:'Road 1346947324 (6")' },
  { id:'OSM-315', pts:[[54.436902,-124.249793],[54.436749,-124.249886]], diam:0.15, label:'Road 1346947325 (6")' },
  { id:'OSM-316', pts:[[54.436684,-124.248994],[54.436569,-124.249089]], diam:0.15, label:'Road 1346947326 (6")' },
  { id:'OSM-317', pts:[[54.436736,-124.249185],[54.436891,-124.249057]], diam:0.15, label:'Road 1346947327 (6")' },
  { id:'OSM-318', pts:[[54.436857,-124.249627],[54.437041,-124.249473]], diam:0.15, label:'Road 1346947328 (6")' },
  { id:'OSM-319', pts:[[54.436974,-124.250053],[54.437161,-124.249916]], diam:0.15, label:'Road 1346947329 (6")' },
  { id:'OSM-320', pts:[[54.437123,-124.250601],[54.437382,-124.250422]], diam:0.15, label:'Road 1346947330 (6")' },
  { id:'OSM-321', pts:[[54.437212,-124.250925],[54.43746,-124.250793]], diam:0.15, label:'Road 1346947331 (6")' },
  { id:'OSM-322', pts:[[54.437395,-124.251592],[54.437519,-124.25149]], diam:0.15, label:'Road 1346947332 (6")' },
  { id:'OSM-323', pts:[[54.43866,-124.256243],[54.438684,-124.256351],[54.438736,-124.256594]], diam:0.15, label:'Road 1346947333 (6")' },
  { id:'OSM-324', pts:[[54.438491,-124.256334],[54.438566,-124.256653]], diam:0.15, label:'Road 1346947334 (6")' },
  { id:'OSM-325', pts:[[54.438301,-124.256435],[54.43827,-124.25613]], diam:0.15, label:'Road 1346947335 (6")' },
  { id:'OSM-326', pts:[[54.438245,-124.256465],[54.438285,-124.256691]], diam:0.15, label:'Road 1346947336 (6")' },
  { id:'OSM-327', pts:[[54.437729,-124.256741],[54.437644,-124.256302]], diam:0.15, label:'Road 1346947337 (6")' },
  { id:'OSM-328', pts:[[54.437339,-124.256949],[54.437296,-124.256688]], diam:0.15, label:'Road 1346947338 (6")' },
  { id:'OSM-329', pts:[[54.437339,-124.256949],[54.437367,-124.257216]], diam:0.15, label:'Road 1346947339 (6")' },
  { id:'OSM-330', pts:[[54.437208,-124.257019],[54.43725,-124.257276]], diam:0.15, label:'Road 1346947340 (6")' },
  { id:'OSM-331', pts:[[54.436811,-124.25723],[54.436793,-124.257064]], diam:0.15, label:'Road 1346947341 (6")' },
  { id:'OSM-332', pts:[[54.436811,-124.25723],[54.436855,-124.257503]], diam:0.15, label:'Road 1346947342 (6")' },
  { id:'OSM-333', pts:[[54.436662,-124.257309],[54.436694,-124.257477]], diam:0.15, label:'Road 1346947343 (6")' },
  { id:'OSM-334', pts:[[54.436385,-124.257457],[54.436421,-124.257699]], diam:0.15, label:'Road 1346947344 (6")' },
  { id:'OSM-335', pts:[[54.436177,-124.257567],[54.436247,-124.25793]], diam:0.15, label:'Road 1346947345 (6")' },
  { id:'OSM-336', pts:[[54.435446,-124.257957],[54.435604,-124.258279],[54.435683,-124.258228]], diam:0.15, label:'Road 1346947346 (6")' },
  { id:'OSM-337', pts:[[54.435825,-124.255892],[54.435789,-124.256221],[54.435721,-124.256433],[54.435632,-124.256546],[54.435535,-124.256535],[54.435403,-124.256358],[54.435313,-124.256175]], diam:0.15, label:'Road 1346947347 (6")' },
  { id:'OSM-338', pts:[[54.436008,-124.255791],[54.43593,-124.255623],[54.435886,-124.255561],[54.435841,-124.255559],[54.435805,-124.255596],[54.435755,-124.255672],[54.435732,-124.255762],[54.435724,-124.255948]], diam:0.15, label:'Road 1346947348 (6")' },
  { id:'OSM-339', pts:[[54.436197,-124.255687],[54.436189,-124.255586],[54.436148,-124.255481],[54.436101,-124.255385]], diam:0.15, label:'Road 1346947349 (6")' },
  { id:'OSM-340', pts:[[54.436197,-124.255687],[54.436239,-124.255975],[54.436236,-124.256063]], diam:0.15, label:'Road 1346947350 (6")' },
  { id:'OSM-341', pts:[[54.436545,-124.255495],[54.43659,-124.255752]], diam:0.15, label:'Road 1346947351 (6")' },
  { id:'OSM-342', pts:[[54.436791,-124.253124],[54.437012,-124.25411],[54.437017,-124.254298],[54.436991,-124.254432],[54.436955,-124.254647],[54.436908,-124.254955],[54.436909,-124.255162],[54.436916,-124.25529]], diam:0.15, label:'Road 1346947361 (6")' },
  { id:'OSM-343', pts:[[54.436916,-124.25529],[54.436958,-124.255556]], diam:0.15, label:'Road 1346947362 (6")' },
  { id:'OSM-344', pts:[[54.437119,-124.255178],[54.437167,-124.25543]], diam:0.15, label:'Road 1346947363 (6")' },
  { id:'OSM-345', pts:[[54.43743,-124.255006],[54.437468,-124.255242]], diam:0.15, label:'Road 1346947364 (6")' },
  { id:'OSM-346', pts:[[54.437696,-124.25486],[54.437747,-124.255218],[54.437758,-124.255347]], diam:0.15, label:'Road 1346947365 (6")' },
  { id:'OSM-347', pts:[[54.437826,-124.254613],[54.437936,-124.25465],[54.438012,-124.254617],[54.438065,-124.25447]], diam:0.15, label:'Road 1346947366 (6")' },
  { id:'OSM-348', pts:[[54.437821,-124.253904],[54.438033,-124.253899]], diam:0.15, label:'Road 1346947367 (6")' },
  { id:'OSM-349', pts:[[54.437818,-124.253585],[54.437953,-124.253606],[54.438109,-124.253534],[54.438136,-124.253405]], diam:0.15, label:'Road 1346947368 (6")' },
  { id:'OSM-350', pts:[[54.437814,-124.253043],[54.438015,-124.253059]], diam:0.15, label:'Road 1346947369 (6")' },
  { id:'OSM-351', pts:[[54.43892,-124.252383],[54.438752,-124.252313]], diam:0.15, label:'Road 1346947370 (6")' },
  { id:'OSM-352', pts:[[54.438918,-124.253182],[54.438736,-124.253182],[54.438579,-124.253072]], diam:0.15, label:'Road 1346947371 (6")' },
  { id:'OSM-353', pts:[[54.438917,-124.253789],[54.438756,-124.253778],[54.4387,-124.253727],[54.438647,-124.253732]], diam:0.15, label:'Road 1346947372 (6")' },
  { id:'OSM-354', pts:[[54.438916,-124.254325],[54.438769,-124.254309],[54.438711,-124.25425],[54.438649,-124.25425]], diam:0.15, label:'Road 1346947373 (6")' },
  { id:'OSM-355', pts:[[54.438916,-124.25547],[54.438819,-124.255465],[54.438732,-124.255387],[54.438719,-124.255226],[54.438772,-124.255079],[54.438842,-124.254969],[54.438916,-124.254915]], diam:0.15, label:'Road 1346947374 (6")' },
  { id:'OSM-356', pts:[[54.430385,-124.260472],[54.430399,-124.260848],[54.43033,-124.261299],[54.430293,-124.261674],[54.430281,-124.261889],[54.430249,-124.262061],[54.430218,-124.262313],[54.430293,-124.262608],[54.430453,-124.26286],[54.43082,-124.263439],[54.430811,-124.263547],[54.43078,-124.263614],[54.430721,-124.263627],[54.430479,-124.263155],[54.430459,-124.263031],[54.430453,-124.26286]], diam:0.15, label:'Road 1346947375 (6")' },
  { id:'OSM-357', pts:[[54.433867,-124.252248],[54.433454,-124.252265],[54.433236,-124.252292],[54.432955,-124.252442],[54.4318,-124.253429],[54.431388,-124.253837],[54.431058,-124.254057],[54.429981,-124.254604],[54.429407,-124.254738]], diam:0.15, label:'Road 1346947376 (6")' },
  { id:'OSM-358', pts:[[54.438406,-124.249679],[54.438365,-124.2494],[54.438348,-124.249127]], diam:0.15, label:'Road 1346947606 (6")' },
  { id:'OSM-359', pts:[[54.438255,-124.250788],[54.438729,-124.250468]], diam:0.15, label:'Road 1346947607 (6")' },
  { id:'OSM-360', pts:[[54.438465,-124.250981],[54.438727,-124.250752],[54.438729,-124.250468],[54.43873,-124.250267],[54.43871,-124.249805]], diam:0.15, label:'Road 1346947608 (6")' },
  { id:'OSM-361', pts:[[54.438529,-124.251291],[54.438465,-124.250981],[54.438446,-124.250889],[54.438304,-124.250817],[54.438255,-124.250788],[54.438145,-124.250723],[54.4381,-124.25049],[54.438064,-124.250243],[54.438118,-124.250178],[54.438214,-124.250066],[54.438274,-124.249808],[54.438346,-124.249693],[54.438406,-124.249679],[54.438583,-124.249693],[54.438644,-124.249781],[54.43871,-124.249805],[54.438917,-124.249729]], diam:0.15, label:'Road 1346947609 (6")' },
  { id:'OSM-362', pts:[[54.458927,-124.249621],[54.458781,-124.249687],[54.458693,-124.249779],[54.458581,-124.249835],[54.458438,-124.249822],[54.458386,-124.249764],[54.458395,-124.249467]], diam:0.15, label:'Road 1346968732 (6")' },
  { id:'OSM-363', pts:[[54.458829,-124.248247],[54.458498,-124.247992],[54.458343,-124.247944],[54.458309,-124.247862]], diam:0.15, label:'Road 1346968733 (6")' },
  { id:'OSM-364', pts:[[54.463578,-124.241324],[54.46372,-124.241531]], diam:0.15, label:'Road 1346968745 (6")' },
  { id:'OSM-365', pts:[[54.463128,-124.241244],[54.463247,-124.241306],[54.463578,-124.241324],[54.463696,-124.241171]], diam:0.15, label:'Road 1346968746 (6")' },
  { id:'OSM-366', pts:[[54.462945,-124.242844],[54.463162,-124.242953],[54.46333,-124.24325]], diam:0.15, label:'Road 1346968747 (6")' },
  { id:'OSM-367', pts:[[54.46309,-124.241582],[54.462909,-124.241531],[54.462582,-124.241568],[54.46244,-124.241558]], diam:0.15, label:'Road 1346968748 (6")' },
  { id:'OSM-368', pts:[[54.462275,-124.244615],[54.462105,-124.244176],[54.461991,-124.243899],[54.461963,-124.243763],[54.46198,-124.243561],[54.462016,-124.243441],[54.462073,-124.243411],[54.462105,-124.243446],[54.462123,-124.243655],[54.462105,-124.244176]], diam:0.15, label:'Road 1346968749 (6")' },
  { id:'OSM-369', pts:[[54.461987,-124.245216],[54.461783,-124.244959],[54.461646,-124.244709],[54.461473,-124.244371],[54.461339,-124.244248],[54.461202,-124.244176],[54.461102,-124.244184]], diam:0.15, label:'Road 1346968750 (6")' },
  { id:'OSM-370', pts:[[54.461959,-124.253378],[54.46205,-124.253502],[54.462278,-124.253609],[54.462496,-124.253837]], diam:0.15, label:'Road 1346968751 (6")' },
  { id:'OSM-371', pts:[[54.462608,-124.24933],[54.46301,-124.249328]], diam:0.15, label:'Road 1346968752 (6")' },
  { id:'OSM-372', pts:[[54.46283,-124.247992],[54.462909,-124.247949],[54.463003,-124.247941],[54.463093,-124.247848],[54.463202,-124.247499],[54.463255,-124.247257],[54.463252,-124.247019]], diam:0.15, label:'Road 1346968753 (6")' },
  { id:'OSM-373', pts:[[54.462577,-124.245696],[54.462522,-124.245734]], diam:0.15, label:'Road 1346968754 (6")' },
  { id:'OSM-374', pts:[[54.463127,-124.246192],[54.462577,-124.245696],[54.462569,-124.245479]], diam:0.15, label:'Road 1346968755 (6")' },
  { id:'OSM-375', pts:[[54.461987,-124.24661],[54.462011,-124.24626],[54.462055,-124.245919],[54.462133,-124.245871],[54.462217,-124.245943],[54.462285,-124.246134],[54.462525,-124.246348],[54.462722,-124.246488],[54.463035,-124.246753]], diam:0.15, label:'Road 1346968756 (6")' },
  { id:'OSM-376', pts:[[54.461677,-124.246446],[54.461987,-124.24661],[54.462281,-124.246764],[54.462685,-124.246997],[54.462962,-124.247193]], diam:0.15, label:'Road 1346968757 (6")' },
  { id:'OSM-377', pts:[[54.461528,-124.247393],[54.461858,-124.247544]], diam:0.15, label:'Road 1346968759 (6")' },
  { id:'OSM-378', pts:[[54.461441,-124.247951],[54.461826,-124.248067],[54.461851,-124.247822]], diam:0.15, label:'Road 1346968760 (6")' },
  { id:'OSM-379', pts:[[54.462779,-124.248299],[54.462351,-124.248135],[54.462094,-124.248132]], diam:0.15, label:'Road 1346968761 (6")' },
  { id:'OSM-380', pts:[[54.462468,-124.250204],[54.462298,-124.250165],[54.462228,-124.250073],[54.462192,-124.249923],[54.462251,-124.249169]], diam:0.15, label:'Road 1346968762 (6")' },
  { id:'OSM-381', pts:[[54.462382,-124.250738],[54.462417,-124.250845],[54.462435,-124.2509],[54.46253,-124.251219],[54.4626,-124.251289],[54.462669,-124.251254],[54.46271,-124.251139],[54.462695,-124.251018],[54.462417,-124.250845]], diam:0.15, label:'Road 1346968763 (6")' },
  { id:'OSM-382', pts:[[54.461953,-124.250573],[54.46193,-124.25072]], diam:0.15, label:'Road 1346968764 (6")' },
  { id:'OSM-383', pts:[[54.46237,-124.250815],[54.461953,-124.250573],[54.461629,-124.250385]], diam:0.15, label:'Road 1346968765 (6")' },
  { id:'OSM-384', pts:[[54.462237,-124.251647],[54.462011,-124.251576],[54.461798,-124.251388],[54.461732,-124.251198],[54.461716,-124.251069],[54.461627,-124.251021]], diam:0.15, label:'Road 1346968766 (6")' },
  { id:'OSM-385', pts:[[54.461939,-124.253917],[54.461726,-124.253939],[54.461319,-124.253826]], diam:0.15, label:'Road 1346968767 (6")' },
  { id:'OSM-386', pts:[[54.461938,-124.253511],[54.461838,-124.253515],[54.461428,-124.253249],[54.461319,-124.253207],[54.461255,-124.253244]], diam:0.15, label:'Road 1346968768 (6")' },
  { id:'OSM-387', pts:[[54.462117,-124.252393],[54.461461,-124.252139]], diam:0.15, label:'Road 1346968769 (6")' },
  { id:'OSM-388', pts:[[54.462108,-124.25245],[54.462505,-124.252566],[54.462521,-124.25248]], diam:0.15, label:'Road 1346968770 (6")' },
  { id:'OSM-389', pts:[[54.462529,-124.255505],[54.462527,-124.255165]], diam:0.15, label:'Road 1346968771 (6")' },
  { id:'OSM-390', pts:[[54.461946,-124.25558],[54.462116,-124.255612],[54.462529,-124.255505],[54.462873,-124.255363],[54.462945,-124.255092],[54.463073,-124.254958],[54.463246,-124.255006],[54.46328,-124.255253],[54.463188,-124.255452],[54.463046,-124.255564],[54.462918,-124.255795],[54.462834,-124.256004],[54.462803,-124.256154],[54.462805,-124.256358],[54.462783,-124.256503],[54.462744,-124.256549],[54.462625,-124.256543],[54.462564,-124.256441],[54.462539,-124.256221],[54.462529,-124.255505]], diam:0.15, label:'Road 1346968772 (6")' },
  { id:'OSM-391', pts:[[54.461945,-124.255103],[54.461796,-124.255296],[54.461732,-124.255331],[54.461693,-124.255291],[54.461634,-124.255073],[54.461638,-124.254955],[54.461702,-124.254792],[54.461941,-124.254314]], diam:0.15, label:'Road 1346968773 (6")' },
  { id:'OSM-392', pts:[[54.461948,-124.255897],[54.461832,-124.256122],[54.46174,-124.256339],[54.461557,-124.256337],[54.461562,-124.255991]], diam:0.15, label:'Road 1346968774 (6")' },
  { id:'OSM-393', pts:[[54.459888,-124.245008],[54.459997,-124.245152],[54.460564,-124.245101]], diam:0.15, label:'Road 1346968829 (6")' },
  { id:'OSM-394', pts:[[54.460434,-124.247745],[54.460246,-124.247788],[54.460076,-124.247708]], diam:0.15, label:'Road 1346968832 (6")' },
  { id:'OSM-395', pts:[[54.439416,-124.253491],[54.439368,-124.252839]], diam:0.15, label:'Road 1346969977 (6")' },
  { id:'OSM-396', pts:[[54.439964,-124.250997],[54.439969,-124.250752],[54.439984,-124.249974],[54.440087,-124.249835],[54.440181,-124.24984],[54.44024,-124.250004],[54.440232,-124.250511],[54.440193,-124.250629],[54.440093,-124.250688],[54.439969,-124.250752]], diam:0.15, label:'Road 1346969979 (6")' },
  { id:'OSM-397', pts:[[54.439888,-124.251332],[54.440311,-124.251334]], diam:0.15, label:'Road 1346969984 (6")' },
  { id:'OSM-398', pts:[[54.440312,-124.250993],[54.440311,-124.251334],[54.44031,-124.251895]], diam:0.15, label:'Road 1346969985 (6")' },
  { id:'OSM-399', pts:[[54.439887,-124.250998],[54.439888,-124.251332],[54.43989,-124.251916]], diam:0.15, label:'Road 1346969986 (6")' },
  { id:'OSM-400', pts:[[54.440163,-124.254121],[54.439892,-124.254258]], diam:0.15, label:'Road 1346969987 (6")' },
  { id:'OSM-401', pts:[[54.441968,-124.252229],[54.442002,-124.252045],[54.442062,-124.251981],[54.442183,-124.251997],[54.442302,-124.252123],[54.442383,-124.252226]], diam:0.15, label:'Road 1346969988 (6")' },
  { id:'OSM-402', pts:[[54.441419,-124.250983],[54.441422,-124.251874],[54.441466,-124.25212]], diam:0.15, label:'Road 1346969990 (6")' },
  { id:'OSM-403', pts:[[54.44248,-124.252769],[54.442222,-124.252767]], diam:0.15, label:'Road 1346969991 (6")' },
  { id:'OSM-404', pts:[[54.442093,-124.253481],[54.442132,-124.252957],[54.442098,-124.252233]], diam:0.15, label:'Road 1346969992 (6")' },
  { id:'OSM-405', pts:[[54.442372,-124.25348],[54.442302,-124.253896],[54.442347,-124.254191],[54.44243,-124.25432],[54.442482,-124.254336]], diam:0.15, label:'Road 1346969993 (6")' },
  { id:'OSM-406', pts:[[54.441586,-124.253483],[54.441569,-124.253746],[54.441516,-124.254129]], diam:0.15, label:'Road 1346969994 (6")' },
  { id:'OSM-407', pts:[[54.441628,-124.253483],[54.44163,-124.252799],[54.441556,-124.252796]], diam:0.15, label:'Road 1346969995 (6")' },
  { id:'OSM-408', pts:[[54.441185,-124.253485],[54.441154,-124.253137]], diam:0.15, label:'Road 1346969996 (6")' },
  { id:'OSM-409', pts:[[54.440585,-124.253487],[54.440574,-124.252549]], diam:0.15, label:'Road 1346969997 (6")' }

  // Total: 409 pipes following actual OSM roads
];

const reservoir = { lat:54.4385, lng:-124.2480, capacity:'Fort St. James Reservoir (2,278 m¬≥)' };

function generateHydrants(mains) {
  const hydrants = [];
  mains.forEach(m => {
    for (let i = 1; i < m.pts.length; i++) {
      const d = haversine(m.pts[i-1], m.pts[i]);
      const segs = Math.floor(d / 120);
      for (let s = 1; s <= segs; s++) {
        const f = s / (segs + 1);
        const lat = m.pts[i-1][0] + f * (m.pts[i][0] - m.pts[i-1][0]);
        const lng = m.pts[i-1][1] + f * (m.pts[i][1] - m.pts[i-1][1]);
        hydrants.push([lat, lng]);
      }
    }
    m.pts.forEach(p => hydrants.push(p));
  });
  const unique = [];
  hydrants.forEach(h => {
    if (!unique.some(u => haversine(u, h) < 60)) unique.push(h);
  });
  return unique;
}

function haversine(a, b) {
  const R = 6371000;
  const dLat = (b[0]-a[0]) * Math.PI/180;
  const dLon = (b[1]-a[1]) * Math.PI/180;
  const lat1 = a[0]*Math.PI/180, lat2 = b[0]*Math.PI/180;
  const x = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(x), Math.sqrt(1-x));
}

// ===================== BUILDINGS (OSM data - 525 structures) =====================
const buildings = [];
(function loadBuildings() {
  // V21: Fort St. James building grid (generated placeholder - centered on 54.4378¬∞N, -124.2565¬∞W)
  // Approximate 118 buildings in town core spread across ~1km x 0.8km area
  const raw = [
    // North zone (54.445-54.448)
    [54.4475,-124.2620],[54.4475,-124.2590],[54.4475,-124.2560],[54.4475,-124.2530],[54.4475,-124.2500],[54.4475,-124.2470],
    [54.4465,-124.2630],[54.4465,-124.2600],[54.4465,-124.2570],[54.4465,-124.2540],[54.4465,-124.2510],[54.4465,-124.2480],
    [54.4455,-124.2640],[54.4455,-124.2610],[54.4455,-124.2580],[54.4455,-124.2550],[54.4455,-124.2520],[54.4455,-124.2490],[54.4455,-124.2460],
    // Central-north zone (54.440-54.445)
    [54.4445,-124.2630],[54.4445,-124.2600],[54.4445,-124.2570],[54.4445,-124.2540],[54.4445,-124.2510],[54.4445,-124.2480],
    [54.4435,-124.2640],[54.4435,-124.2610],[54.4435,-124.2580],[54.4435,-124.2550],[54.4435,-124.2520],[54.4435,-124.2490],[54.4435,-124.2460],[54.4435,-124.2430],
    [54.4425,-124.2630],[54.4425,-124.2600],[54.4425,-124.2570],[54.4425,-124.2540],[54.4425,-124.2510],[54.4425,-124.2480],[54.4425,-124.2450],
    // Town center zone (54.435-54.440)
    [54.4415,-124.2640],[54.4415,-124.2610],[54.4415,-124.2580],[54.4415,-124.2550],[54.4415,-124.2520],[54.4415,-124.2490],[54.4415,-124.2460],[54.4415,-124.2430],
    [54.4405,-124.2630],[54.4405,-124.2600],[54.4405,-124.2570],[54.4405,-124.2540],[54.4405,-124.2510],[54.4405,-124.2480],[54.4405,-124.2450],[54.4405,-124.2420],
    [54.4395,-124.2640],[54.4395,-124.2610],[54.4395,-124.2580],[54.4395,-124.2550],[54.4395,-124.2520],[54.4395,-124.2490],[54.4395,-124.2460],[54.4395,-124.2430],
    // Central-south zone (54.430-54.435)
    [54.4385,-124.2630],[54.4385,-124.2600],[54.4385,-124.2570],[54.4385,-124.2540],[54.4385,-124.2510],[54.4385,-124.2480],[54.4385,-124.2450],[54.4385,-124.2420],
    [54.4375,-124.2640],[54.4375,-124.2610],[54.4375,-124.2580],[54.4375,-124.2550],[54.4375,-124.2520],[54.4375,-124.2490],[54.4375,-124.2460],[54.4375,-124.2430],
    [54.4365,-124.2630],[54.4365,-124.2600],[54.4365,-124.2570],[54.4365,-124.2540],[54.4365,-124.2510],[54.4365,-124.2480],[54.4365,-124.2450],[54.4365,-124.2420],
    // South zone + hospital (54.425-54.430)
    [54.4355,-124.2640],[54.4355,-124.2610],[54.4355,-124.2580],[54.4355,-124.2550],[54.4355,-124.2520],[54.4355,-124.2490],[54.4355,-124.2460],[54.4355,-124.2430],
    [54.4345,-124.2630],[54.4345,-124.2600],[54.4345,-124.2570],[54.4345,-124.2540],[54.4345,-124.2510],[54.4345,-124.2480],[54.4345,-124.2450],[54.4345,-124.2420],
    [54.4335,-124.2620],[54.4335,-124.2590],[54.4335,-124.2560],[54.4335,-124.2530],[54.4335,-124.2500],[54.4335,-124.2470],[54.4335,-124.2440],
  ];
  // Total: 118 buildings spread across Fort St. James town core
  raw.forEach(function(p, i) { buildings.push({ lat: p[0], lng: p[1], id: i }); });
})();

// =================== SKIP OLD HARRISON DATA ===================
(function skipOldHarrisonData() {
  // OLD: Harrison Hot Springs data (49.3¬∞N, -121.8¬∞W) - WRONG LOCATION - REMOVED
  return; // Skip everything below
  const _skip = [
    [49.303848,-121.791045],[49.303582,-121.788875],[49.303463,-121.789294],[49.303079,-121.790272],[49.303078,-121.789388],
    [49.303108,-121.789775],[49.303253,-121.789916],[49.303200,-121.788321],[49.302435,-121.789458],
    [49.302768,-121.785593],[49.303058,-121.784457],[49.302942,-121.784838],[49.302767,-121.786159],
    [49.302299,-121.786733],[49.305695,-121.773104],[49.302629,-121.789592],[49.302785,-121.789465],
    [49.302838,-121.789706],[49.302708,-121.789784],[49.302459,-121.789638],[49.302577,-121.789864],
    [49.303236,-121.786417],[49.302252,-121.785659],[49.303578,-121.785206],[49.303498,-121.785130],
    [49.302951,-121.783927],[49.302840,-121.783651],[49.302858,-121.783235],[49.302628,-121.785578],
    [49.302877,-121.785882],[49.303220,-121.785540],[49.303228,-121.785794],[49.303241,-121.785997],
    [49.303094,-121.785973],[49.303387,-121.786782],[49.303466,-121.786914],[49.303410,-121.787008],
    [49.303047,-121.787173],[49.302940,-121.787321],[49.303392,-121.787193],[49.303000,-121.782141],
    [49.302859,-121.782128],[49.304748,-121.789043],[49.304810,-121.789139],[49.304830,-121.789056],
    [49.302855,-121.780726],[49.302848,-121.779323],[49.302938,-121.778954],[49.302699,-121.778688],
    [49.302996,-121.778690],[49.302974,-121.778562],[49.302803,-121.778360],[49.302653,-121.778089],
    [49.302932,-121.777932],[49.302946,-121.777828],[49.302043,-121.785524],[49.301594,-121.784468],
    [49.301372,-121.784564],[49.301279,-121.785765],[49.301247,-121.785932],[49.301688,-121.785634],
    [49.301608,-121.785814],[49.302435,-121.787066],[49.302403,-121.787183],[49.302420,-121.787379],
    [49.302316,-121.787327],[49.302413,-121.787606],[49.302161,-121.784949],[49.301949,-121.784936],
    [49.302312,-121.785079],[49.303105,-121.776412],[49.303528,-121.777057],[49.302913,-121.776242],
    [49.302687,-121.776508],[49.298885,-121.784564],[49.298302,-121.783986],[49.298479,-121.783799],
    [49.303790,-121.784927],[49.298926,-121.784266],[49.299191,-121.784596],[49.299287,-121.784366],
    [49.298905,-121.783839],[49.298960,-121.783605],[49.299967,-121.785094],[49.305960,-121.772959],
    [49.307114,-121.773137],[49.302740,-121.790761],[49.302675,-121.790559],[49.302659,-121.790383],
    [49.302610,-121.790242],[49.302508,-121.790099],[49.302301,-121.789670],[49.303038,-121.783497],
    [49.303706,-121.790543],[49.280741,-121.782570],[49.302261,-121.776189],[49.302017,-121.784981],
    [49.302152,-121.784360],[49.298039,-121.785049],[49.297809,-121.785111],[49.297576,-121.785074],
    [49.297338,-121.785015],[49.297100,-121.784947],[49.296901,-121.784814],[49.296688,-121.784697],
    [49.293633,-121.782128],[49.294395,-121.783210],[49.294558,-121.783468],[49.294190,-121.782964],
    [49.282610,-121.781216],[49.297062,-121.783895],[49.299138,-121.771637],[49.300118,-121.771699],
    [49.300930,-121.789964],[49.300956,-121.790083],[49.295898,-121.777862],[49.295413,-121.786352],
    [49.288440,-121.779813],[49.302244,-121.778398],[49.302126,-121.778316],[49.302232,-121.778110],
    [49.302238,-121.777648],[49.301990,-121.777081],[49.301893,-121.777370],[49.301673,-121.777874],
    [49.301556,-121.777643],[49.301438,-121.777568],[49.301222,-121.777386],[49.301095,-121.777277],
    [49.301153,-121.777161],[49.301329,-121.777161],[49.301215,-121.777015],[49.301301,-121.776854],
    [49.301493,-121.776727],[49.301677,-121.776977],[49.302127,-121.776448],[49.301969,-121.779156],
    [49.301967,-121.779041],[49.302018,-121.779087],[49.302113,-121.779055],[49.302111,-121.778922],
    [49.301846,-121.778821],[49.301990,-121.778812],[49.301850,-121.778612],[49.301519,-121.778390],
    [49.301361,-121.778246],[49.301125,-121.778155],[49.301071,-121.778287],[49.301037,-121.778371],
    [49.301006,-121.778456],[49.300984,-121.778533],[49.301039,-121.777963],[49.301739,-121.778715],
    [49.299861,-121.777587],[49.299978,-121.777228],[49.302248,-121.775743],[49.300621,-121.784966],
    [49.300523,-121.784620],[49.300574,-121.784433],[49.300911,-121.782824],[49.300953,-121.782479],
    [49.301021,-121.780120],[49.300882,-121.780145],[49.301388,-121.780141],[49.301537,-121.780237],
    [49.301662,-121.780368],[49.301780,-121.780984],[49.301719,-121.781502],[49.300481,-121.782416],
    [49.300521,-121.782188],[49.296412,-121.784406],[49.296448,-121.784513],[49.296489,-121.784637],
    [49.293939,-121.781439],[49.293682,-121.781266],[49.293477,-121.780966],[49.293370,-121.780540],
    [49.293363,-121.780102],[49.293650,-121.780332],[49.293949,-121.781035],[49.293965,-121.780742],
    [49.293763,-121.780732],[49.293906,-121.780328],[49.291288,-121.779849],[49.291151,-121.779845],
    [49.291016,-121.779844],[49.290865,-121.779822],[49.290695,-121.779806],[49.290658,-121.779454],
    [49.290655,-121.779197],[49.290652,-121.778944],[49.290650,-121.778692],[49.290943,-121.779375],
    [49.290940,-121.779126],[49.290937,-121.778861],[49.290935,-121.778596],[49.290933,-121.778330],
    [49.290331,-121.779724],[49.289887,-121.779736],[49.289801,-121.779280],[49.289792,-121.778480],
    [49.289836,-121.777951],[49.290038,-121.778313],[49.290047,-121.778854],[49.290159,-121.779349],
    [49.290338,-121.778833],[49.290280,-121.778321],[49.290346,-121.777934],[49.289580,-121.779630],
    [49.289469,-121.779639],[49.289369,-121.779632],[49.289254,-121.779631],[49.289149,-121.779637],
    [49.289048,-121.779637],[49.288935,-121.779640],[49.288832,-121.779637],[49.288723,-121.779640],
    [49.288623,-121.779639],[49.289565,-121.781730],[49.289567,-121.781606],[49.289569,-121.781482],
    [49.289570,-121.781355],[49.289572,-121.781231],[49.289571,-121.781106],[49.289572,-121.780976],
    [49.289567,-121.780842],[49.289574,-121.780716],[49.289576,-121.780592],[49.289574,-121.780471],
    [49.289382,-121.781314],[49.289303,-121.781283],[49.289224,-121.781255],[49.289135,-121.781218],
    [49.289043,-121.781150],[49.289003,-121.780929],[49.289009,-121.780668],[49.289007,-121.780797],
    [49.289384,-121.780695],[49.289297,-121.780378],[49.289296,-121.780687],[49.289217,-121.780686],
    [49.289138,-121.780679],[49.285378,-121.778821],[49.292431,-121.780024],[49.292430,-121.779718],
    [49.292425,-121.779410],[49.292420,-121.779107],[49.292417,-121.778810],[49.292414,-121.778508],
    [49.292413,-121.778205],[49.292408,-121.777901],[49.292430,-121.780342],[49.292069,-121.779723],
    [49.292067,-121.779419],[49.292074,-121.779122],[49.292072,-121.778818],[49.292070,-121.778510],
    [49.292064,-121.778209],[49.292060,-121.777914],[49.292093,-121.780099],[49.293134,-121.780824],
    [49.293146,-121.780607],[49.293121,-121.780421],[49.293122,-121.780245],[49.293108,-121.780069],
    [49.293105,-121.779884],[49.293103,-121.779730],[49.293097,-121.779378],[49.293099,-121.779033],
    [49.293092,-121.778857],[49.293096,-121.778689],[49.293097,-121.778525],[49.293096,-121.778349],
    [49.293086,-121.778179],[49.293088,-121.778011],[49.293087,-121.777837],[49.292681,-121.780404],
    [49.292694,-121.780234],[49.292689,-121.780062],[49.292689,-121.779883],[49.292691,-121.779371],
    [49.292690,-121.779210],[49.292695,-121.778863],[49.292687,-121.778683],[49.292689,-121.778508],
    [49.292684,-121.778340],[49.292680,-121.778170],[49.292673,-121.778005],[49.292684,-121.777846],
    [49.292676,-121.780588],[49.284543,-121.780553],[49.284616,-121.780279],[49.284868,-121.780427],
    [49.284758,-121.780212],[49.285025,-121.779758],[49.284982,-121.779821],[49.284569,-121.779701],
    [49.284265,-121.779912],[49.284222,-121.779907],[49.284284,-121.779762],[49.284538,-121.779249],
    [49.284799,-121.779071],[49.285092,-121.778431],[49.285716,-121.778005],[49.285948,-121.777917],
    [49.286179,-121.777918],[49.286097,-121.777766],[49.280727,-121.782298],[49.280826,-121.782002],
    [49.280755,-121.781190],[49.280723,-121.780904],[49.280068,-121.772829],[49.280104,-121.772203],
    [49.280683,-121.783774],[49.280645,-121.783523],[49.281040,-121.784068],[49.282217,-121.782960],
    [49.282415,-121.782843],[49.282558,-121.783090],[49.282617,-121.782802],[49.281847,-121.783115],
    [49.283614,-121.781897],[49.283523,-121.782279],[49.283942,-121.781628],[49.283870,-121.781991],
    [49.284048,-121.781970],[49.284175,-121.781728],[49.284342,-121.781452],[49.284270,-121.781670],
    [49.284273,-121.781736],[49.284530,-121.781920],[49.284663,-121.781545],[49.284620,-121.781418],
    [49.285308,-121.781324],[49.285145,-121.781293],[49.285114,-121.781569],[49.285168,-121.781529],
    [49.285695,-121.781360],[49.285751,-121.781124],[49.285791,-121.781272],[49.285900,-121.781194],
    [49.286081,-121.781181],[49.286368,-121.781115],[49.286474,-121.781397],[49.286551,-121.781127],
    [49.286742,-121.781131],[49.286749,-121.781324],[49.286886,-121.781142],[49.287249,-121.781307],
    [49.287322,-121.781521],[49.287341,-121.781076],[49.287589,-121.781011],[49.287963,-121.780200],
    [49.285306,-121.780432],[49.286841,-121.780236],[49.287237,-121.780212],[49.286713,-121.779656],
    [49.286633,-121.779829],[49.286666,-121.779527],[49.285389,-121.779573],[49.285379,-121.779768],
    [49.285715,-121.779631],[49.285866,-121.779870],[49.285142,-121.779635],[49.285744,-121.779351],
    [49.285824,-121.779092],[49.285576,-121.778679],[49.285806,-121.778600],[49.286022,-121.778492],
    [49.286173,-121.778715],[49.286256,-121.778494],[49.286225,-121.778615],[49.293341,-121.777308],
    [49.293288,-121.777371],[49.286041,-121.779603],[49.286133,-121.779252],[49.286335,-121.779058],
    [49.286171,-121.778854],[49.286418,-121.779731],[49.286492,-121.780346],[49.286402,-121.780254],
    [49.286422,-121.780052],[49.285677,-121.780420],[49.286548,-121.779091],[49.286604,-121.778845],
    [49.286744,-121.779116],[49.286788,-121.778840],[49.286826,-121.778837],[49.286503,-121.778510],
    [49.286594,-121.778749],[49.286727,-121.778553],[49.286772,-121.778750],[49.286826,-121.778743],
    [49.287041,-121.780202],[49.287323,-121.780242],[49.287448,-121.780146],[49.287605,-121.779965],
    [49.287581,-121.779638],[49.287543,-121.779512],[49.287601,-121.779320],[49.287598,-121.778985],
    [49.287177,-121.779280],[49.287136,-121.779429],[49.287009,-121.779277],[49.287226,-121.779598],
    [49.287116,-121.779628],[49.287099,-121.779003],[49.287263,-121.778791],[49.287111,-121.778545],
    [49.287288,-121.778555],[49.287545,-121.778591],[49.287578,-121.778263],[49.287568,-121.777983],
    [49.287360,-121.777908],[49.287255,-121.777790],[49.287085,-121.777932],[49.287957,-121.779849],
    [49.287926,-121.779658],[49.287922,-121.779216],[49.287953,-121.779135],[49.287957,-121.778921],
    [49.287843,-121.778905],[49.287835,-121.778735],[49.287948,-121.778557],[49.287989,-121.778175],
    [49.287987,-121.777866],[49.287837,-121.777984],[49.288404,-121.777874],[49.288421,-121.778185],
    [49.288416,-121.778515],[49.288420,-121.779442],[49.288387,-121.779146],[49.288432,-121.779271],
    [49.288512,-121.779194],[49.288714,-121.779227],[49.288653,-121.779388],[49.288677,-121.778483],
    [49.288551,-121.778328],[49.288863,-121.778469],[49.288928,-121.779175],[49.288683,-121.777912],
    [49.288752,-121.777962],[49.288976,-121.778154],[49.288900,-121.777923],[49.289087,-121.777869],
    [49.289177,-121.778040],[49.289172,-121.778160],[49.289389,-121.778295],[49.289275,-121.778479],
    [49.289284,-121.778042],[49.289482,-121.777914],[49.289567,-121.778093],[49.289626,-121.778149],
    [49.289619,-121.778226],[49.289506,-121.778395],[49.289451,-121.778275],[49.289274,-121.779357],
    [49.289373,-121.779202],[49.289393,-121.779060],[49.289472,-121.779350],[49.289597,-121.779222],
    [49.291727,-121.779840],[49.291686,-121.779615],[49.291894,-121.779337],[49.291700,-121.779148],
    [49.291803,-121.778191],[49.291718,-121.778341],[49.291642,-121.777943],[49.291726,-121.778813],
    [49.291224,-121.779352],[49.290739,-121.777984],[49.290638,-121.777904],[49.290917,-121.777912],
    [49.291222,-121.777909],[49.291198,-121.778344],[49.292481,-121.781675],[49.292637,-121.782000],
    [49.294986,-121.784117],[49.294409,-121.785301],[49.289319,-121.780984],[49.288978,-121.781109],
    [49.296187,-121.783803],[49.296174,-121.783548],[49.295928,-121.783623],[49.295769,-121.783586],
    [49.295591,-121.783564],[49.295646,-121.783675],[49.295670,-121.783837],[49.295406,-121.783403],
    [49.295258,-121.783187],[49.294985,-121.782645],[49.295009,-121.782405],[49.294795,-121.782817],
    [49.294762,-121.782646],[49.294972,-121.783077],[49.294636,-121.782493],[49.294417,-121.781767],
    [49.294650,-121.781596],[49.294762,-121.781599],[49.294819,-121.781774],[49.294953,-121.782046],
    [49.297256,-121.779824],[49.297148,-121.779572],[49.296845,-121.777824],[49.296811,-121.778101],
    [49.298493,-121.780474],[49.298843,-121.780390],[49.298777,-121.780179],[49.298822,-121.779015],
    [49.298496,-121.779213],[49.298255,-121.778128],[49.298492,-121.777446],[49.298438,-121.777894],
    [49.298704,-121.777607],[49.298575,-121.778048],[49.298565,-121.778384],[49.303420,-121.782891],
    [49.303421,-121.785141],[49.299117,-121.784596],[49.298479,-121.783671],[49.298318,-121.783654],
    [49.298218,-121.783756], // ...and 400 more Harrison buildings
  ];
  // SKIPPED - not processed
})(); // End skipOldHarrisonData()

// ===================== WATER BODIES (STUART LAKE) =====================
// Stuart Lake is northwest of Fort St. James
// Calculate water boundary dynamically from actual road endpoints
// Fort St. James center: 54.4378¬∞N, -124.2565¬∞W

// Calculate northernmost and westernmost road points from OSM data
// BUT: only consider roads near Fort St. James core (filter out distant rural roads)
const waterBoundary = (function() {
  const FSJ_CENTER = { lat: 54.4378, lng: -124.2565 };
  const MAX_DISTANCE_KM = 0.8; // Only consider roads within 800m of town center (tight filter for main town roads)
  
  let maxLat = -Infinity; // Northernmost road point
  let minLng = Infinity;  // Westernmost road point
  let nearbyRoadsCount = 0;
  
  waterMains.forEach(function(road) {
    road.pts.forEach(function(pt) {
      const lat = pt[0];
      const lng = pt[1];
      
      // Calculate distance from point to FSJ center (rough km estimate)
      const latDiff = (lat - FSJ_CENTER.lat) * 111.32; // km
      const lngDiff = (lng - FSJ_CENTER.lng) * 111.32 * Math.cos(FSJ_CENTER.lat * Math.PI / 180); // km
      const distKm = Math.sqrt(latDiff * latDiff + lngDiff * lngDiff);
      
      // Only use points within MAX_DISTANCE_KM of town center
      if (distKm <= MAX_DISTANCE_KM) {
        nearbyRoadsCount++;
        if (lat > maxLat) maxLat = lat;
        if (lng < minLng) minLng = lng;
      }
    });
  });
  
  console.log('üìç Filtered to ' + nearbyRoadsCount + ' road points within ' + MAX_DISTANCE_KM + 'km of FSJ center');
  
  // Add small buffer beyond road network (50 meters ~ 0.00045 degrees)
  let calcWestBoundary = minLng - 0.0005;
  
  // V24: Safety check - water boundary should be reasonable for placeholder data
  // Fort St. James town is east of lake, buildings shouldn't extend past -124.260
  const REALISTIC_WEST_BOUNDARY = -124.260; // Known geography: Stuart Lake is west of this
  if (calcWestBoundary < REALISTIC_WEST_BOUNDARY) {
    console.log('‚ö†Ô∏è Calculated boundary too far west (' + calcWestBoundary.toFixed(5) + '), using realistic boundary: ' + REALISTIC_WEST_BOUNDARY);
    calcWestBoundary = REALISTIC_WEST_BOUNDARY;
  }
  
  return {
    northBoundary: maxLat + 0.0005,  // Slightly north of northernmost road
    westBoundary: calcWestBoundary,
    nearbyRoadsCount: nearbyRoadsCount // Include count for debugging
  };
})();

console.log('üåä Water boundary calculated from 409 OSM roads:');
console.log('   North of: ' + waterBoundary.northBoundary.toFixed(5) + '¬∞ (northernmost road + buffer)');
console.log('   West of: ' + waterBoundary.westBoundary.toFixed(5) + '¬∞ (westernmost road + buffer)');

function isOverWater(lat, lng) {
  // Stuart Lake is on the WEST - the waterfront where roads end
  // Anything west of the westernmost road = water
  return (lng < waterBoundary.westBoundary);
}

// V24: Filter out buildings over Stuart Lake (using water boundary logic)
(function filterWaterBuildings() {
  const originalCount = buildings.length;
  const filtered = [];
  buildings.forEach(function(b) {
    if (!isOverWater(b.lat, b.lng)) {
      filtered.push(b);
    }
  });
  buildings.length = 0; // Clear array
  filtered.forEach(function(b) { buildings.push(b); }); // Re-populate
  const removed = originalCount - buildings.length;
  console.log('üèóÔ∏è Filtered buildings: ' + removed + ' over water removed, ' + buildings.length + ' on land remain');
})();

// V24: Filter buildings not near roads (placeholder grid cleanup)
// Real buildings are near water mains (roads). Random scattered buildings in SE are artifacts.
(function filterRoadProximity() {
  const originalCount = buildings.length;
  const MAX_DISTANCE_M = 60; // Buildings must be within 60m of a road
  
  // Helper: point-to-line-segment distance (haversine-based)
  function distanceToSegment(lat, lng, segStart, segEnd) {
    const R = 6371000; // Earth radius in meters
    
    // Convert to radians
    const lat1 = segStart[0] * Math.PI / 180;
    const lng1 = segStart[1] * Math.PI / 180;
    const lat2 = segEnd[0] * Math.PI / 180;
    const lng2 = segEnd[1] * Math.PI / 180;
    const latP = lat * Math.PI / 180;
    const lngP = lng * Math.PI / 180;
    
    // Simple approximation: project point onto line segment
    // For short distances, treat as planar geometry with lat/lng scaling
    const cosLat = Math.cos(latP);
    const x1 = lng1 * R * cosLat;
    const y1 = lat1 * R;
    const x2 = lng2 * R * cosLat;
    const y2 = lat2 * R;
    const xP = lngP * R * cosLat;
    const yP = latP * R;
    
    const dx = x2 - x1;
    const dy = y2 - y1;
    const len2 = dx * dx + dy * dy;
    
    if (len2 === 0) {
      // Segment is a point
      return Math.sqrt((xP - x1) * (xP - x1) + (yP - y1) * (yP - y1));
    }
    
    // Project point onto line, clamped to segment
    let t = ((xP - x1) * dx + (yP - y1) * dy) / len2;
    t = Math.max(0, Math.min(1, t));
    
    const projX = x1 + t * dx;
    const projY = y1 + t * dy;
    
    return Math.sqrt((xP - projX) * (xP - projX) + (yP - projY) * (yP - projY));
  }
  
  // Find minimum distance from building to any road segment
  function nearestRoadDistance(lat, lng) {
    let minDist = Infinity;
    
    waterMains.forEach(function(road) {
      for (let i = 0; i < road.pts.length - 1; i++) {
        const dist = distanceToSegment(lat, lng, road.pts[i], road.pts[i + 1]);
        if (dist < minDist) minDist = dist;
      }
    });
    
    return minDist;
  }
  
  const filtered = [];
  buildings.forEach(function(b) {
    const distToRoad = nearestRoadDistance(b.lat, b.lng);
    if (distToRoad <= MAX_DISTANCE_M) {
      filtered.push(b);
    }
  });
  
  buildings.length = 0;
  filtered.forEach(function(b) { buildings.push(b); });
  const removed = originalCount - buildings.length;
  console.log('üõ£Ô∏è Road proximity filter: ' + removed + ' isolated buildings removed, ' + buildings.length + ' near roads remain');
})();

// V13: Debug line removed for production (was v10-v12 troubleshooting tool)

// ===================== LAYER GROUPS =====================
const layers = {
  pipes: L.layerGroup().addTo(map),
  hydrants: L.layerGroup().addTo(map),
  buildings: L.layerGroup().addTo(map),
  coverage: L.layerGroup().addTo(map),
  towers: L.layerGroup().addTo(map),
  simSpray: L.layerGroup().addTo(map),
  fire: L.layerGroup().addTo(map),
};

const pipePolylines = [];
waterMains.forEach(m => {
  const color = m.diam >= 0.20 ? '#1a75ff' : '#4da6ff';
  const weight = m.diam >= 0.20 ? 4 : 2.5;
  const pl = L.polyline(m.pts, { color, weight, opacity:0.8 })
    .bindTooltip(m.label + '<br>&Oslash;' + Math.round(m.diam*39.37) + '"', { className:'pipe-tooltip' });
  pl._pipeData = m;
  pl._origColor = color;
  pl._origWeight = weight;
  pipePolylines.push(pl);
  layers.pipes.addLayer(pl);
});

// Stuart Lake blocking is handled via simple lat/lng check (no visual polygon)
// Lake is northwest of Fort St. James - fires blocked via isOverWater() function

// Real hydrant positions from FVRD ArcGIS Layer 81
const hydrantPositions = [
  [49.280570,-121.780680],[49.288120,-121.777680],[49.288280,-121.780100],[49.286600,-121.780600],
  [49.287430,-121.779470],[49.286980,-121.778360],[49.286530,-121.779340],[49.285230,-121.779420],
  [49.284580,-121.779510],[49.285260,-121.778580],[49.286470,-121.778150],[49.289040,-121.778940],
  [49.290150,-121.777690],[49.290810,-121.777510],[49.291520,-121.777730],[49.291540,-121.780270],
  [49.293880,-121.781890],[49.294220,-121.780230],[49.294220,-121.778400],[49.294120,-121.777740],
  [49.295590,-121.777720],[49.295590,-121.780240],[49.295600,-121.782240],[49.296320,-121.783150],
  [49.297030,-121.780160],[49.298760,-121.780930],[49.299990,-121.780330],[49.301010,-121.780650],
  [49.300880,-121.782030],[49.298780,-121.783140],[49.300950,-121.777320],[49.302520,-121.773290],
  [49.300540,-121.772580],[49.298790,-121.774520],[49.298380,-121.776400],[49.297860,-121.777790],
  [49.298810,-121.778580],[49.299860,-121.776690],[49.299120,-121.776120],[49.302350,-121.778900],
  [49.303070,-121.779930],[49.304070,-121.789190],[49.303710,-121.788590],
];
hydrantPositions.forEach(h => {
  L.circleMarker(h, { radius:4, color:'#e74c3c', fillColor:'#e74c3c', fillOpacity:0.8, weight:1 })
    .bindTooltip('Fire Hydrant').addTo(layers.hydrants);
});

const buildingRects = [];
buildings.forEach(b => {
  const rect = L.rectangle(
    [[b.lat - 0.00006, b.lng - 0.00008], [b.lat + 0.00006, b.lng + 0.00008]],
    { color:'#888', fillColor:'#aaa', fillOpacity:0.5, weight:1 }
  ).bindTooltip('Structure');
  rect._buildingData = b;
  rect._protectionState = 'unprotected';
  buildingRects.push(rect);
  layers.buildings.addLayer(rect);
});

const resIcon = L.divIcon({ html:'<div style="font-size:20px;">&#x1f4a7;</div>', iconSize:[24,24], iconAnchor:[12,12], className:'' });
L.marker([reservoir.lat, reservoir.lng], { icon: resIcon })
  .bindPopup('<b>Water Reservoir</b><br>' + reservoir.capacity + '<br>FVRD Water System').addTo(map);

const townBoundary = L.polygon([
  [49.3045,-121.7920],[49.3045,-121.7700],[49.2800,-121.7700],[49.2800,-121.7920]
], { color:'#FF6B35', fill:false, weight:2, dashArray:'8,6', opacity:0.6 }).addTo(map);

const TOWN_AREA_HA = 45.0;

// ===================== V8: EVACUATION MODE =====================
let evacuationMode = true; // default ON

function getHydraulicSlope() {
  return evacuationMode ? 0.01 : 0.005;
}

function toggleEvacuationMode() {
  evacuationMode = !evacuationMode;
  const btn = document.getElementById('btn-evac');
  if (evacuationMode) {
    btn.textContent = '\u{1f6a8} Evacuation Mode: ON';
    btn.className = 'btn btn-evac active';
  } else {
    btn.textContent = '\u{1f6a8} Evacuation Mode: OFF';
    btn.className = 'btn btn-outline';
    btn.style.color = '#aaa';
  }
  // Recalculate zone supplies if zones exist
  if (simZoneState && simZoneState.length > 0) {
    recalcZoneSupply();
  }
  updateStats();
}

// ===================== SPRINKLER TYPES (V4 - REAL NELSON SPECS) =====================
// Updated with actual Nelson Big Gun specifications for wildfire defense
// Source: nelsonirrigation.com/products/big-gun/ (high-end configurations)
const SPRINKLER_TYPES = {
  BG100: { name:'Big Gun 100', gpm:180, psi:90, radiusM:55, coverage:0.95 },
  BG150: { name:'Big Gun 150', gpm:400, psi:100, radiusM:70, coverage:1.54 },
  BG200: { name:'Big Gun 200', gpm:700, psi:110, radiusM:90, coverage:2.54 }
};
let currentSprinklerType = 'BG150';

function getSprinklerRadius() {
  return SPRINKLER_TYPES[currentSprinklerType].radiusM;
}

function changeSprinklerType(type) {
  currentSprinklerType = type;
  const spec = SPRINKLER_TYPES[type];
  
  const infoDiv = document.getElementById('sprinkler-info');
  if (infoDiv) {
    infoDiv.textContent = `‚úì ${spec.gpm} GPM @ ${spec.psi} PSI | ${spec.coverage} ha coverage`;
  }
  
  towers.forEach(function(t) {
    t.circle.setRadius(getSprinklerRadius());
  });
  
  updateCoverage();
  updateStats();
}

// ===================== WIND SPEED CONTROL (V4) =====================
let windSpeed = 25; // km/h

function setWindSpeed(speed) {
  windSpeed = parseInt(speed);
  document.getElementById('wind-speed-display').textContent = windSpeed + ' km/h';
}

// ===================== TOWER MANAGEMENT =====================
let towers = [];
let placeMode = false;
let ignitionMode = false;
let simulated = false;

function makeTowerIcon(label, color, cisternPct) {
  const bg = color || '#FF6B35';
  const cPct = cisternPct != null ? cisternPct : -1;
  const cisternColor = cPct > 60 ? '#3498db' : cPct > 30 ? '#f1c40f' : '#e74c3c';
  const cisternBar = cPct >= 0 ? '<div style="width:32px;height:5px;background:rgba(0,0,0,0.6);border-radius:3px;margin-top:2px;border:1px solid rgba(255,255,255,0.3);"><div style="width:' + cPct + '%;height:100%;background:' + cisternColor + ';border-radius:2px;"></div></div>' : '';
  return L.divIcon({
    html: '<div style="text-align:center;"><div style="width:28px;height:28px;border-radius:50%;background:radial-gradient(circle at 40% 35%, ' + bg + ', ' + bg + 'aa);border:3px solid #fff;box-shadow:0 2px 8px rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;font-size:14px;color:#fff;font-weight:bold;">&#x1f5fc;</div>' + cisternBar + '</div>',
    iconSize: [28, 38], iconAnchor: [14, 14], className: ''
  });
}

const defaultTowerIcon = makeTowerIcon(null, '#FF6B35', -1);

function togglePlaceMode() {
  if (ignitionMode) toggleIgnitionMode();
  placeMode = !placeMode;
  const btn = document.getElementById('btn-place');
  const tip = document.getElementById('map-tooltip');
  if (placeMode) {
    btn.classList.add('active');
    btn.textContent = '\u{1f5fc} PLACING -- Click Map';
    tip.textContent = 'Click map to place tower';
    tip.classList.remove('hidden');
    map.getContainer().style.cursor = 'crosshair';
  } else {
    btn.classList.remove('active');
    btn.textContent = '\u{1f5fc} Place Tower Mode';
    tip.classList.add('hidden');
    map.getContainer().style.cursor = '';
  }
}

function toggleIgnitionMode() {
  if (placeMode) togglePlaceMode();
  ignitionMode = !ignitionMode;
  const btn = document.getElementById('btn-ignition');
  const tip = document.getElementById('map-tooltip');
  if (ignitionMode) {
    btn.classList.add('active');
    btn.textContent = '\u{1f525} CLICK MAP to set fire';
    tip.textContent = 'Click map to set ignition point';
    tip.classList.remove('hidden');
    map.getContainer().style.cursor = 'crosshair';
  } else {
    btn.classList.remove('active');
    btn.textContent = '\u{1f525} Set Ignition Point';
    tip.classList.add('hidden');
    map.getContainer().style.cursor = '';
  }
}

map.on('click', function(e) {
  if (placeMode) {
    addTower(e.latlng.lat, e.latlng.lng);
  } else if (ignitionMode) {
    setIgnitionPoint(e.latlng.lat, e.latlng.lng);
    toggleIgnitionMode();
  }
});

function addTower(lat, lng) {
  const id = Date.now() + Math.random();
  const marker = L.marker([lat, lng], { icon: defaultTowerIcon, draggable: true })
    .bindPopup('<b>HydroDome Tower</b><br>200 GPM @ 70 PSI<br>40m radius (80m dia)<br><button onclick="removeTower(' + id + ')" style="margin-top:6px;padding:4px 10px;background:#c0392b;color:#fff;border:none;border-radius:4px;cursor:pointer;">Remove</button>')
    .addTo(layers.towers);

  marker.on('contextmenu', function() { removeTower(id); });
  marker.on('dragend', function() { updateCoverage(); updateStats(); });

  const circle = L.circle([lat, lng], {
    radius: getSprinklerRadius(), color: '#2D5016', fillColor: '#2D5016',
    fillOpacity: 0.15, weight: 2, opacity: 0.6
  }).addTo(layers.coverage);

  marker.on('drag', function(e) { circle.setLatLng(e.latlng); });

  towers.push({ id: id, marker: marker, circle: circle, lat: lat, lng: lng });
  simulated = false;
  updateCoverage();
  updateStats();
  updateCostOverlay();
}

function removeTower(id) {
  const idx = towers.findIndex(function(t) { return t.id === id; });
  if (idx === -1) return;
  const t = towers[idx];
  layers.towers.removeLayer(t.marker);
  layers.coverage.removeLayer(t.circle);
  towers.splice(idx, 1);
  simulated = false;
  updateCoverage();
  updateStats();
  updateCostOverlay();
}

// ===================== COVERAGE =====================
function updateCoverage() {
  let covered = 0;
  buildings.forEach(function(b, i) {
    const isCovered = towers.some(function(t) {
      const tPos = t.marker.getLatLng();
      // V17: Use correct spray radius from sprinkler type (not pump map)
      const sprayRadius = getSprinklerRadius(); // BG150 = 70m, not 40m
      const dist = haversine([tPos.lat, tPos.lng], [b.lat, b.lng]);
      return dist <= sprayRadius;
    });
    if (isCovered) covered++;
    if (!timeSimRunning) {
      const rect = buildingRects[i];
      if (isCovered) {
        rect.setStyle({ color:'#3498db', fillColor:'#3498db', fillOpacity:0.5 });
        rect._protectionState = 'protected';
      } else {
        rect.setStyle({ color:'#888', fillColor:'#aaa', fillOpacity:0.5 });
        rect._protectionState = 'unprotected';
      }
    }
  });
  
  const pct = buildings.length > 0 ? Math.round(covered / buildings.length * 100) : 0;
  document.getElementById('cov-pct').textContent = pct + '%';
  document.getElementById('cov-pct').style.color = pct > 80 ? '#2ecc71' : pct > 50 ? '#f1c40f' : '#e74c3c';
  document.getElementById('stat-protected').textContent = covered + '/' + buildings.length + ' structures protected';
  const covSub = document.getElementById('cov-sub');
  if (covSub) {
    covSub.textContent = covered === 0 ? 'Place towers to protect' : covered + ' of ' + buildings.length + ' buildings';
  }
}

// ===================== COST VS DAMAGE OVERLAY =====================
function updateCostOverlay() {
  const n = towers.length;
  const cost = n * 134000;
  const costM = (cost / 1000000).toFixed(1);
  const damage = 500000000;
  const roi = cost > 0 ? Math.round(damage / cost) : 0;
  document.getElementById('cost-system').textContent = n === 0 ? '$0' : '$' + costM + 'M';
  document.getElementById('cost-roi').textContent = n === 0 ? '\u2014' : roi + ':1';
}

// ===================== ZONES =====================
function computeZones() {
  const MAX_ZONE_SIZE = 6;
  const assigned = new Set();
  const zones = [];
  towers.forEach(function(t, i) {
    if (assigned.has(i)) return;
    const zone = [i];
    assigned.add(i);
    towers.forEach(function(t2, j) {
      if (assigned.has(j)) return;
      if (zone.length >= MAX_ZONE_SIZE) return;
      const d = haversine(
        [t.marker.getLatLng().lat, t.marker.getLatLng().lng],
        [t2.marker.getLatLng().lat, t2.marker.getLatLng().lng]
      );
      if (d <= 200) { zone.push(j); assigned.add(j); }
    });
    zones.push(zone);
  });
  return zones;
}

// ===================== V8: DYNAMIC ZONE SUPPLY (Hazen-Williams) =====================
// Compute pipe capacity with configurable slope
function pipeCapacityGPM(diamMeters, slope) {
  const C = 120;
  const S = slope || getHydraulicSlope();
  const dInches = diamMeters * 39.37;
  return 0.2785 * C * Math.pow(dInches, 2.63) * Math.pow(S, 0.54);
}

// V10: Find the nearest pipe for a single lat/lng point
function findNearestPipe(latlng) {
  var bestPipe = waterMains[0];
  var bestDist = Infinity;
  waterMains.forEach(function(m) {
    for (var i = 0; i < m.pts.length; i++) {
      var d = haversine([latlng.lat, latlng.lng], m.pts[i]);
      if (d < bestDist) { bestDist = d; bestPipe = m; }
    }
  });
  return bestPipe;
}

// V9 compat: Find the nearest pipe for a zone (by its towers)
function findZoneNearestPipe(towerIndices) {
  var bestPipe = null;
  var bestDist = Infinity;
  towerIndices.forEach(function(ti) {
    var tPos = towers[ti].marker.getLatLng();
    waterMains.forEach(function(m) {
      m.pts.forEach(function(pt) {
        var d = haversine([tPos.lat, tPos.lng], pt);
        if (d < bestDist) { bestDist = d; bestPipe = m; }
      });
    });
  });
  return bestPipe;
}

// ===================== V3: FORCE ALL ON + FIRE TRIAGE + AUTO-ACTIVATE =====================
let forceAllOn = false;
let autoActivateEnabled = true;

function toggleForceAllOn() {
  forceAllOn = !forceAllOn;
  const btn = document.getElementById('btn-force-all');
  if (forceAllOn) {
    btn.style.background = '#e67e22';
    btn.style.color = '#fff';
    btn.style.boxShadow = '0 0 12px rgba(230,126,34,0.5)';
    btn.textContent = '‚ö° FORCE ALL: ON';
  } else {
    btn.style.background = 'transparent';
    btn.style.color = '#e67e22';
    btn.style.boxShadow = 'none';
    btn.textContent = '‚ö° Force All On';
  }
}

function toggleAutoActivate() {
  autoActivateEnabled = !autoActivateEnabled;
  const btn = document.getElementById('btn-auto-activate');
  if (autoActivateEnabled) {
    btn.style.borderColor = '#9b59b6';
    btn.style.color = '#9b59b6';
    btn.textContent = 'üéØ Auto-Activate: ON';
  } else {
    btn.style.borderColor = '#666';
    btn.style.color = '#666';
    btn.textContent = 'üéØ Auto-Activate: OFF';
  }
}

// V22: Multi-trigger activation - towers activate based on embers, fire front, or being in fire's path
function calcTowerFireProximity() {
  var proximities = [];
  if (!fireActive || !fireEllipse) {
    // No fire: return empty (no proximity sorting)
    for (var i = 0; i < towers.length; i++) proximities.push({ ti: i, dist: 99999, threatened: false, reasons: [] });
    return proximities;
  }

  // Calculate fire front position (leading edge)
  var windRad = windAngleDeg >= 0 ? windAngleDeg * Math.PI / 180 : 0;
  var frontLat = fireEllipse.centerLat + (fireEllipse.semiMajor * Math.cos(windRad)) / 111320;
  var frontLng = fireEllipse.centerLng + (fireEllipse.semiMajor * Math.sin(windRad)) / (111320 * Math.cos(fireEllipse.centerLat * Math.PI / 180));

  for (var ti = 0; ti < towers.length; ti++) {
    var tPos = towers[ti].marker.getLatLng();
    var minDist = 99999;
    var threatened = false;
    var reasons = [];
    
    // V25: Demo mode - Tighter activation thresholds (less trigger-happy)
    // TRIGGER 1: Ember proximity (50m - was 100m)
    var minEmberDist = 99999;
    for (var si = 0; si < spotFires.length; si++) {
      if (spotFires[si].merged) continue;
      var sfDist = haversine([tPos.lat, tPos.lng], [spotFires[si].lat, spotFires[si].lng]);
      if (sfDist < minEmberDist) minEmberDist = sfDist;
      
      if (sfDist < 50) { // Tighter: 50m (was 100m)
        threatened = true;
        reasons.push('ember');
        break;
      }
    }
    minDist = Math.min(minDist, minEmberDist);
    
    // TRIGGER 2: Fire front proximity (100m from leading edge - was 200m)
    var fireFrontDist = haversine([tPos.lat, tPos.lng], [frontLat, frontLng]);
    if (fireFrontDist < 100) { // Tighter: 100m (was 200m)
      threatened = true;
      if (reasons.indexOf('fire-front') < 0) reasons.push('fire-front');
    }
    minDist = Math.min(minDist, fireFrontDist);
    
    // TRIGGER 3: In fire's path (downwind cone, ¬±30 degrees from wind direction)
    // Calculate angle from fire center to tower
    var dx = (tPos.lng - fireEllipse.centerLng) * 111320 * Math.cos(fireEllipse.centerLat * Math.PI / 180);
    var dy = (tPos.lat - fireEllipse.centerLat) * 111320;
    var angleToTower = Math.atan2(dx, dy); // radians
    var angleDiff = Math.abs(angleToTower - windRad);
    
    // Normalize angle difference to [-PI, PI]
    while (angleDiff > Math.PI) angleDiff -= 2 * Math.PI;
    while (angleDiff < -Math.PI) angleDiff += 2 * Math.PI;
    angleDiff = Math.abs(angleDiff);
    
    // If tower is downwind (within 30 degree cone) and within 250m of fire center (was 500m)
    var distFromFireCenter = haversine([tPos.lat, tPos.lng], [fireEllipse.centerLat, fireEllipse.centerLng]);
    if (angleDiff < (30 * Math.PI / 180) && distFromFireCenter < 250 && distFromFireCenter > fireEllipse.semiMajor) { // Tighter: 250m (was 500m)
      threatened = true;
      if (reasons.indexOf('downwind') < 0) reasons.push('downwind');
    }
    minDist = Math.min(minDist, distFromFireCenter);

    proximities.push({ ti: ti, dist: minDist, threatened: threatened, reasons: reasons });
  }
  return proximities;
}

// V22: Extended zone activation - when a tower is threatened, nearby towers also activate
function checkAutoActivation() {
  if (!autoActivateEnabled || !fireActive || !timeSimRunning) return;
  if (!simZoneState || simZoneState.length === 0) return;

  var proximities = calcTowerFireProximity();
  var activatedTowers = new Set(); // Track which towers we've activated
  
  proximities.forEach(function(p) {
    if (p.threatened && simTowerState[p.ti]) {
      // Mark this tower's zone as needing activation
      var zoneIdx = simTowerState[p.ti].zoneIdx;
      if (simZoneState[zoneIdx]) {
        simZoneState[zoneIdx]._fireOverride = true;
        activatedTowers.add(p.ti);
      }
      
      // V25: Demo mode - Smaller extended zone (150m - was 250m, less trigger-happy)
      if (p.reasons.indexOf('ember') >= 0) {
        var emberTowerPos = towers[p.ti].marker.getLatLng();
        
        for (var ni = 0; ni < towers.length; ni++) {
          if (ni === p.ti || activatedTowers.has(ni)) continue; // Skip self and already activated
          
          var neighborPos = towers[ni].marker.getLatLng();
          var distToNeighbor = haversine([emberTowerPos.lat, emberTowerPos.lng], [neighborPos.lat, neighborPos.lng]);
          
          // Activate neighbors within 150m of ember-threatened tower (was 250m)
          if (distToNeighbor < 150 && simTowerState[ni]) {
            var neighborZoneIdx = simTowerState[ni].zoneIdx;
            if (simZoneState[neighborZoneIdx]) {
              simZoneState[neighborZoneIdx]._fireOverride = true;
              activatedTowers.add(ni);
            }
          }
        }
      }
    }
  });
}

// ===================== V10: HYDRAULIC CASCADE REFILL MODEL =====================
// 4-level constraint hierarchy:
//   L1: Cistern connection max (750 GPM per tower, 150mm service line)
//   L2: Distribution main (street pipe capacity shared among towers on that pipe)
//   L3: Trunk line (larger pipes feeding multiple street pipes - implicit via pipe hierarchy)
//   L4: Reservoir feed F1 (ultimate system bottleneck)
const CISTERN_CONNECTION_MAX_GPM = 750;

// Last cascade result for display
var lastCascadeResult = { totalDemand: 0, f1Capacity: 0, f1Bottleneck: false, pipeLoads: {} };

function calcRefillAllocations() {
  var slope = getHydraulicSlope();

  // F1 bottleneck (Level 4)
  var f1Pipe = waterMains.find(function(m) { return m.id === 'F1'; });
  var f1Capacity = f1Pipe ? pipeCapacityGPM(f1Pipe.diam, slope) * 0.60 : 99999;
  var systemBudget = f1Capacity;

  // Pipe capacities (Level 2/3)
  var pipeRemaining = {};
  waterMains.forEach(function(m) {
    pipeRemaining[m.id] = pipeCapacityGPM(m.diam, slope) * 0.60;
  });

  // Build demand list (Step 1)
  var demands = [];
  simTowerState.forEach(function(ts, ti) {
    ts._refillGPM = 0; // default
    ts._refillPipeId = '';
    var cisternPct = (ts.cisternGal / CISTERN_MAX) * 100;
    var need = Math.max(0, (95 - cisternPct) / 95);
    if (need <= 0) return;

    var nearestPipe = findNearestPipe(towers[ti].marker.getLatLng());
    ts._refillPipeId = nearestPipe.id;
    demands.push({ ti: ti, need: need, pipeId: nearestPipe.id, cisternPct: cisternPct });
  });

  // V3: Sort by fire proximity first, then need (fire-threatened towers get priority)
  var fireProx = calcTowerFireProximity();
  var proxMap = {};
  fireProx.forEach(function(p) { proxMap[p.ti] = p; });
  demands.sort(function(a, b) {
    var aProx = proxMap[a.ti] || { dist: 99999, threatened: false };
    var bProx = proxMap[b.ti] || { dist: 99999, threatened: false };
    // Threatened towers first
    if (aProx.threatened && !bProx.threatened) return -1;
    if (!aProx.threatened && bProx.threatened) return 1;
    // Among threatened, closest to fire first
    if (aProx.threatened && bProx.threatened) return aProx.dist - bProx.dist;
    // Among non-threatened, emptiest first (original behavior)
    return b.need - a.need;
  });

  // Allocate (Step 3) - priority cascade
  demands.forEach(function(d) {
    var wantGPM = d.need * CISTERN_CONNECTION_MAX_GPM;
    var pipeAvail = pipeRemaining[d.pipeId] || 0;
    var allocated = Math.min(wantGPM, CISTERN_CONNECTION_MAX_GPM, pipeAvail, systemBudget);
    allocated = Math.max(0, allocated);

    simTowerState[d.ti]._refillGPM = allocated;
    pipeRemaining[d.pipeId] = Math.max(0, (pipeRemaining[d.pipeId] || 0) - allocated);
    systemBudget -= allocated;
  });

  // Compute actual pipe loads for visualization
  var pipeLoads = {};
  waterMains.forEach(function(m) { pipeLoads[m.id] = 0; });
  simTowerState.forEach(function(ts, ti) {
    var pipeId = ts._refillPipeId || '';
    if (pipeId && pipeLoads[pipeId] !== undefined) {
      pipeLoads[pipeId] += (ts._refillGPM || 0);
      if (ts.active) {
        pipeLoads[pipeId] += (ts.pumpPct / 100) * getSprayGPM();
      }
    }
  });

  var totalDemand = f1Capacity - systemBudget;
  lastCascadeResult = {
    totalDemand: totalDemand,
    f1Capacity: f1Capacity,
    f1Bottleneck: systemBudget < 1,
    pipeLoads: pipeLoads,
    pipeRemaining: pipeRemaining
  };

  return lastCascadeResult;
}

// Legacy wrapper for stats display before sim
function calcAllZoneSupplies(zonesList) {
  if (!zonesList || zonesList.length === 0) return [];
  var zonePipes = zonesList.map(function(towerIndices) {
    return findZoneNearestPipe(towerIndices);
  });
  var pipeGroups = {};
  zonePipes.forEach(function(pipe, zi) {
    if (!pipe) return;
    if (!pipeGroups[pipe.id]) pipeGroups[pipe.id] = [];
    pipeGroups[pipe.id].push(zi);
  });
  var zoneSupplies = new Array(zonesList.length);
  for (var i = 0; i < zoneSupplies.length; i++) zoneSupplies[i] = 0;
  Object.keys(pipeGroups).forEach(function(pipeId) {
    var zonesOnPipe = pipeGroups[pipeId];
    var pipe = waterMains.find(function(m) { return m.id === pipeId; });
    if (!pipe) return;
    var pipeAvailable = pipeCapacityGPM(pipe.diam) * 0.60;
    var perZone = pipeAvailable / zonesOnPipe.length;
    zonesOnPipe.forEach(function(zi) { zoneSupplies[zi] = Math.round(perZone); });
  });
  var f1Pipe = waterMains.find(function(m) { return m.id === 'F1'; });
  var f1Cap = f1Pipe ? pipeCapacityGPM(f1Pipe.diam) * 0.60 : 99999;
  var totalDemand = 0;
  for (var i = 0; i < zoneSupplies.length; i++) totalDemand += zoneSupplies[i];
  if (totalDemand > f1Cap && totalDemand > 0) {
    var throttle = f1Cap / totalDemand;
    for (var i = 0; i < zoneSupplies.length; i++) zoneSupplies[i] = Math.round(zoneSupplies[i] * throttle);
  }
  return zoneSupplies;
}

function calcZoneSupplyGPM(towerIndices) {
  var pipe = findZoneNearestPipe(towerIndices);
  if (!pipe) return 0;
  return Math.round(pipeCapacityGPM(pipe.diam) * 0.60);
}

function recalcZoneSupply() {
  // V10: zone supply is now computed per-tower via cascade, but we keep zone-level info for display
  if (!simZoneState || !simZones) return;
  simZoneState.forEach(function(zs, zi) {
    zs.nearestPipeId = findZoneNearestPipe(zs.towerIndices) ? findZoneNearestPipe(zs.towerIndices).id : '?';
  });
}

// ===================== STATS =====================
function updateStats() {
  const n = towers.length;
  const zones = computeZones();
  const flowTotal = n * 200;
  const flowDuty = flowTotal * 0.5;
  const coverageHa = Math.min(n * 0.50, TOWN_AREA_HA * 1.2).toFixed(1);
  const costLow = n * 118000;
  const costHigh = n * 150000;

  document.getElementById('stat-towers').textContent = n;
  document.getElementById('stat-zones').textContent = zones.length;
  document.getElementById('stat-flow').textContent = flowDuty;
  document.getElementById('stat-coverage').textContent = coverageHa;
  // V13: Show cost in millions (not thousands)
  document.getElementById('stat-cost').textContent = n === 0 ? '$0' :
    '$' + (costLow/1000000).toFixed(2) + 'M\u2013' + (costHigh/1000000).toFixed(2) + 'M';

  // V9: Compute pipe-shared supply per zone
  var f1Pipe = waterMains.find(function(m) { return m.id === 'F1'; });
  var f1Cap = f1Pipe ? Math.round(pipeCapacityGPM(f1Pipe.diam) * 0.60) : 1200;
  const systemCapacity = f1Cap;
  const zoneSupplies = calcAllZoneSupplies(zones);
  let totalRefill = 0;
  zoneSupplies.forEach(function(s) { totalRefill += s; });

  const loadPct = n === 0 ? 0 : Math.min((totalRefill / systemCapacity) * 100, 150);
  const fill = document.getElementById('capacity-fill');
  const badge = document.getElementById('status-badge');
  const capLabel = document.getElementById('capacity-label');

  fill.style.width = Math.min(loadPct, 100) + '%';
  if (n === 0) {
    fill.style.background = '#2ecc71'; badge.className = 'status-badge status-green';
    badge.textContent = 'STANDBY'; capLabel.textContent = 'No towers placed';
  } else if (loadPct < 60) {
    fill.style.background = '#2ecc71'; badge.className = 'status-badge status-green';
    badge.textContent = 'ADEQUATE'; capLabel.textContent = 'Mains: ' + totalRefill + ' GPM (dynamic) / ' + systemCapacity + ' GPM capacity (' + loadPct.toFixed(0) + '%)';
  } else if (loadPct < 85) {
    fill.style.background = '#f1c40f'; badge.className = 'status-badge status-yellow';
    badge.textContent = 'MODERATE'; capLabel.textContent = 'Mains: ' + totalRefill + ' GPM (dynamic) / ' + systemCapacity + ' GPM capacity (' + loadPct.toFixed(0) + '%)';
  } else {
    fill.style.background = '#e74c3c'; badge.className = 'status-badge status-red';
    badge.textContent = 'HIGH LOAD'; capLabel.textContent = 'Mains: ' + totalRefill + ' GPM / ' + systemCapacity + ' GPM -- consider staging';
  }

  // Cistern info
  const CISTERN_GAL = 8000;
  const cisternDiv = document.getElementById('cistern-info');
  if (n === 0) {
    cisternDiv.innerHTML = 'Place towers to see cistern analysis.';
  } else {
    const totalStorage = n * CISTERN_GAL;
    const evacLabel = evacuationMode ? 'ON (S=0.01)' : 'OFF (S=0.005)';
    cisternDiv.innerHTML =
      '<div style="margin-bottom:6px;"><span style="color:#4da6ff;">&#x1f4a7; ' + n + ' x ' + (CISTERN_GAL/1000).toFixed(0) + 'k gal</span> = <b>' + (totalStorage/1000).toFixed(0) + 'k gal</b> total</div>' +
      '<div style="margin-bottom:4px;"><b>V8 Two-Phase Operation:</b></div>' +
      '<div style="margin-left:8px; margin-bottom:4px;"><b>Phase 1</b> (0-10 min): ALL towers spray at 200 GPM.<br><b>Phase 2</b> (10-180 min): 2 zones active at a time, rotating every 10 min.</div>' +
      '<div style="margin-bottom:4px;"><b>Refill:</b> <span style="color:#2ecc71;">Hydraulic Cascade (V10)</span></div>' +
      '<div style="margin-left:8px; margin-bottom:4px;">Evacuation Mode: <b>' + evacLabel + '</b><br>4-level cascade: cistern connection (750 GPM max), street pipe, trunk line, F1 feed.<br>Emptiest cisterns get priority. Towers >95% get zero refill.<br>Reservoir feed (F1, 250mm) caps total: <b>' + f1Cap + ' GPM</b><br>Total demand: <b>' + totalRefill + ' GPM</b>' + (totalRefill > f1Cap ? ' <span style="color:#e74c3c;">(THROTTLED by F1)</span>' : '') + '</div>' +
      '<div style="background:rgba(46,204,113,0.1);border:1px solid rgba(46,204,113,0.3);border-radius:6px;padding:8px;margin-top:6px;"><span style="color:#2ecc71;">&#x1f4a1;</span> <span style="font-size:11px;">V10 hydraulic cascade: each tower is allocated refill based on need priority, constrained by its pipe (150mm = ~' + Math.round(pipeCapacityGPM(0.15) * 0.6) + ' GPM, 200mm = ~' + Math.round(pipeCapacityGPM(0.20) * 0.6) + ' GPM at 60%), cistern connection (750 GPM), and F1 (10") system bottleneck.</span></div>';
  }

  // Duty cycle info
  if (!timeSimRunning) {
    const dutyDiv = document.getElementById('duty-info');
    if (n === 0) {
      dutyDiv.innerHTML = 'Place towers and run simulation to see duty cycle recommendations.';
    } else {
      const towersPerZone = zones.map(function(z) { return z.length; });
      const maxZone = Math.max.apply(null, towersPerZone);
      dutyDiv.innerHTML =
        '<b>' + n + ' towers</b> in <b>' + zones.length + ' zone(s)</b><br>' +
        'Full spray demand: ' + flowTotal + ' GPM<br>' +
        'With 50% duty cycling: <b>' + flowDuty + ' GPM</b><br>' +
        'Mains supply: <b style="color:#2ecc71;">' + totalRefill + ' GPM</b> (dynamic per zone)<br>' +
        zones.length + ' x Capstone C65 microturbine<br>' +
        'Max towers/zone: ' + maxZone + ' (target: 4-5)<br>' +
        (maxZone > 5 ? '<span style="color:#e74c3c;">Warning: Consider splitting zones</span>' : '<span style="color:#2ecc71;">Zone sizing OK</span>');
    }
  }
}

// ===================== HYDRAULIC SIMULATION (STATIC) =====================
function runSimulation() {
  if (towers.length === 0) { alert('Place some towers first!'); return; }
  const btn = document.getElementById('btn-sim');
  btn.textContent = 'Simulating...'; btn.disabled = true;
  setTimeout(function() {
    const C = 120;
    const S = getHydraulicSlope();
    pipePolylines.forEach(function(pl) {
      const m = pl._pipeData;
      const d = m.diam;
      const Qmax = 0.2785 * C * Math.pow(d, 2.63) * Math.pow(S, 0.54);
      const QmaxGPM = Qmax * 15850.3;
      var demandGPM = 0;
      towers.forEach(function(t) {
        const tPos = t.marker.getLatLng();
        const nearPipe = m.pts.some(function(p) { return haversine([tPos.lat, tPos.lng], p) < 150; });
        if (nearPipe) demandGPM += 100;
      });
      if (m.id === 'M1' || m.id === 'F1') demandGPM = towers.length * 100;
      const loadRatio = QmaxGPM > 0 ? demandGPM / QmaxGPM : 0;
      var color;
      if (loadRatio < 0.60) color = '#2ecc71';
      else if (loadRatio < 0.85) color = '#f1c40f';
      else color = '#e74c3c';
      pl.setStyle({ color: color, weight: m.diam >= 0.20 ? 5 : 3, opacity: 1 });
      pl.setTooltipContent(m.label + '<br>Capacity: ' + QmaxGPM.toFixed(0) + ' GPM<br>Demand: ' + demandGPM.toFixed(0) + ' GPM<br>Load: ' + (loadRatio * 100).toFixed(0) + '%');
    });
    simulated = true;
    btn.textContent = '\u26a1 Run Simulation'; btn.disabled = false;
    updateStats();
  }, 800);
}

// ===================== WIND =====================
let windAngleDeg = 225;
let windSpeedKmh = 25; // V16: Match UI default (BC fire weather pattern)

function updateWind() {
  windAngleDeg = parseInt(document.getElementById('wind-dir').value);
  windSpeedKmh = parseInt(document.getElementById('wind-speed').value);
  document.getElementById('wind-speed-val').textContent = windSpeedKmh + ' km/h';
  const arrow = document.getElementById('wind-arrow');
  if (windAngleDeg < 0 || windSpeedKmh === 0) {
    arrow.style.display = 'none';
  } else {
    arrow.style.display = 'flex';
    arrow.innerHTML = '<div style="transform:rotate(' + windAngleDeg + 'deg);font-size:24px;">&#x2b07;</div>';
  }
}
updateWind();

// ===================== SPRAY ELLIPSE GEOMETRY =====================
const PUMP_RADIUS_MAP = {100:40, 87:36, 75:33, 60:28, 50:24, 40:20, 30:16};
function getSprayRadius(pumpPct) {
  const keys = [100,87,75,60,50,40,30];
  for (var i = 0; i < keys.length - 1; i++) {
    if (pumpPct >= keys[i]) return PUMP_RADIUS_MAP[keys[i]];
    if (pumpPct >= keys[i+1]) {
      const f = (pumpPct - keys[i+1]) / (keys[i] - keys[i+1]);
      return PUMP_RADIUS_MAP[keys[i+1]] + f * (PUMP_RADIUS_MAP[keys[i]] - PUMP_RADIUS_MAP[keys[i+1]]);
    }
  }
  return 16;
}

function computeEllipsePoints(center, baseRadius, windAngle, windSpeed, numPts) {
  const pts = [];
  const n = numPts || 32;
  if (windSpeed <= 0 || windAngle < 0) {
    for (var i = 0; i < n; i++) {
      const a = (2 * Math.PI * i) / n;
      const dlat = baseRadius * Math.cos(a) / 111320;
      const dlng = baseRadius * Math.sin(a) / (111320 * Math.cos(center.lat * Math.PI / 180));
      pts.push([center.lat + dlat, center.lng + dlng]);
    }
    return pts;
  }
  const stretchFactor = 1 + (windSpeed / 30) * 0.15;
  const compressFactor = 1 - (windSpeed / 30) * 0.08;
  const semiMajor = baseRadius * stretchFactor;
  const semiMinor = baseRadius * compressFactor;
  const windRad = windAngle * Math.PI / 180;
  const offsetDist = (stretchFactor - 1) * baseRadius * 0.3;
  const cLat = center.lat + offsetDist * Math.cos(windRad) / 111320;
  const cLng = center.lng + offsetDist * Math.sin(windRad) / (111320 * Math.cos(center.lat * Math.PI / 180));

  for (var i = 0; i < n; i++) {
    const a = (2 * Math.PI * i) / n;
    const ex = semiMinor * Math.cos(a);
    const ey = semiMajor * Math.sin(a);
    const rx = ex * Math.cos(windRad) - ey * Math.sin(windRad);
    const ry = ex * Math.sin(windRad) + ey * Math.cos(windRad);
    const dlat = ry / 111320;
    const dlng = rx / (111320 * Math.cos(center.lat * Math.PI / 180));
    pts.push([cLat + dlat, cLng + dlng]);
  }
  return pts;
}

// ===================== RESERVOIR MODEL =====================
const RESERVOIR_MAX_GAL = 343000;
const SOURCE_INFLOW_GPM = 5000; // V25: Demo mode - 6x faster municipal refill (was 800)
let reservoirGal = RESERVOIR_MAX_GAL;

function initReservoirGauge() {
  const gauge = document.getElementById('reservoir-gauge');
  gauge.innerHTML = '<div class="res-gauge-inner"><div class="res-gauge-fill" id="res-fill" style="height:100%;"></div><div class="res-gauge-label" id="res-label">100%</div></div><div class="res-gauge-title">Reservoir</div>';
  updateReservoirGaugePosition();
  map.on('move zoom', updateReservoirGaugePosition);
}

function updateReservoirGaugePosition() {
  const gauge = document.getElementById('reservoir-gauge');
  const pt = map.latLngToContainerPoint([reservoir.lat, reservoir.lng]);
  gauge.style.left = (pt.x + 20) + 'px';
  gauge.style.top = (pt.y - 50) + 'px';
}

function updateReservoirGauge() {
  const pct = Math.max(0, Math.min(100, (reservoirGal / RESERVOIR_MAX_GAL) * 100));
  const fill = document.getElementById('res-fill');
  const label = document.getElementById('res-label');
  if (!fill) return;
  fill.style.height = pct + '%';
  if (pct > 60) fill.style.background = 'linear-gradient(to top, #3498db, #5dade2)';
  else if (pct > 30) fill.style.background = 'linear-gradient(to top, #f1c40f, #f39c12)';
  else fill.style.background = 'linear-gradient(to top, #e74c3c, #c0392b)';
  label.textContent = Math.round(pct) + '%';
}

initReservoirGauge();

// Sound disabled
function startSpraySound() {}
function stopSpraySound() {}
function updateSoundLevels() {}

// ===================== TIME SIMULATION ENGINE =====================
const ZONE_COLORS = ['#3498db', '#2ecc71', '#9b59b6', '#FF6B35'];
const PUMP_LEVELS = [100, 87, 60, 40, 30];
const CISTERN_MAX = 8000;
// getSprayGPM() is now dynamic based on sprinkler type
function getSprayGPM() {
  return SPRINKLER_TYPES[currentSprinklerType].gpm;
}
const SIM_DURATION_MIN = 180;

let timeSimRunning = false;
let simSpeed = 1;
let timeSimPaused = false;
let simMinute = 0;
let simInterval = null;
let simTowerState = [];
let simZoneState = [];
let simZones = [];
let pulsePhase = 0;
// V8: sim-time rotation tracking
let simRotationAngle = 0;

function toggleTimeSim() {
  if (timeSimRunning) {
    if (timeSimPaused) { resumeTimeSim(); } else { pauseTimeSim(); }
    return;
  }
  startTimeSim();
}

function startTimeSim() {
  if (towers.length === 0) { alert('Place some towers first!'); return; }
  timeSimRunning = true;
  timeSimPaused = false;
  simMinute = 0;
  pulsePhase = 0;
  simRotationAngle = 0;
  reservoirGal = RESERVOIR_MAX_GAL;

  simZones = computeZones();

  manualTriage = {};
  var initSupplies = calcAllZoneSupplies(simZones);
  simZoneState = simZones.map(function(towerIndices, zi) {
    return {
      phase: 'spray',
      minutesInPhase: 0,
      towerIndices: towerIndices,
      manualOverride: null,
      supplyGPM: initSupplies[zi] || 0,
      nearestPipeId: findZoneNearestPipe(towerIndices) ? findZoneNearestPipe(towerIndices).id : '?'
    };
  });

  simTowerState = towers.map(function(t, ti) {
    const zi = simZones.findIndex(function(z) { return z.includes(ti); });
    return {
      active: true,
      pumpPct: PUMP_LEVELS[ti % PUMP_LEVELS.length],
      cisternGal: CISTERN_MAX,
      sprayLayer: null,
      inactiveRing: null,
      zoneIdx: zi
    };
  });

  towers.forEach(function(t) { t.circle.setStyle({ opacity: 0, fillOpacity: 0 }); });

  document.getElementById('sim-clock').style.display = 'block';
  document.getElementById('speed-controls').style.display = 'block';
  setSimSpeed(1);
  document.getElementById('timeline-bar').style.display = 'block';
  document.getElementById('duty-section').style.display = 'none';
  document.getElementById('sim-live-section').style.display = 'block';
  document.getElementById('zone-triage-section').style.display = 'block';
  document.getElementById('reservoir-gauge').style.display = 'block';
  if (ignitionPoint) document.getElementById('fire-section').style.display = 'block';
  updateTriagePanel();
  document.getElementById('btn-timesim').textContent = '\u23f8 Pause';
  document.getElementById('btn-timesim').className = 'btn btn-danger';
  document.getElementById('legend').style.bottom = '65px';

  if (ignitionPoint) startFire();
  startSpraySound();
  simTick();
  simInterval = setInterval(simTick, 500);
}

function pauseTimeSim() {
  timeSimPaused = true;
  clearInterval(simInterval);
  document.getElementById('btn-timesim').textContent = '\u25b6 Resume';
  document.getElementById('btn-timesim').className = 'btn btn-timesim';
  stopSpraySound();
}

function resumeTimeSim() {
  timeSimPaused = false;
  simInterval = setInterval(simTick, 500);
  document.getElementById('btn-timesim').textContent = '\u23f8 Pause';
  document.getElementById('btn-timesim').className = 'btn btn-danger';
  startSpraySound();
}

function stopTimeSim() {
  timeSimRunning = false;
  timeSimPaused = false;
  clearInterval(simInterval);

  layers.simSpray.clearLayers();
  simTowerState.forEach(function(s) { s.sprayLayer = null; s.inactiveRing = null; });

  towers.forEach(function(t) {
    t.marker.setIcon(defaultTowerIcon);
    t.circle.setStyle({ opacity: 0.6, fillOpacity: 0.15 });
  });

  buildingRects.forEach(function(rect) {
    rect.setStyle({ color:'#888', fillColor:'#aaa', fillOpacity:0.5 });
    rect._protectionState = 'unprotected';
  });

  updatePipeLoads(0);
  clearFireVisuals();

  document.getElementById('sim-clock').style.display = 'none';
  document.getElementById('timeline-bar').style.display = 'none';
  document.getElementById('duty-section').style.display = 'block';
  document.getElementById('sim-live-section').style.display = 'none';
  document.getElementById('zone-triage-section').style.display = 'none';
  document.getElementById('fire-section').style.display = 'none';
  document.getElementById('reservoir-gauge').style.display = 'none';
  document.getElementById('btn-timesim').textContent = '\u25b6 Run Time Simulation';
  document.getElementById('btn-timesim').className = 'btn btn-timesim';
  document.getElementById('speed-controls').style.display = 'none';
  document.getElementById('legend').style.bottom = '20px';

  stopSpraySound();
  updateStats();
  updateCoverage();
}

// ===== PIPE LOAD MODEL =====
function updatePipeLoads(totalMainsDemand) {
  if (!timeSimRunning) {
    pipePolylines.forEach(function(pl) {
      if (pl._loadColored) {
        pl.setStyle({ color: pl._origColor, weight: pl._origWeight, opacity: 0.8, dashArray: null });
        pl._loadColored = false;
        var m = pl._pipeData;
        pl.unbindTooltip();
        pl.bindTooltip(m.label + '<br>&Oslash;' + Math.round(m.diam*39.37) + '"', { className:'pipe-tooltip' });
      }
    });
    return;
  }

  pipePolylines.forEach(function(pl) {
    const m = pl._pipeData;
    const capacity = pipeCapacityGPM(m.diam);

    // V10: Use actual cascade-computed pipe loads
    var pipeLoad = (lastCascadeResult.pipeLoads && lastCascadeResult.pipeLoads[m.id]) || 0;

    // F1 carries total system demand
    if (m.id === 'F1') {
      pipeLoad = Math.max(pipeLoad, lastCascadeResult.totalDemand || 0);
    }
    // Trunk lines near reservoir carry proportional load
    var pipeMidIdx = Math.floor(m.pts.length / 2);
    var pipeMid = m.pts[pipeMidIdx];
    var distToRes = haversine(pipeMid, [reservoir.lat, reservoir.lng]);
    if (distToRes < 300 && m.diam >= 0.20 && m.id !== 'F1') {
      pipeLoad = Math.max(pipeLoad, (lastCascadeResult.totalDemand || 0) * 0.6);
    }

    const loadPct = capacity > 0 ? (pipeLoad / capacity) * 100 : 0;
    var color, weight;
    if (loadPct < 50) {
      color = '#2ecc71'; weight = m.diam >= 0.20 ? 5 : 3;
    } else if (loadPct < 80) {
      color = '#f1c40f'; weight = m.diam >= 0.20 ? 6 : 4;
    } else {
      color = '#e74c3c'; weight = m.diam >= 0.20 ? 7 : 5;
    }

    pl.setStyle({ color: color, weight: weight, opacity: 0.9 });
    pl._loadColored = true;

    pl.unbindTooltip();
    var statusText = loadPct < 50 ? 'OK' : loadPct < 80 ? 'Moderate' : 'High Load';
    pl.bindTooltip(
      m.label + '<br>&Oslash;' + (m.diam*1000).toFixed(0) + 'mm -- Capacity: ' + Math.round(capacity) + ' GPM<br>' +
      'Load: ' + Math.round(pipeLoad) + ' GPM (' + Math.round(loadPct) + '%) ' + statusText,
      { className: 'pipe-tooltip', sticky: true }
    );
  });
}

function simTick() {
  if (simMinute >= SIM_DURATION_MIN) {
    stopTimeSim();
    return;
  }

  pulsePhase += 0.15;
  // V8: advance sim rotation (30 sim-seconds per revolution)
  // Each tick = 0.5 real seconds, advances simSpeed sim-minutes
  // simSpeed minutes per tick, so sim-seconds per tick = simSpeed * 60 * 0.5 ... no
  // Actually each tick is 0.5 real seconds and advances simSpeed sim-minutes
  // So sim-seconds per tick = simSpeed * 60
  // Wait no: simMinute advances by simSpeed each tick (at bottom). Tick interval = 500ms.
  // So 1 tick = simSpeed sim-minutes = simSpeed * 60 sim-seconds
  // 30 sim-seconds per revolution = 2*PI radians
  // Per tick: (simSpeed * 60 / 30) * 2*PI radians... that's way too fast
  // Actually: tick happens every 500ms real time, advancing simSpeed minutes of sim time
  // But simSpeed=1 means 1 sim-minute per tick (per 0.5 real seconds) which is 120x real time
  // Hmm, let me re-examine. At simSpeed=1, tick every 500ms advances simMinute by 1.
  // So 1 real second = 2 sim-minutes. That's already accelerated.
  // The rotation should be 30 sim-seconds per revolution.
  // Per tick at simSpeed=1: 1 sim-minute = 60 sim-seconds. Fraction of revolution = 60/30 = 2 full revolutions per tick.
  // That's very fast. Let me use a more reasonable rotation: tied to simMinute directly.
  // angle = (simMinute * 60 / 30) * 2 * PI = simMinute * 4 * PI
  // Actually let's just compute from simMinute and keep it smooth
  simRotationAngle += (simSpeed * 60 / 30) * (2 * Math.PI) * 0.5;
  // Hmm this is per tick (500ms). At simSpeed=1, per 500ms we advance 1 sim-minute = 60 sim-sec.
  // fraction of revolution per tick = 60/30 = 2 revolutions. That's 2 full spins per tick. Way too fast visually.
  // The issue is the sim itself runs 1 min per tick at speed 1, so everything is 120x real time.
  // Let's just make rotation look good: tie it to real time * simSpeed for the canvas animation,
  // and use simMinute for the Leaflet polygons.
  // We'll handle rotation in the canvas drawSprayAnimation function using performance.now() * simSpeed.

  const totalZones = simZones.length;

  simZoneState.forEach(function(zs, zi) {
    if (zs.manualOverride) {
      zs.phase = zs.manualOverride;
      return;
    }
    // V3: Force All On overrides everything
    if (forceAllOn) {
      zs.phase = 'spray';
      return;
    }
    
    // V20: When auto-activate is ON, zones ONLY spray when embers nearby (no duty cycling)
    if (autoActivateEnabled) {
      // Default to refill (OFF) - only spray when fire detected
      zs.phase = 'refill';
      // Check if this zone has fire override (set by checkAutoActivation)
      if (zs._fireOverride) {
        zs.phase = 'spray';
        zs._fireOverride = false; // Clear flag after applying
      }
    } else {
      // Auto-activate OFF: use traditional duty cycling
      if (simMinute < 10) {
        zs.phase = 'spray';
      } else {
        const relayMinute = simMinute - 10;
        const cyclePosition = Math.floor(relayMinute / 10);
        const activeZone1 = (cyclePosition * 2) % totalZones;
        const activeZone2 = (cyclePosition * 2 + 1) % totalZones;
        if (zi === activeZone1 || zi === activeZone2) {
          zs.phase = 'spray';
        } else {
          zs.phase = 'refill';
        }
      }
    }
  });

  const pulseOpacity = 0.15 + 0.15 * (0.5 + 0.5 * Math.sin(pulsePhase));
  let totalMainsDemand = 0;

  // V3: Check for auto-activation of towers near fire
  checkAutoActivation();

  // V10: Hydraulic cascade refill allocation (replaces V9 zone-level pipe sharing)
  // First set active/inactive state for all towers (needed before cascade calc)
  simTowerState.forEach(function(ts, ti) {
    const zs = simZoneState[ts.zoneIdx];
    const towersInZone = zs.towerIndices;
    const posInZone = towersInZone.indexOf(ti);
    const cycleMin = Math.floor(simMinute);
    const levelIdx = (posInZone + cycleMin) % PUMP_LEVELS.length;
    const zoneActive = zs.phase === 'spray';

    if (zoneActive && ts.cisternGal > 0) {
      ts.active = true;
      ts.pumpPct = PUMP_LEVELS[levelIdx];
    } else {
      ts.active = false;
      ts.pumpPct = 0;
    }
  });

  // Run the 4-level hydraulic cascade
  var cascadeResult = calcRefillAllocations();
  totalMainsDemand = cascadeResult.totalDemand;

  // Update zone supply display values from tower-level allocations
  simZoneState.forEach(function(zs, zi) {
    var zoneRefill = 0;
    zs.towerIndices.forEach(function(ti) { zoneRefill += (simTowerState[ti]._refillGPM || 0); });
    zs.supplyGPM = Math.round(zoneRefill);
  });

  // Apply refill and drain per tower
  simTowerState.forEach(function(ts, ti) {
    var refillGPM = ts._refillGPM || 0;

    if (ts.active && ts.cisternGal > 0) {
      var drainGPM = (ts.pumpPct / 100) * getSprayGPM();
      var netChange = refillGPM - drainGPM;
      ts.cisternGal = Math.max(0, Math.min(CISTERN_MAX, ts.cisternGal + netChange * simSpeed));
      if (ts.cisternGal <= 0) {
        ts.active = false;
        ts.pumpPct = 0;
      }
    } else {
      // Not spraying: just refill
      ts.cisternGal = Math.min(CISTERN_MAX, ts.cisternGal + refillGPM * simSpeed);
    }

    const zoneColor = ts.active ? ZONE_COLORS[ts.zoneIdx % ZONE_COLORS.length] : '#666';
    const cisternPct = Math.round(ts.cisternGal / CISTERN_MAX * 100);
    towers[ti].marker.setIcon(makeTowerIcon('', zoneColor, cisternPct));

    const tPos = towers[ti].marker.getLatLng();
    if (ts.sprayLayer) { layers.simSpray.removeLayer(ts.sprayLayer); ts.sprayLayer = null; }
    if (ts.inactiveRing) { layers.simSpray.removeLayer(ts.inactiveRing); ts.inactiveRing = null; }

    if (ts.active && ts.pumpPct > 0) {
      const radius = getSprayRadius(ts.pumpPct);
      const pts = computeEllipsePoints(tPos, radius, windAngleDeg, windSpeedKmh, 32);
      ts.sprayLayer = L.polygon(pts, {
        color: ZONE_COLORS[ts.zoneIdx % ZONE_COLORS.length],
        fillColor: '#3498db',
        fillOpacity: pulseOpacity,
        weight: 2, opacity: 0.6
      });
      layers.simSpray.addLayer(ts.sprayLayer);
    } else {
      const pts = computeEllipsePoints(tPos, 40, -1, 0, 32);
      ts.inactiveRing = L.polygon(pts, {
        color: '#888', fillColor: 'transparent', fillOpacity: 0,
        weight: 1.5, opacity: 0.4, dashArray: '6,4'
      });
      layers.simSpray.addLayer(ts.inactiveRing);
    }
  });

  updatePipeLoads(totalMainsDemand);

  const netFlow = SOURCE_INFLOW_GPM - totalMainsDemand;
  reservoirGal = Math.max(0, Math.min(RESERVOIR_MAX_GAL, reservoirGal + netFlow * simSpeed));
  updateReservoirGauge();
  updateReservoirGaugePosition();

  updateBuildingProtection();
  if (fireActive) fireSimTick();
  updateSoundLevels();

  const totalMin = Math.floor(simMinute);
  const hh = Math.floor(totalMin / 60);
  const mm = totalMin % 60;
  const ss = Math.floor((simMinute % 1) * 60);
  const phaseTag = simMinute < 10 ? 'P1: SATURATION' : 'P2: RELAY';
  const evacTag = evacuationMode ? ' EVAC' : '';
  document.getElementById('sim-clock').textContent = 'T+' + hh + ':' + String(mm).padStart(2,'0') + ':' + String(ss).padStart(2,'0') + '  [' + simSpeed + 'x]  ' + phaseTag + evacTag;

  const pct = (simMinute / SIM_DURATION_MIN) * 100;
  document.getElementById('tl-fill').style.width = pct + '%';
  document.getElementById('tl-playhead').style.left = pct + '%';

  updateSimPanel();
  updateTriagePanel();
  if (scadaVisible) updateSCADAPanel();

  simMinute += simSpeed;
}

function setSimSpeed(speed) {
  simSpeed = speed;
  var slider = document.getElementById('speed-slider');
  if (slider) slider.value = speedToSlider(speed);
  updateSpeedLabel();
}

function sliderToSpeed(val) {
  val = Number(val);
  if (val <= 0) return 1;
  return Math.round(Math.pow(10, val / 50) * 10) / 10;
}

function speedToSlider(speed) {
  if (speed <= 1) return 0;
  return Math.round(50 * Math.log10(speed));
}

function setSimSpeedFromSlider(val) {
  simSpeed = sliderToSpeed(val);
  updateSpeedLabel();
}

function updateSpeedLabel() {
  var label = document.getElementById('speed-label');
  if (label) {
    var display = simSpeed >= 10 ? Math.round(simSpeed) + 'x' : simSpeed.toFixed(1).replace(/\.0$/, '') + 'x';
    label.textContent = display;
  }
}

// ===================== BUILDING PROTECTION STATUS =====================
function updateBuildingProtection() {
  var protectedCount = 0;
  buildings.forEach(function(b, i) {
    const rect = buildingRects[i];
    var isProtected = false;
    simTowerState.forEach(function(ts, ti) {
      if (!ts.active || ts.pumpPct <= 0) return;
      const tPos = towers[ti].marker.getLatLng();
      const radius = getSprayRadius(ts.pumpPct);
      var effectiveRadius = radius;
      if (windSpeedKmh > 0 && windAngleDeg >= 0) {
        effectiveRadius = radius * (1 + (windSpeedKmh / 30) * 0.15);
      }
      if (haversine([tPos.lat, tPos.lng], [b.lat, b.lng]) <= effectiveRadius) isProtected = true;
    });

    var isInFireZone = false;
    if (fireActive && fireEllipse) {
      isInFireZone = isPointInFireZone(b.lat, b.lng);
    }

    if (isProtected) {
      rect.setStyle({ color:'#3498db', fillColor:'#3498db', fillOpacity: 0.4 + 0.3 * (0.5 + 0.5 * Math.sin(pulsePhase)) });
      rect._protectionState = 'protected';
      protectedCount++;
    } else if (isInFireZone) {
      rect.setStyle({ color:'#e74c3c', fillColor:'#e74c3c', fillOpacity:0.7 });
      rect._protectionState = 'atrisk';
    } else {
      rect.setStyle({ color:'#888', fillColor:'#aaa', fillOpacity:0.5 });
      rect._protectionState = 'unprotected';
    }
  });
  document.getElementById('stat-protected').textContent = protectedCount + '/' + buildings.length + ' structures protected';
}

// ===================== ZONE TRIAGE =====================
let manualTriage = {};

function toggleZoneTriage(zoneIdx) {
  if (!timeSimRunning || !simZoneState[zoneIdx]) return;
  const zs = simZoneState[zoneIdx];
  if (zs.manualOverride === null) { zs.manualOverride = 'spray'; }
  else if (zs.manualOverride === 'spray') { zs.manualOverride = 'refill'; }
  else { zs.manualOverride = null; }
  updateTriagePanel();
}

function updateTriagePanel() {
  if (!timeSimRunning || !simZoneState) return;
  const panel = document.getElementById('zone-triage-panel');
  var html = '<div style="margin-bottom:6px;font-size:11px;color:#aaa;">Click to cycle: AUTO > SPRAY > OFF > AUTO</div>';
  simZoneState.forEach(function(zs, zi) {
    const color = ZONE_COLORS[zi % ZONE_COLORS.length];
    var modeText, modeColor, modeIcon;
    if (zs.manualOverride === null) { modeText='AUTO'; modeColor='#aaa'; modeIcon='\u{1f504}'; }
    else if (zs.manualOverride === 'spray') { modeText='FORCE ON'; modeColor=color; modeIcon='\u{1f525}'; }
    else { modeText='FORCE OFF'; modeColor='#666'; modeIcon='\u23f9'; }
    var supplyLabel = zs.supplyGPM ? ' | ' + zs.supplyGPM + ' GPM' : '';
    var pipeLabel = zs.nearestPipeId ? ' [' + zs.nearestPipeId + ']' : '';
    // V10: Per-tower refill rates
    var towerRefillHtml = '';
    zs.towerIndices.forEach(function(ti) {
      var ts = simTowerState[ti];
      var rGPM = Math.round(ts._refillGPM || 0);
      var pId = ts._refillPipeId || '?';
      var cPct = Math.round((ts.cisternGal / CISTERN_MAX) * 100);
      var cColor = cPct > 60 ? '#3498db' : cPct > 30 ? '#f1c40f' : '#e74c3c';
      towerRefillHtml += '<div style="font-size:10px;color:#aaa;margin-left:20px;">T' + (ti+1) + ': ' + rGPM + ' GPM from [' + pId + '] <span style="color:' + cColor + ';">' + cPct + '%</span></div>';
    });
    html += '<button onclick="toggleZoneTriage(' + zi + ')" style="display:flex; align-items:center; gap:8px; width:100%;padding:6px 10px; margin:4px 0; border:1px solid ' + color + '40;border-radius:6px; background:' + (zs.manualOverride === 'spray' ? color + '20' : 'rgba(255,255,255,0.03)') + ';cursor:pointer; color:#e0e0e0; font-size:12px; text-align:left;">' +
      '<div style="width:12px;height:12px;border-radius:50%;background:' + color + ';flex-shrink:0;' + (zs.manualOverride==='refill'?'opacity:0.3':'') + '"></div>' +
      '<span style="flex:1;">Zone ' + (zi+1) + ' (' + zs.towerIndices.length + 't' + supplyLabel + pipeLabel + ')</span>' +
      '<span style="color:' + modeColor + ';font-weight:600;">' + modeIcon + ' ' + modeText + '</span></button>';
    html += towerRefillHtml;
  });
  panel.innerHTML = html;
}

function seekTimeline(e) {
  if (!timeSimRunning) return;
  const bar = document.getElementById('timeline-bar');
  const rect = bar.getBoundingClientRect();
  const pct = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
  simMinute = Math.floor(pct * SIM_DURATION_MIN);
  simTowerState.forEach(function(ts) { ts.cisternGal = CISTERN_MAX * 0.6; });
}

function updateSimPanel() {
  const panel = document.getElementById('sim-live-panel');
  var totalFlow = 0, totalCistern = 0;
  simTowerState.forEach(function(ts) {
    if (ts.active) totalFlow += (ts.pumpPct / 100) * getSprayGPM();
    totalCistern += ts.cisternGal;
  });
  const avgCisternPct = towers.length > 0 ? Math.round(totalCistern / (towers.length * CISTERN_MAX) * 100) : 0;
  var totalMainsRefill = 0;
  simZoneState.forEach(function(zs) { totalMainsRefill += (zs.supplyGPM || 0); });
  var f1PipeRef = waterMains.find(function(m) { return m.id === 'F1'; });
  var f1CapDisplay = f1PipeRef ? Math.round(pipeCapacityGPM(f1PipeRef.diam) * 0.60) : 1200;

  var phaseLabel;
  if (simMinute < 10) {
    phaseLabel = '<div style="background:rgba(231,76,60,0.2);border:1px solid #e74c3c;border-radius:4px;padding:4px 8px;margin:4px 0;text-align:center;"><span style="color:#e74c3c;font-weight:700;">PHASE 1: INITIAL SATURATION</span><br><span style="font-size:10px;color:#aaa;">All zones spraying simultaneously | Dynamic refill per zone</span></div>';
  } else {
    const relayMin = simMinute - 10;
    const cyclePos = Math.floor(relayMin / 10);
    const tz = simZones.length;
    const az1 = (cyclePos * 2) % tz;
    const az2 = (cyclePos * 2 + 1) % tz;
    const nextRotation = 10 - (relayMin % 10);
    phaseLabel = '<div style="background:rgba(52,152,219,0.15);border:1px solid #3498db;border-radius:4px;padding:4px 8px;margin:4px 0;text-align:center;"><span style="color:#3498db;font-weight:700;">PHASE 2: ZONE RELAY</span><br><span style="font-size:10px;color:#aaa;">Active: Zone ' + (az1+1) + ' + Zone ' + (az2+1) + ' | Next rotation: ' + Math.ceil(nextRotation) + ' min</span></div>';
  }

  const panelHH = Math.floor(Math.floor(simMinute) / 60);
  const panelMM = Math.floor(simMinute) % 60;
  var html = '<div class="sim-stat-row"><span>Sim Time</span><span class="sim-stat-val" style="color:#3498db;">T+' + panelHH + ':' + String(panelMM).padStart(2,'0') + '</span></div>';
  html += phaseLabel;
  html += '<div style="margin:6px 0 4px;font-size:10px;color:#FF6B35;text-transform:uppercase;letter-spacing:1px;">Zone Status</div>';

  simZoneState.forEach(function(zs, zi) {
    const color = ZONE_COLORS[zi % ZONE_COLORS.length];
    const statusText = zs.phase === 'spray' ? 'SPRAYING' : 'REFILLING';
    const statusColor = zs.phase === 'spray' ? color : '#666';
    html += '<div class="sim-zone-row"><div class="sim-zone-dot" style="background:' + color + ';' + (zs.phase==='refill'?'opacity:0.4':'') + '"></div><span>Zone ' + (zi+1) + ':</span><span class="sim-zone-status" style="color:' + statusColor + '">' + statusText + '</span><span style="color:#888;font-size:10px;">(' + zs.towerIndices.length + 't, ' + (zs.supplyGPM||'?') + ' GPM)</span></div>';
  });

  const resPct = Math.round((reservoirGal / RESERVOIR_MAX_GAL) * 100);
  const systemCap = 1200;
  const mainsLoadPct = Math.round((totalMainsRefill / systemCap) * 100);
  const mainsColor = mainsLoadPct < 50 ? '#2ecc71' : mainsLoadPct < 80 ? '#f1c40f' : '#e74c3c';
  html += '<div style="margin-top:8px;border-top:1px solid rgba(255,255,255,0.1);padding-top:8px;">';
  html += '<div class="sim-stat-row"><span>Active Flow</span><span class="sim-stat-val">' + Math.round(totalFlow) + ' GPM</span></div>';
  var cascadeDemand = Math.round(lastCascadeResult.totalDemand || 0);
  var cascadeF1Cap = Math.round(lastCascadeResult.f1Capacity || f1CapDisplay);
  var cascadeBottleneck = lastCascadeResult.f1Bottleneck;
  var demandPctDisplay = cascadeF1Cap > 0 ? Math.round((cascadeDemand / cascadeF1Cap) * 100) : 0;
  var demandColor = demandPctDisplay < 60 ? '#2ecc71' : demandPctDisplay < 85 ? '#f1c40f' : '#e74c3c';
  html += '<div class="sim-stat-row"><span>System Demand</span><span class="sim-stat-val" style="color:' + demandColor + '">' + cascadeDemand + ' / ' + cascadeF1Cap + ' GPM (' + demandPctDisplay + '%)</span></div>';
  if (cascadeBottleneck) {
    html += '<div style="color:#e74c3c;font-size:10px;text-align:center;margin:2px 0;background:rgba(231,76,60,0.15);border:1px solid rgba(231,76,60,0.4);border-radius:4px;padding:3px;">F1 BOTTLENECK ACTIVE - cascade throttling all towers</div>';
  }
  html += '<div class="sim-stat-row"><span>Evacuation</span><span class="sim-stat-val" style="color:' + (evacuationMode ? '#e74c3c' : '#888') + '">' + (evacuationMode ? 'ON (S=0.01)' : 'OFF (S=0.005)') + '</span></div>';
  html += '<div class="sim-stat-row"><span>Reservoir</span><span class="sim-stat-val" style="color:' + (resPct>60?'#3498db':resPct>30?'#f1c40f':'#e74c3c') + '">' + resPct + '%</span></div>';
  html += '<div class="sim-stat-row"><span>Avg Cistern</span><span class="sim-stat-val">' + avgCisternPct + '% <span class="cistern-bar-mini"><span class="cistern-bar-mini-fill" style="width:' + avgCisternPct + '%;background:' + (avgCisternPct>30?'#3498db':'#e74c3c') + ';"></span></span></span></div>';
  html += '</div>';

  panel.innerHTML = html;
}

// ===================== FIRE MODELING =====================
let ignitionPoint = null;
let ignitionMarker = null;
let fireActive = false;
let fireEnabled = true;
let fireEllipse = null;
let fireLayer = null;
let emberMarkers = [];
let fireStartMinute = 0;

let spotFires = [];
let spotFireIdCounter = 0;
let spotFireLayers = [];
const SPOT_FIRE_IGNITION_PROB = 0.002; // V25: Demo mode - 5x less aggressive (was 0.01)
const MAX_SPOT_FIRES = 8;
const SPOT_FIRE_BASE_ROS = 0.3; // V25: Demo mode - 5x slower spot fire spread (was 1.5)

function setIgnitionPoint(lat, lng) {
  // Block ignition over water (simple lat/lng check)
  if (isOverWater(lat, lng)) {
    alert('‚ö†Ô∏è Cannot start fire over water!\n\nStuart Lake (northwest) is in the way. Please click on land.');
    return;
  }
  
  // V15: Block ignition in active spray zones (force field)
  if (timeSimRunning && simTowerState && simTowerState.length > 0) {
    for (var ti = 0; ti < simTowerState.length; ti++) {
      var ts = simTowerState[ti];
      if (ts.active && ts.pumpPct > 0) {
        const tPos = towers[ti].marker.getLatLng();
        const sprayRadius = getSprayRadius(ts.pumpPct);
        if (haversine([tPos.lat, tPos.lng], [lat, lng]) <= sprayRadius) {
          alert('‚ö†Ô∏è Cannot start fire in active spray zone!\n\nTower is currently spraying this area. Fire cannot penetrate the humidity dome.');
          return;
        }
      }
    }
  }
  
  if (ignitionMarker) map.removeLayer(ignitionMarker);
  ignitionPoint = { lat: lat, lng: lng };
  const fireIcon = L.divIcon({
    html:'<div style="font-size:24px;text-shadow:0 0 8px #ff4400;">&#x1f525;</div>',
    iconSize:[24,24], iconAnchor:[12,12], className:''
  });
  ignitionMarker = L.marker([lat, lng], { icon: fireIcon })
    .bindPopup('<b>Ignition Point</b><br>' + lat.toFixed(4) + 'N, ' + Math.abs(lng).toFixed(4) + 'W<br><button onclick="removeIgnition()" style="margin-top:4px;padding:3px 8px;background:#c0392b;color:#fff;border:none;border-radius:3px;cursor:pointer;">Remove</button>')
    .addTo(map);
  var btn = document.getElementById('btn-fire-toggle');
  btn.style.display = 'block';
  btn.style.borderColor = '#e74c3c';
  btn.style.color = '#e74c3c';
}

function removeIgnition() {
  if (ignitionMarker) { map.removeLayer(ignitionMarker); ignitionMarker = null; }
  ignitionPoint = null;
  clearFireVisuals();
  document.getElementById('btn-fire-toggle').style.display = 'none';
}

function toggleFireBehavior() {
  fireEnabled = !fireEnabled;
  var btn = document.getElementById('btn-fire-toggle');
  if (fireEnabled) {
    btn.textContent = '\u{1f525} Fire Model: ON';
    btn.style.borderColor = '#e74c3c';
    btn.style.color = '#e74c3c';
  } else {
    btn.textContent = '\u{1f525} Fire Model: OFF';
    btn.style.borderColor = '#666';
    btn.style.color = '#666';
    clearFireVisuals();
  }
}

function startFire() {
  if (!ignitionPoint) return;
  fireActive = true;
  fireStartMinute = simMinute;
  fireEllipse = {
    centerLat: ignitionPoint.lat,
    centerLng: ignitionPoint.lng,
    semiMajor: 10,
    semiMinor: 10,
    _blockedRays: null
  };
  document.getElementById('fire-section').style.display = 'block';
}

function clearFireVisuals() {
  fireActive = false;
  if (fireLayer) { layers.fire.removeLayer(fireLayer); fireLayer = null; }
  emberMarkers.forEach(function(m) { layers.fire.removeLayer(m); });
  emberMarkers = [];
  spotFireLayers.forEach(function(l) { layers.fire.removeLayer(l); });
  spotFireLayers = [];
  spotFires = [];
  spotFireIdCounter = 0;
}

function isPointInEllipse(lat, lng, cLat, cLng, semiMaj, semiMin, angle) {
  const dx = (lng - cLng) * 111320 * Math.cos(cLat * Math.PI / 180);
  const dy = (lat - cLat) * 111320;
  const cos = Math.cos(-angle);
  const sin = Math.sin(-angle);
  const rx = dx * cos - dy * sin;
  const ry = dx * sin + dy * cos;
  return (rx * rx) / ((semiMin || 1) * (semiMin || 1)) + (ry * ry) / ((semiMaj || 1) * (semiMaj || 1)) <= 1;
}

// ===================== FIRE POLYGON SMOOTHING =====================
// Chaikin's corner cutting algorithm - smooth polygon by iteratively replacing each edge
// with two smaller edges that cut the corners
function smoothPolygon(points, iterations) {
  if (!points || points.length < 3) return points;
  
  let smoothed = points.slice(); // Copy original points
  
  for (let iter = 0; iter < iterations; iter++) {
    const newPoints = [];
    const n = smoothed.length;
    
    for (let i = 0; i < n; i++) {
      const curr = smoothed[i];
      const next = smoothed[(i + 1) % n];
      
      // Calculate quarter points along the edge
      const q1 = [
        curr[0] * 0.75 + next[0] * 0.25,
        curr[1] * 0.75 + next[1] * 0.25
      ];
      const q2 = [
        curr[0] * 0.25 + next[0] * 0.75,
        curr[1] * 0.25 + next[1] * 0.75
      ];
      
      newPoints.push(q1, q2);
    }
    
    smoothed = newPoints;
  }
  
  return smoothed;
}

function fireSimTick() {
  if (!fireActive || !ignitionPoint || !fireEllipse || !fireEnabled) return;

  const speedMult = parseFloat(document.getElementById('fire-speed-mult').value) || 2;
  const minutesElapsed = simMinute - fireStartMinute;
  
  const baseROS = 0.4; // V25: Demo mode - 5x slower main fire (was 2.0)
  const windFactor = Math.exp(0.115 * windSpeedKmh);
  const spreadRate = baseROS * windFactor * speedMult;
  const lb_ratio = 1 + 0.25 * windSpeedKmh;
  const semiMajor = spreadRate * minutesElapsed;
  const semiMinor = semiMajor / lb_ratio;
  const windRad = windAngleDeg >= 0 ? windAngleDeg * Math.PI / 180 : 0;
  const centerShift = semiMajor * 0.3;
  const fireCenterLat = ignitionPoint.lat + (centerShift * Math.cos(windRad)) / 111320;
  const fireCenterLng = ignitionPoint.lng + (centerShift * Math.sin(windRad)) / (111320 * Math.cos(ignitionPoint.lat * Math.PI / 180));

  fireEllipse.centerLat = fireCenterLat;
  fireEllipse.centerLng = fireCenterLng;
  fireEllipse.semiMajor = semiMajor;
  fireEllipse.semiMinor = semiMinor;
  fireEllipse.angle = windRad;

  if (fireLayer) { layers.fire.removeLayer(fireLayer); fireLayer = null; }
  emberMarkers.forEach(function(m) { layers.fire.removeLayer(m); });
  emberMarkers = [];

  if (semiMajor < 5) return;

  const numRays = 120;
  const firePts = [];
  const cosLat = Math.cos(fireCenterLat * Math.PI / 180);

  if (!fireEllipse._blockedRays) {
    fireEllipse._blockedRays = new Float32Array(numRays);
  }
  if (!fireEllipse._maxExtent) {
    fireEllipse._maxExtent = new Float32Array(numRays);
  }
  // V12: Organic fire shape - persistent random variation per ray
  if (!fireEllipse._organicNoise) {
    fireEllipse._organicNoise = new Float32Array(numRays);
    for (var i = 0; i < numRays; i++) {
      fireEllipse._organicNoise[i] = 0.85 + Math.random() * 0.3; // 0.85 to 1.15
    }
  }
  // Evolve noise slowly (random walk) to simulate crawling over terrain
  for (var i = 0; i < numRays; i++) {
    const drift = (Math.random() - 0.5) * 0.02; // Small random walk
    fireEllipse._organicNoise[i] = Math.max(0.75, Math.min(1.25, fireEllipse._organicNoise[i] + drift));
  }
  const blockedRays = fireEllipse._blockedRays;
  const maxExtent = fireEllipse._maxExtent;
  const organicNoise = fireEllipse._organicNoise;

  for (var i = 0; i < numRays; i++) {
    const a = (2 * Math.PI * i) / numRays;
    const ex = fireEllipse.semiMinor * Math.cos(a);
    const ey = fireEllipse.semiMajor * Math.sin(a);
    const ellipseDist = Math.sqrt(ex * ex + ey * ey);
    
    // V12: Apply organic noise to simulate terrain/vegetation effects
    const organicDist = ellipseDist * organicNoise[i];
    const rx = ex * Math.cos(windRad) - ey * Math.sin(windRad);
    const ry = ex * Math.sin(windRad) + ey * Math.cos(windRad);

    var maxAdvance = organicDist;
    const steps = 20;

    for (var s = 1; s <= steps; s++) {
      const frac = s / steps;
      const checkRx = rx * frac;
      const checkRy = ry * frac;
      const checkLat = fireCenterLat + checkRy / 111320;
      const checkLng = fireCenterLng + checkRx / (111320 * cosLat);

      var inSpray = false;
      var inActiveSpray = false; // V15: Track if in ACTIVE spray (force field)
      
      if (timeSimRunning && simTowerState.length > 0) {
        for (var ti = 0; ti < simTowerState.length; ti++) {
          var ts = simTowerState[ti];
          const tPos = towers[ti].marker.getLatLng();
          const baseRadius = 40;
          const activeRadius = (ts.active && ts.pumpPct > 0) ? getSprayRadius(ts.pumpPct) : baseRadius;
          // V25: Demo mode - 5x larger force field zone for fire blocking (visual radius stays 70m)
          var effectiveRadius = (ts.active && ts.pumpPct > 0) ? activeRadius * 5.0 : activeRadius * 2.5;
          if (windSpeedKmh > 0 && windAngleDeg >= 0) effectiveRadius *= (1 + (windSpeedKmh / 30) * 0.15);
          if (haversine([tPos.lat, tPos.lng], [checkLat, checkLng]) <= effectiveRadius) {
            inSpray = true;
            // V15: Force field - active sprayers create impenetrable barrier
            if (ts.active && ts.pumpPct > 0) inActiveSpray = true;
            break;
          }
        }
      } else if (towers.length > 0) {
        for (var ti = 0; ti < towers.length; ti++) {
          const tPos = towers[ti].marker.getLatLng();
          var effectiveRadius = 40 * 2.5; // V25: Demo mode - placed towers also more effective
          if (windSpeedKmh > 0 && windAngleDeg >= 0) effectiveRadius *= (1 + (windSpeedKmh / 30) * 0.15);
          if (haversine([tPos.lat, tPos.lng], [checkLat, checkLng]) <= effectiveRadius) {
            inSpray = true; break;
          }
        }
      }

      // Check if ray hits water boundary
      if (isOverWater(checkLat, checkLng)) {
        maxAdvance = organicDist * frac * 0.95; // Stop just before water
        blockedRays[i] = Math.max(blockedRays[i], maxAdvance);
        break;
      }

      // V25: Demo mode - Active spray creates STRONGER FORCE FIELD (stops fire much earlier)
      if (inActiveSpray) {
        maxAdvance = organicDist * frac * 0.50; // Stop fire HALFWAY to spray boundary (was 0.99)
        blockedRays[i] = Math.max(blockedRays[i], maxAdvance);
        break;
      }

      // V25: Demo mode - Passive spray more effective
      if (inSpray) {
        maxAdvance = Math.max(organicDist * frac * 0.60, organicDist * 0.05); // Stronger passive effect (was 0.85)
        blockedRays[i] = Math.max(blockedRays[i], maxAdvance);
        break;
      }
    }

    if (blockedRays[i] > 0 && maxAdvance > blockedRays[i]) {
      const blockFrac = blockedRays[i] / organicDist;
      const bLat = fireCenterLat + (ry * blockFrac) / 111320;
      const bLng = fireCenterLng + (rx * blockFrac) / (111320 * cosLat);
      var stillBlocked = false;
      for (var ti = 0; ti < towers.length; ti++) {
        const tPos = towers[ti].marker.getLatLng();
        var radius = 40;
        if (timeSimRunning && simTowerState[ti] && simTowerState[ti].active && simTowerState[ti].pumpPct > 0) {
          radius = getSprayRadius(simTowerState[ti].pumpPct);
        }
        radius *= (1 + (windSpeedKmh > 0 ? (windSpeedKmh / 30) * 0.15 : 0));
        if (haversine([tPos.lat, tPos.lng], [bLat, bLng]) <= radius * 1.2) {
          stillBlocked = true; break;
        }
      }
      if (stillBlocked) {
        maxAdvance = blockedRays[i];
      } else {
        blockedRays[i] = 0;
      }
    }

    // FIRE PERSISTENCE: Once fire reaches a point, it doesn't retreat
    // Track maximum extent and ensure fire never shrinks below it
    maxExtent[i] = Math.max(maxExtent[i], maxAdvance);
    const persistentAdvance = maxExtent[i];
    
    // V12: Use organic distance for fraction calculation
    const advanceFrac = organicDist > 0 ? persistentAdvance / organicDist : 0;
    const finalRx = rx * advanceFrac;
    const finalRy = ry * advanceFrac;
    firePts.push([fireCenterLat + finalRy / 111320, fireCenterLng + finalRx / (111320 * cosLat)]);
  }

  // Smooth the fire polygon using Chaikin's corner cutting algorithm
  const smoothedPts = smoothPolygon(firePts, 2); // 2 iterations of smoothing
  
  fireLayer = L.polygon(smoothedPts, {
    color: '#ff4400',
    fillColor: '#ff4400',
    fillOpacity: 0.25 + 0.1 * Math.sin(pulsePhase * 2),
    weight: 3, opacity: 0.8,
  });
  layers.fire.addLayer(fireLayer);

  if (timeSimRunning && towers.length > 0) {
    const ghostPts = [];
    for (var i = 0; i < numRays; i++) {
      const a = (2 * Math.PI * i) / numRays;
      const ex = fireEllipse.semiMinor * Math.cos(a);
      const ey = fireEllipse.semiMajor * Math.sin(a);
      const grx = ex * Math.cos(windRad) - ey * Math.sin(windRad);
      const gry = ex * Math.sin(windRad) + ey * Math.cos(windRad);
      ghostPts.push([fireCenterLat + gry / 111320, fireCenterLng + grx / (111320 * cosLat)]);
    }
    const ghostLayer = L.polygon(ghostPts, {
      color: '#ff440044', fillColor: 'transparent', fillOpacity: 0,
      weight: 1.5, opacity: 0.3, dashArray: '8,6'
    });
    layers.fire.addLayer(ghostLayer);
    emberMarkers.push(ghostLayer);
  }

  const emberDist = 100 + (Math.exp(0.08 * windSpeedKmh) - 1) * 60; // V25: Demo mode - 5x shorter ember range (was 300)
  const numEmbers = Math.min(30, Math.floor(minutesElapsed / 2) + 3);
  const seededRand = (function() { var s = simMinute * 137 + 42; return function() { s = (s*16807)%2147483647; return s/2147483647; }; })();

  for (var i = 0; i < numEmbers; i++) {
    const dist = (0.3 + seededRand() * 0.7) * emberDist;
    const scatter = (seededRand() - 0.5) * 60 * Math.PI / 180;
    const angle = windRad + scatter;
    const headLat = fireCenterLat + (semiMajor * Math.cos(windRad)) / 111320;
    const headLng = fireCenterLng + (semiMajor * Math.sin(windRad)) / (111320 * Math.cos(fireCenterLat * Math.PI / 180));
    const eLat = headLat + (dist * Math.cos(angle)) / 111320;
    const eLng = headLng + (dist * Math.sin(angle)) / (111320 * Math.cos(headLat * Math.PI / 180));

    var neutralized = false;
    simTowerState.forEach(function(ts, ti) {
      if (!ts.active || ts.pumpPct <= 0) return;
      const tPos = towers[ti].marker.getLatLng();
      const radius = getSprayRadius(ts.pumpPct);
      var effectiveRadius = radius * 5.0; // V25: Demo mode - 5x larger ember neutralization zone (visual radius stays 70m)
      if (windSpeedKmh > 0 && windAngleDeg >= 0) effectiveRadius = radius * 5.0 * (1 + (windSpeedKmh / 30) * 0.15);
      if (haversine([tPos.lat, tPos.lng], [eLat, eLng]) <= effectiveRadius) neutralized = true;
    });

    const emberIcon = L.divIcon({
      html: '<div class="ember-dot" style="' + (neutralized ? 'background:#888;box-shadow:none;animation:none;opacity:0.4;' : '') + '"></div>',
      iconSize: [6, 6], iconAnchor: [3, 3], className: ''
    });
    const em = L.marker([eLat, eLng], { icon: emberIcon, interactive: false });
    layers.fire.addLayer(em);
    emberMarkers.push(em);

    if (!neutralized && spotFires.length < MAX_SPOT_FIRES && seededRand() < SPOT_FIRE_IGNITION_PROB) {
      const inMain = isPointInEllipse(eLat, eLng, fireCenterLat, fireCenterLng, semiMajor * 1.2, semiMinor * 1.2, windRad);
      const inExisting = spotFires.some(function(sf) { return !sf.merged && haversine([sf.lat, sf.lng], [eLat, eLng]) < 50; });
      const overWater = isOverWater(eLat, eLng); // Block spot fires over Stuart Lake
      
      // V15: Force field - check if ember lands in ACTIVE spray zone
      var inActiveSprayZone = false;
      if (timeSimRunning && simTowerState.length > 0) {
        for (var ti = 0; ti < simTowerState.length; ti++) {
          var ts = simTowerState[ti];
          if (ts.active && ts.pumpPct > 0) {
            const tPos = towers[ti].marker.getLatLng();
            const sprayRadius = getSprayRadius(ts.pumpPct) * 5.0; // V25: Demo mode - 5x larger protected zone
            if (haversine([tPos.lat, tPos.lng], [eLat, eLng]) <= sprayRadius) {
              inActiveSprayZone = true;
              break;
            }
          }
        }
      }
      
      if (!inMain && !inExisting && !overWater && !inActiveSprayZone) {
        spotFires.push({ lat: eLat, lng: eLng, startMinute: simMinute, id: spotFireIdCounter++, merged: false });
      }
    }
  }

  spotFireLayers.forEach(function(l) { layers.fire.removeLayer(l); });
  spotFireLayers = [];

  for (var fi = 0; fi < spotFires.length; fi++) {
    var sf = spotFires[fi];
    if (sf.merged) continue;
    const sfElapsed = simMinute - sf.startMinute;
    if (sfElapsed < 1) continue;
    const sfSpreadRate = SPOT_FIRE_BASE_ROS * windFactor * speedMult;
    const sfSemiMajor = sfSpreadRate * sfElapsed;
    const sfSemiMinor = sfSemiMajor / lb_ratio;
    if (sfSemiMajor < 3) continue;
    const sfShift = sfSemiMajor * 0.3;
    const sfCLat = sf.lat + (sfShift * Math.cos(windRad)) / 111320;
    const sfCLng = sf.lng + (sfShift * Math.sin(windRad)) / (111320 * Math.cos(sf.lat * Math.PI / 180));
    if (isPointInEllipse(sfCLat, sfCLng, fireCenterLat, fireCenterLng, semiMajor, semiMinor, windRad)) {
      sf.merged = true; continue;
    }
    
    // V17: Add organic noise to spot fires (same as main fire)
    if (!sf._organicNoise) {
      sf._organicNoise = new Float32Array(32);
      for (var k = 0; k < 32; k++) {
        sf._organicNoise[k] = 0.85 + Math.random() * 0.3; // 0.85 to 1.15
      }
    }
    // Evolve noise slowly (random walk)
    for (var k = 0; k < 32; k++) {
      const drift = (Math.random() - 0.5) * 0.02;
      sf._organicNoise[k] = Math.max(0.75, Math.min(1.25, sf._organicNoise[k] + drift));
    }
    
    const sfPts = [];
    for (var j = 0; j < 32; j++) {
      const a = (2 * Math.PI * j) / 32;
      const ex = sfSemiMinor * Math.cos(a);
      const ey = sfSemiMajor * Math.sin(a);
      const ellipseDist = Math.sqrt(ex * ex + ey * ey);
      // V17: Apply organic noise
      const organicDist = ellipseDist * sf._organicNoise[j];
      const organicEx = (ex / ellipseDist) * organicDist;
      const organicEy = (ey / ellipseDist) * organicDist;
      const srx = organicEx * Math.cos(windRad) - organicEy * Math.sin(windRad);
      const sry = organicEx * Math.sin(windRad) + organicEy * Math.cos(windRad);
      sfPts.push([sfCLat + sry / 111320, sfCLng + srx / (111320 * Math.cos(sfCLat * Math.PI / 180))]);
    }

    const sfLayer = L.polygon(sfPts, {
      color: '#ff6600', fillColor: '#ff6600',
      fillOpacity: 0.3 + 0.1 * Math.sin(pulsePhase * 3),
      weight: 2, opacity: 0.7, dashArray: '5,5'
    });
    layers.fire.addLayer(sfLayer);
    spotFireLayers.push(sfLayer);

    const sfIcon = L.divIcon({
      html: '<div style="font-size:14px;text-shadow:0 0 4px #ff4400;">&#x1f525;</div>',
      iconSize: [14, 14], iconAnchor: [7, 7], className: ''
    });
    const sfMarker = L.marker([sf.lat, sf.lng], { icon: sfIcon, interactive: false });
    layers.fire.addLayer(sfMarker);
    spotFireLayers.push(sfMarker);
  }

  const activeSpotFires = spotFires.filter(function(sf) { return !sf.merged; }).length;

  var fireInfo = document.getElementById('fire-info');
  const distToTown = haversine([ignitionPoint.lat, ignitionPoint.lng], FSJ_CENTER);
  const frontDist = semiMajor;
  const remaining = Math.max(0, distToTown - frontDist);
  fireInfo.innerHTML =
    '<div class="sim-stat-row"><span>Fire spread</span><span class="sim-stat-val" style="color:#e74c3c;">' + Math.round(frontDist) + 'm</span></div>' +
    '<div class="sim-stat-row"><span>Distance to town</span><span class="sim-stat-val" style="color:' + (remaining<100?'#e74c3c':'#f1c40f') + '">' + Math.round(remaining) + 'm</span></div>' +
    '<div class="sim-stat-row"><span>Ember range</span><span class="sim-stat-val" style="color:#ff8800;">' + Math.round(emberDist) + 'm</span></div>' +
    '<div class="sim-stat-row"><span>Spot fires</span><span class="sim-stat-val" style="color:' + (activeSpotFires>0?'#ff6600':'#888') + '">' + activeSpotFires + ' active</span></div>' +
    '<div class="sim-stat-row"><span>Spread rate</span><span class="sim-stat-val">' + (spreadRate*60/1000).toFixed(2) + ' km/h</span></div>' +
    '<div class="sim-stat-row"><span>Fire type</span><span class="sim-stat-val" style="color:' + (spreadRate>30?'#e74c3c':spreadRate>10?'#f1c40f':'#ff8800') + '">' + (spreadRate>50?'EXTREME CROWN':spreadRate>20?'ACTIVE CROWN':spreadRate>5?'SURFACE + CROWN':'SURFACE') + '</span></div>';
}

function isPointInFireZone(lat, lng) {
  if (!fireEllipse || !fireActive || !fireEnabled) return false;
  if (timeSimRunning) {
    for (var ti = 0; ti < simTowerState.length; ti++) {
      var ts = simTowerState[ti];
      if (!ts.active || ts.pumpPct <= 0) continue;
      var tPos = towers[ti].marker.getLatLng();
      var radius = getSprayRadius(ts.pumpPct);
      var effectiveRadius = radius * (1 + (windSpeedKmh > 0 ? (windSpeedKmh / 30) * 0.15 : 0));
      if (haversine([tPos.lat, tPos.lng], [lat, lng]) <= effectiveRadius) return false;
    }
  }
  var dx = (lng - fireEllipse.centerLng) * 111320 * Math.cos(fireEllipse.centerLat * Math.PI / 180);
  var dy = (lat - fireEllipse.centerLat) * 111320;
  var cos = Math.cos(-fireEllipse.angle);
  var sin = Math.sin(-fireEllipse.angle);
  var rx = dx * cos - dy * sin;
  var ry = dx * sin + dy * cos;
  var aa = fireEllipse.semiMinor || 1;
  var bb = fireEllipse.semiMajor || 1;
  var inEllipse = (rx*rx)/(aa*aa) + (ry*ry)/(bb*bb) <= 1;

  var emberDist = 100 + (windSpeedKmh / 30) * 1900;
  var windRad = windAngleDeg >= 0 ? windAngleDeg * Math.PI / 180 : 0;
  var frontLat = fireEllipse.centerLat + (fireEllipse.semiMajor * Math.cos(windRad)) / 111320;
  var frontLng = fireEllipse.centerLng + (fireEllipse.semiMajor * Math.sin(windRad)) / (111320 * Math.cos(fireEllipse.centerLat * Math.PI / 180));
  var distFromFront = haversine([frontLat, frontLng], [lat, lng]);
  var inEmberZone = distFromFront <= emberDist;

  if (inEllipse || inEmberZone) return true;

  for (var fi = 0; fi < spotFires.length; fi++) {
    var sf = spotFires[fi];
    if (sf.merged) continue;
    var sfElapsed = simMinute - sf.startMinute;
    if (sfElapsed < 1) continue;
    var sfWindFactor = Math.exp(0.115 * windSpeedKmh);
    var sfSpeedMult = parseFloat(document.getElementById('fire-speed-mult').value) || 2;
    var sfSemiMajor = SPOT_FIRE_BASE_ROS * sfWindFactor * sfSpeedMult * sfElapsed;
    var sfSemiMinor = sfSemiMajor / (1 + 0.25 * windSpeedKmh);
    var sfShift = sfSemiMajor * 0.3;
    var sfCLat = sf.lat + (sfShift * Math.cos(windRad)) / 111320;
    var sfCLng = sf.lng + (sfShift * Math.sin(windRad)) / (111320 * Math.cos(sf.lat * Math.PI / 180));
    if (isPointInEllipse(lat, lng, sfCLat, sfCLng, sfSemiMajor, sfSemiMinor, windRad)) return true;
  }
  return false;
}

// ===================== SCADA PANEL =====================
let scadaVisible = false;

function toggleSCADA() {
  scadaVisible = !scadaVisible;
  document.getElementById('scada-panel').style.display = scadaVisible ? 'block' : 'none';
  if (scadaVisible) updateSCADAPanel();
}

function updateSCADAPanel() {
  const n = towers.length;
  const activeTowers = timeSimRunning ? simTowerState.filter(function(ts) { return ts.active; }).length : 0;
  var totalFlow = 0;
  if (timeSimRunning) {
    simTowerState.forEach(function(ts) { if (ts.active) totalFlow += (ts.pumpPct / 100) * getSprayGPM(); });
  }
  const resPct = Math.round((reservoirGal / RESERVOIR_MAX_GAL) * 100);
  const activeZones = timeSimRunning ? simZoneState.filter(function(zs) { return zs.phase === 'spray'; }).length : 0;
  const demandRatio = n > 0 ? totalFlow / (n * getSprayGPM()) : 0;
  const pressure = Math.max(30, 70 - demandRatio * 25 + (Math.sin(pulsePhase * 3) * 2));
  const pressureAlert = pressure < 45 ? 'alert-red' : pressure < 55 ? 'alert-yellow' : '';

  var totalMainsRefill = 0;
  if (timeSimRunning && simZoneState) {
    simZoneState.forEach(function(zs) { totalMainsRefill += (zs.supplyGPM || 500); });
  } else {
    totalMainsRefill = (simZones.length || computeZones().length) * 500;
  }

  var html =
    '<div class="scada-meter ' + pressureAlert + '"><div class="sm-label">System Pressure</div><div class="sm-value">' + pressure.toFixed(1) + '</div><div class="sm-unit">PSI</div></div>' +
    '<div class="scada-meter"><div class="sm-label">Main Flow Rate</div><div class="sm-value" style="color:#33ff33;">' + Math.round(totalFlow) + '</div><div class="sm-unit">GPM</div></div>' +
    '<div class="scada-meter ' + (resPct<30?'alert-red':resPct<60?'alert-yellow':'') + '"><div class="sm-label">Reservoir Level</div><div class="sm-value">' + resPct + '</div><div class="sm-unit">%</div></div>' +
    '<div class="scada-meter"><div class="sm-label">Active Towers</div><div class="sm-value" style="color:#33ff33;">' + activeTowers + '/' + n + '</div><div class="sm-unit"></div></div>' +
    '<div class="scada-meter"><div class="sm-label">Active Zones</div><div class="sm-value" style="color:#33ff33;">' + activeZones + '/' + (simZones.length || computeZones().length) + '</div><div class="sm-unit"></div></div>' +
    '<div class="scada-meter"><div class="sm-label">Source Inflow</div><div class="sm-value" style="color:#33ff33;">' + SOURCE_INFLOW_GPM + '</div><div class="sm-unit">GPM</div></div>' +
    '<div class="scada-meter ' + (lastCascadeResult.f1Bottleneck ? 'alert-red' : '') + '"><div class="sm-label">System Demand (F1)</div><div class="sm-value" style="color:' + (lastCascadeResult.f1Bottleneck ? '#ff3333' : '#ffaa00') + ';">' + Math.round(lastCascadeResult.totalDemand || totalMainsRefill) + '/' + Math.round(lastCascadeResult.f1Capacity || 1200) + '</div><div class="sm-unit">GPM (cascade)</div></div>' +
    '<div class="scada-meter"><div class="sm-label">Evacuation Mode</div><div class="sm-value" style="color:' + (evacuationMode ? '#ff3333' : '#448844') + ';">' + (evacuationMode ? 'ON' : 'OFF') + '</div><div class="sm-unit">S=' + getHydraulicSlope() + '</div></div>';

  if (timeSimRunning && simZoneState.length > 0) {
    html += '<div style="grid-column:1/-1;border-top:1px solid #1a5c1a;padding-top:8px;margin-top:4px;">';
    html += '<div style="font-size:10px;color:#448844;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;">Zone Flow Meters</div>';
    simZoneState.forEach(function(zs, zi) {
      var zoneFlow = 0;
      zs.towerIndices.forEach(function(ti) {
        var ts = simTowerState[ti];
        if (ts && ts.active) zoneFlow += (ts.pumpPct / 100) * getSprayGPM();
      });
      var valveOpen = zs.phase === 'spray';
      var zoneRefill = 0;
      zs.towerIndices.forEach(function(ti) { zoneRefill += (simTowerState[ti]._refillGPM || 0); });
      var zonePipeId = zs.nearestPipeId || '?';
      var zonePipeCap = 0;
      var zPipe = waterMains.find(function(m) { return m.id === zonePipeId; });
      if (zPipe) zonePipeCap = Math.round(pipeCapacityGPM(zPipe.diam) * 0.60);
      var pipeUtil = zonePipeCap > 0 ? Math.round(((lastCascadeResult.pipeLoads && lastCascadeResult.pipeLoads[zonePipeId]) || 0) / zonePipeCap * 100) : 0;
      html += '<div class="scada-zone-row"><span class="scada-valve ' + (valveOpen ? 'open' : 'closed') + '"></span><span style="color:' + ZONE_COLORS[zi % ZONE_COLORS.length] + ';">Z' + (zi+1) + '</span><span style="flex:1;">' + zs.towerIndices.length + 't | Refill: ' + Math.round(zoneRefill) + ' GPM | [' + zonePipeId + '] ' + pipeUtil + '%</span><span style="color:' + (valveOpen ? '#33ff33' : '#666') + ';font-weight:700;">' + Math.round(zoneFlow) + ' GPM</span></div>';
    });
    html += '</div>';
  }

  document.getElementById('scada-content').innerHTML = html;
}

// ===================== BEFORE/AFTER (disabled) =====================
function toggleBeforeAfter() { return; }
function updateBASlider() { return; }
function closeBeforeAfter() { return; }

// ===================== DRAGGABLE SIDEBAR PANELS =====================
function initDraggablePanels() {
  const sidebar = document.getElementById('sidebar');
  const sections = sidebar.querySelectorAll('.section');
  var dragSrc = null;

  sections.forEach(function(sec) {
    const handle = sec.querySelector('.drag-handle');
    if (!handle) return;

    handle.addEventListener('dragstart', function(e) {
      dragSrc = sec;
      sec.style.opacity = '0.5';
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', '');
    });

    handle.addEventListener('dragend', function() {
      sec.style.opacity = '1';
      sections.forEach(function(s) { s.classList.remove('drag-over'); });
      savePanelOrder();
    });

    sec.addEventListener('dragover', function(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      sec.classList.add('drag-over');
    });

    sec.addEventListener('dragleave', function() {
      sec.classList.remove('drag-over');
    });

    sec.addEventListener('drop', function(e) {
      e.preventDefault();
      sec.classList.remove('drag-over');
      if (dragSrc && dragSrc !== sec) {
        var allSections = Array.from(sidebar.querySelectorAll('.section'));
        var srcIdx = allSections.indexOf(dragSrc);
        var tgtIdx = allSections.indexOf(sec);
        if (srcIdx < tgtIdx) { sec.after(dragSrc); }
        else { sec.before(dragSrc); }
      }
    });
  });

  restorePanelOrder();
}

function toggleSectionCollapse(headerEl) {
  headerEl.closest('.section').classList.toggle('collapsed');
  savePanelOrder();
}

function savePanelOrder() {
  var sidebar = document.getElementById('sidebar');
  var sections = sidebar.querySelectorAll('.section[data-panel]');
  var order = [];
  sections.forEach(function(s) {
    order.push({ id: s.dataset.panel, collapsed: s.classList.contains('collapsed') });
  });
  try { localStorage.setItem('hydrodome-panel-order', JSON.stringify(order)); } catch(e) {}
}

function restorePanelOrder() {
  try {
    var saved = JSON.parse(localStorage.getItem('hydrodome-panel-order'));
    if (!saved || !saved.length) return;
    var sidebar = document.getElementById('sidebar');
    saved.forEach(function(item) {
      var sec = sidebar.querySelector('.section[data-panel="' + item.id + '"]');
      if (sec && item.collapsed) sec.classList.add('collapsed');
    });
    var orderedSections = [];
    saved.forEach(function(item) {
      var sec = sidebar.querySelector('.section[data-panel="' + item.id + '"]');
      if (sec) orderedSections.push(sec);
    });
    sidebar.querySelectorAll('.section[data-panel]').forEach(function(sec) {
      if (orderedSections.indexOf(sec) === -1) orderedSections.push(sec);
    });
    orderedSections.forEach(function(sec) { sidebar.appendChild(sec); });
  } catch(e) {}
}

// ===================== PDF EXPORT =====================
async function exportPDF() {
  var n = towers.length;
  if (n === 0) { alert('Place some towers first.'); return; }
  var btn = document.querySelector('[onclick="exportPDF()"]');
  btn.textContent = 'Generating PDF...'; btn.disabled = true;

  try {
    var jsPDF = window.jspdf.jsPDF;
    var doc = new jsPDF('p', 'mm', 'a4');
    var W = 210, H = 297, margin = 15;
    var green = [45, 80, 22], orange = [255, 107, 53];

    doc.setFillColor.apply(doc, green);
    doc.rect(0, 0, W, 35, 'F');
    doc.setFillColor.apply(doc, orange);
    doc.rect(0, 35, W, 3, 'F');
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(24);
    doc.setTextColor(255, 255, 255);
    doc.text('HYDRODOME', margin, 18);
    doc.setFontSize(11);
    doc.setTextColor(255, 200, 150);
    doc.text('WILDFIRE DEFENSE SYSTEM -- FEASIBILITY REPORT', margin, 28);

    var y = 48;
    doc.setFontSize(10);
    doc.setTextColor(100, 100, 100);
    doc.text('Harrison Hot Springs, BC  |  Generated: ' + new Date().toLocaleDateString(), margin, y);
    y += 10;

    try {
      var mapCanvas = await html2canvas(document.getElementById('map'), { useCORS: true, scale: 1.5, logging: false });
      var imgData = mapCanvas.toDataURL('image/jpeg', 0.85);
      var imgW = W - margin * 2;
      var imgH = imgW * 0.55;
      doc.addImage(imgData, 'JPEG', margin, y, imgW, imgH);
      y += imgH + 8;
    } catch(e) {
      doc.setTextColor(150, 0, 0);
      doc.text('[Map screenshot unavailable]', margin, y);
      y += 10;
    }

    doc.setFillColor.apply(doc, green);
    doc.rect(margin, y, W - margin * 2, 7, 'F');
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(11);
    doc.setTextColor(255, 255, 255);
    doc.text('SYSTEM OVERVIEW', margin + 3, y + 5);
    y += 12;

    var zones = computeZones();
    var items = [
      ['Total Towers', '' + n],
      ['Zones', zones.length + ' (' + zones.map(function(z) { return z.length + ' towers'; }).join(', ') + ')'],
      ['Microturbines', zones.length + ' x Capstone C65'],
      ['Coverage Area', Math.min(n * 0.50, TOWN_AREA_HA * 1.2).toFixed(1) + ' hectares'],
      ['Max Spray Demand', n * 200 + ' GPM'],
      ['Duty-Cycled Demand', n * 100 + ' GPM'],
    ];
    doc.setFontSize(10);
    items.forEach(function(kv) {
      doc.setTextColor(80, 80, 80);
      doc.setFont('helvetica', 'normal');
      doc.text(kv[0] + ':', margin + 2, y);
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(30, 30, 30);
      doc.text(kv[1], margin + 60, y);
      y += 6;
    });
    y += 4;

    doc.setFillColor.apply(doc, green);
    doc.rect(margin, y, W - margin * 2, 7, 'F');
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(11);
    doc.setTextColor(255, 255, 255);
    doc.text('HYDRAULIC & CISTERN ANALYSIS', margin + 3, y + 5);
    y += 12;

    var hydItems = [
      ['Cistern per Tower', '8,000 gal (subgrade)'],
      ['Total Storage', (n * 8000).toLocaleString() + ' gal'],
      ['Spray Runtime', '40 min full / 80 min with 50% duty'],
      ['Reservoir', '1.3M litres (343k gal)'],
      ['Source Inflow', '800 GPM'],
    ];
    doc.setFontSize(10);
    hydItems.forEach(function(kv) {
      doc.setTextColor(80, 80, 80);
      doc.setFont('helvetica', 'normal');
      doc.text(kv[0] + ':', margin + 2, y);
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(30, 30, 30);
      doc.text(kv[1], margin + 60, y);
      y += 6;
    });
    y += 4;

    doc.setFillColor.apply(doc, green);
    doc.rect(margin, y, W - margin * 2, 7, 'F');
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(11);
    doc.setTextColor(255, 255, 255);
    doc.text('TOWER LOCATIONS', margin + 3, y + 5);
    y += 12;

    doc.setFontSize(9);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(80, 80, 80);
    doc.text('#', margin + 2, y);
    doc.text('Latitude', margin + 15, y);
    doc.text('Longitude', margin + 55, y);
    doc.text('Zone', margin + 100, y);
    y += 5;

    doc.setFont('helvetica', 'normal');
    doc.setTextColor(40, 40, 40);
    towers.forEach(function(t, i) {
      if (y > 270) { doc.addPage(); y = 20; }
      var p = t.marker.getLatLng();
      var zi = zones.findIndex(function(z) { return z.includes(i); });
      doc.text('' + (i + 1), margin + 2, y);
      doc.text(p.lat.toFixed(5) + ' N', margin + 15, y);
      doc.text(Math.abs(p.lng).toFixed(5) + ' W', margin + 55, y);
      doc.text('Zone ' + (zi + 1), margin + 100, y);
      y += 5;
    });
    y += 6;

    if (y > 240) { doc.addPage(); y = 20; }
    doc.setFillColor.apply(doc, orange);
    doc.rect(margin, y, W - margin * 2, 7, 'F');
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(11);
    doc.setTextColor(255, 255, 255);
    doc.text('COST VS DAMAGE ANALYSIS', margin + 3, y + 5);
    y += 14;

    var covered = 0;
    buildings.forEach(function(b) {
      if (towers.some(function(t) {
        var p = t.marker.getLatLng();
        return haversine([p.lat, p.lng], [b.lat, b.lng]) <= 40;
      })) covered++;
    });
    var cost = n * 134000;
    var costStr = '$' + (cost / 1000000).toFixed(1) + 'M CAD';
    var roi = Math.round(500000000 / cost);

    var costItems2 = [
      ['System Cost', costStr],
      ['Structures Protected', covered + '/' + buildings.length + ' (' + Math.round(covered/buildings.length*100) + '%)'],
      ['Estimated Loss Prevention', '$500M+'],
      ['Return on Investment', roi + ':1'],
    ];
    doc.setFontSize(11);
    costItems2.forEach(function(kv) {
      doc.setTextColor(80, 80, 80);
      doc.setFont('helvetica', 'normal');
      doc.text(kv[0] + ':', margin + 2, y);
      doc.setFont('helvetica', 'bold');
      doc.setTextColor.apply(doc, orange);
      doc.text(kv[1], margin + 70, y);
      y += 8;
    });

    y = H - 15;
    doc.setDrawColor.apply(doc, green);
    doc.line(margin, y - 5, W - margin, y - 5);
    doc.setFontSize(8);
    doc.setTextColor(150, 150, 150);
    doc.text('(c) 2025 Carmanah Wildfire Defense -- HydroDome Wildfire Defense System', margin, y);
    doc.text('Nelson Big Gun 150 Series | 400 GPM @ 100 PSI | 70m radius | 1.54 ha coverage', margin, y + 4);

    doc.save('HydroDome_Harrison_Report.pdf');
  } catch(e) {
    console.error('PDF export error:', e);
    alert('PDF generation failed. Try the text export instead.');
  }

  btn.textContent = 'Export PDF'; btn.disabled = false;
}

// ===================== RECOMMENDED LAYOUT =====================
function loadRecommended() {
  // V25: Demo mode - Efficient layout with 12 widely-spaced towers
  // 200m+ spacing (no overlap), 70m visual radius, 350m invisible protection
  resetAll();
  
  const recommendedPositions = [
    // Row 1: North (3 towers, ~220m spacing)
    [54.4465, -124.2600], [54.4465, -124.2540], [54.4465, -124.2480],
    
    // Row 2: Central-North (3 towers)
    [54.4425, -124.2620], [54.4425, -124.2560], [54.4425, -124.2500],
    
    // Row 3: Central-South (3 towers)
    [54.4385, -124.2600], [54.4385, -124.2540], [54.4385, -124.2480],
    
    // Row 4: South (3 towers - hospital coverage)
    [54.4345, -124.2620], [54.4345, -124.2560], [54.4345, -124.2500]
  ];
  
  recommendedPositions.forEach(function(pos, i) {
    addTower(pos[0], pos[1]);
  });
  
  document.getElementById('map-tooltip').textContent = '‚úì Loaded 12 towers - Efficient wide-spacing layout (200m+ apart, 350m protection zones)';
  document.getElementById('map-tooltip').classList.remove('hidden');
  setTimeout(function() {
    document.getElementById('map-tooltip').classList.add('hidden');
  }, 3000);
}

// ===================== RESET =====================
function resetAll() {
  if (timeSimRunning) stopTimeSim();
  towers.forEach(function(t) {
    layers.towers.removeLayer(t.marker);
    layers.coverage.removeLayer(t.circle);
  });
  towers = [];
  simulated = false;
  buildingRects.forEach(function(rect) {
    rect.setStyle({ color:'#888', fillColor:'#aaa', fillOpacity:0.5 });
    rect._protectionState = 'unprotected';
  });
  removeIgnition();
  clearFireVisuals();
  pipePolylines.forEach(function(pl) {
    pl.setStyle({ color: pl._origColor, weight: pl._origWeight, opacity: 0.8 });
    var m = pl._pipeData;
    pl.setTooltipContent(m.label + '<br>&Oslash;' + Math.round(m.diam*39.37) + '"');
  });
  updateCoverage();
  updateStats();
  updateCostOverlay();
  if (placeMode) togglePlaceMode();
  if (ignitionMode) toggleIgnitionMode();
}

// ===================== TEXT EXPORT =====================
function exportReport() {
  var n = towers.length;
  if (n === 0) { alert('No towers to export.'); return; }
  var zones = computeZones();
  var flowDuty = n * 100;
  var coverageHa = Math.min(n * 0.50, TOWN_AREA_HA * 1.2).toFixed(1);
  var costLow = (n * 118000 / 1000).toFixed(0);
  var costHigh = (n * 150000 / 1000).toFixed(0);
  var covered = 0;
  buildings.forEach(function(b) {
    if (towers.some(function(t) {
      var p = t.marker.getLatLng();
      return haversine([p.lat, p.lng], [b.lat, b.lng]) <= 40;
    })) covered++;
  });
  var report = 'HYDRODOME WILDFIRE DEFENSE SYSTEM\nFeasibility Report -- Harrison Hot Springs, BC\nGenerated: ' + new Date().toLocaleString() + '\n' +
    '==================================================\n\n' +
    'SYSTEM OVERVIEW\n  Total Towers: ' + n + '\n  Zones: ' + zones.length + '\n\n' +
    'COVERAGE\n  Covered Area: ' + coverageHa + ' hectares\n  Structures Protected: ' + covered + ' / ' + buildings.length + '\n\n' +
    'COST ESTIMATE\n  System Cost (avg): $' + (n * 134000 / 1000000).toFixed(1) + 'M\n  ROI: ' + Math.round(500000000 / (n * 134000)) + ':1\n\n' +
    'TOWER LOCATIONS\n' + towers.map(function(t, i) {
      var p = t.marker.getLatLng();
      return '  Tower ' + (i+1) + ': ' + p.lat.toFixed(4) + 'N, ' + Math.abs(p.lng).toFixed(4) + 'W';
    }).join('\n') + '\n\n(c) 2025 Carmanah Wildfire Defense';

  var blob = new Blob([report], { type: 'text/plain' });
  var a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'HydroDome_Harrison_Report.txt';
  a.click();
}

// ===================== LAYER TOGGLE =====================
function toggleLayer(name, visible) {
  if (visible) map.addLayer(layers[name]);
  else map.removeLayer(layers[name]);
}

// ===================== SPRAY ANIMATION (V8: sim-time rotation + mist plumes) =====================
let sprayAnimEnabled = true;
let sprayAnimRAF = null;

function toggleSprayAnimation() {
  setSprayAnimation(!sprayAnimEnabled);
}

function setSprayAnimation(on) {
  sprayAnimEnabled = on;
  var btn = document.getElementById('btn-spray-anim');
  var chk = document.getElementById('chk-spray-anim');
  var canvas = document.getElementById('spray-canvas');
  if (btn) btn.textContent = on ? '\u{1f4a8} Spray Animation: ON' : '\u{1f4a8} Spray Animation: OFF';
  if (chk) chk.checked = on;
  if (canvas) canvas.style.display = on ? 'block' : 'none';
}

function initSprayCanvas() {
  var canvas = document.getElementById('spray-canvas');
  var container = document.getElementById('map-container');
  function resize() {
    canvas.width = container.clientWidth;
    canvas.height = container.clientHeight;
  }
  resize();
  window.addEventListener('resize', resize);
  map.on('move zoom resize', resize);

  function animate() {
    sprayAnimRAF = requestAnimationFrame(animate);
    if (!sprayAnimEnabled) return;
    if (!timeSimRunning) {
      var ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      return;
    }
    drawSprayAnimation(canvas);
  }
  animate();
}

function drawSprayAnimation(canvas) {
  var ctx = canvas.getContext('2d');
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  var now = performance.now();

  // V8: Rotation tied to sim time. simMinute advances by simSpeed per tick (every 500ms).
  // Use real time * simSpeed for smooth visual rotation.
  // 30 sim-seconds = 1 revolution. At simSpeed=1, 1 sim-min per 500ms real.
  // So 30 sim-sec = 0.5 sim-min = 250ms real at speed 1.
  // That's too fast to see. Let's scale: 30 sim-MINUTES per revolution for visual clarity.
  // Actually the spec says 30 sim-seconds. Let's honor it but note that at the sim's
  // time compression (1 min per 500ms at speed=1), rotation will appear fast.
  // Real rotation period = 30 / (simSpeed * 120) seconds = 0.25/simSpeed seconds at speed 1.
  // That's way too fast. The sim runs at 120x real time at speed 1 (1 sim-min per 0.5 real-sec).
  // So 30 sim-seconds = 30/120 = 0.25 real seconds per revolution at speed 1. Invisible.
  //
  // The spec intention is: tie visual rotation to sim time so it speeds up with sim speed.
  // Original: 30 real-seconds per revolution (wall clock).
  // New: multiply wall-clock-based rotation by simSpeed.
  // This way at 1x: 30 real sec/rev (same as before). At 4x: 7.5 real sec/rev. At 8x: 3.75 real sec/rev.
  var baseAngle = ((now / 30000) * simSpeed * 2 * Math.PI) % (2 * Math.PI);

  var mistPulse = 0.08 + 0.07 * Math.sin(now / 800);

  // === PASS 1: Draw mist plumes and haze with additive blending (V9: dramatically more visible) ===
  ctx.save();
  ctx.globalCompositeOperation = 'lighter';

  simTowerState.forEach(function(ts, ti) {
    if (!ts.active || ts.pumpPct <= 0) return;

    var tPos = towers[ti].marker.getLatLng();
    var pt = map.latLngToContainerPoint(tPos);
    var radiusM = getSprayRadius(ts.pumpPct);
    var p1 = map.latLngToContainerPoint([tPos.lat, tPos.lng]);
    var p2 = map.latLngToContainerPoint([tPos.lat + radiusM / 111320, tPos.lng]);
    var radiusPx = Math.abs(p1.y - p2.y);
    if (radiusPx < 2) return;

    var cx = pt.x;
    var cy = pt.y;

    // V9: Draw subtle mist haze WITHIN the spray circle
    var hazeOpacity = 0.08 + 0.04 * Math.sin(now / 1000 + ti * 0.8);
    ctx.fillStyle = 'rgba(100, 180, 255, ' + hazeOpacity.toFixed(3) + ')';
    ctx.beginPath();
    ctx.arc(cx, cy, radiusPx, 0, Math.PI * 2);
    ctx.fill();

    // Skip downwind plume if no wind
    if (windSpeedKmh <= 0 || windAngleDeg < 0) return;

    var windRad = windAngleDeg * Math.PI / 180;
    var dxWind = Math.sin(windRad);
    var dyWind = -Math.cos(windRad);

    // V9: Increased plume size
    var plumeLenM = radiusM * (0.8 + windSpeedKmh / 25);
    var plumeLenPx = plumeLenM * (radiusPx / radiusM);
    var farWidthPx = radiusPx * 2 * 0.90;

    var startX = cx + dxWind * radiusPx;
    var startY = cy + dyWind * radiusPx;
    var endX = cx + dxWind * (radiusPx + plumeLenPx);
    var endY = cy + dyWind * (radiusPx + plumeLenPx);

    var perpX = -dyWind;
    var perpY = dxWind;

    var startHalfW = radiusPx * 0.70;
    var endHalfW = farWidthPx / 2;

    // V9: Base opacity 0.30-0.35 with +/- 0.05 breathing
    var baseOpacity = 0.32 + 0.05 * Math.sin(now / 1200 + ti * 0.5);

    // V9: Glow pass (1.3x size, half opacity) for halo effect
    var numSteps = 12;
    for (var pass = 0; pass < 2; pass++) {
      var sizeScale = pass === 0 ? 1.3 : 1.0;
      var opacityScale = pass === 0 ? 0.5 : 1.0;

      for (var step = 0; step < numSteps; step++) {
        var f0 = step / numSteps;
        var f1 = (step + 1) / numSteps;
        var fMid = (f0 + f1) / 2;
        var avgOpacity = (1 - fMid) * baseOpacity * opacityScale;
        if (avgOpacity < 0.003) continue;

        var x0 = startX + (endX - startX) * f0;
        var y0 = startY + (endY - startY) * f0;
        var x1 = startX + (endX - startX) * f1;
        var y1 = startY + (endY - startY) * f1;

        var hw0 = (startHalfW + (endHalfW - startHalfW) * f0) * sizeScale;
        var hw1 = (startHalfW + (endHalfW - startHalfW) * f1) * sizeScale;

        ctx.fillStyle = 'rgba(100, 180, 255, ' + avgOpacity.toFixed(3) + ')';
        ctx.beginPath();
        ctx.moveTo(x0 + perpX * hw0, y0 + perpY * hw0);
        ctx.lineTo(x1 + perpX * hw1, y1 + perpY * hw1);
        ctx.lineTo(x1 - perpX * hw1, y1 - perpY * hw1);
        ctx.lineTo(x0 - perpX * hw0, y0 - perpY * hw0);
        ctx.closePath();
        ctx.fill();
      }
    }
  });

  ctx.restore();

  // === PASS 2: Draw spray arms and fans (normal blending) ===
  simTowerState.forEach(function(ts, ti) {
    if (!ts.active || ts.pumpPct <= 0) return;

    var tPos = towers[ti].marker.getLatLng();
    var pt = map.latLngToContainerPoint(tPos);
    var radiusM = getSprayRadius(ts.pumpPct);
    var p1 = map.latLngToContainerPoint([tPos.lat, tPos.lng]);
    var p2 = map.latLngToContainerPoint([tPos.lat + radiusM / 111320, tPos.lng]);
    var radiusPx = Math.abs(p1.y - p2.y);
    if (radiusPx < 2) return;

    var cx = pt.x;
    var cy = pt.y;

    // V8: sim-time rotation. Offset each tower.
    var towerOffset = ti * 0.7;
    var angle = baseAngle + towerOffset;

    ctx.save();

    // Rotating sprinkler arm
    ctx.strokeStyle = 'rgba(180, 220, 255, 0.6)';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.lineTo(cx + Math.cos(angle) * radiusPx, cy + Math.sin(angle) * radiusPx);
    ctx.stroke();

    // Spray fan wedge (40 degree arc trailing behind arm)
    var fanAngle = 40 * Math.PI / 180;
    ctx.fillStyle = 'rgba(100, 180, 255, 0.25)';
    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.arc(cx, cy, radiusPx, angle - fanAngle, angle, false);
    ctx.closePath();
    ctx.fill();

    ctx.restore();
  });
}

// ===================== INIT =====================
updateStats();
updateCoverage();
updateCostOverlay();
initDraggablePanels();
initSprayCanvas();
L.control.scale({ imperial: true, metric: true }).addTo(map);

// V3: Save/Load tower layouts
function exportTowers() {
  var coords = towers.map(function(t) {
    var p = t.marker.getLatLng();
    return [+p.lat.toFixed(6), +p.lng.toFixed(6)];
  });
  var json = JSON.stringify(coords);
  // Copy to clipboard
  navigator.clipboard.writeText(json).then(function() {
    alert('Copied ' + coords.length + ' tower positions to clipboard!\\n\\nPaste into a file or send to Regie to bake into a new version.');
  }).catch(function() {
    // Fallback: download as file
    var blob = new Blob([json], { type: 'application/json' });
    var a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'hydrodome_towers_' + new Date().toISOString().slice(0,10) + '.json';
    a.click();
  });
}

function importTowers() {
  var input = prompt('Paste tower coordinates JSON (or leave blank to load from file):');
  if (input && input.trim()) {
    loadTowerCoords(JSON.parse(input.trim()));
  } else {
    var fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = '.json';
    fileInput.onchange = function(e) {
      var reader = new FileReader();
      reader.onload = function(ev) {
        loadTowerCoords(JSON.parse(ev.target.result));
      };
      reader.readAsText(e.target.files[0]);
    };
    fileInput.click();
  }
}

function loadTowerCoords(coords) {
  // Clear existing towers
  towers.forEach(function(t) { map.removeLayer(t.marker); if (t.circle) map.removeLayer(t.circle); });
  towers.length = 0;
  // Place new ones
  coords.forEach(function(pos) { addTower(pos[0], pos[1]); });
  updateStats();
  alert('Loaded ' + coords.length + ' towers!');
}

// V4: Preset tower layout (Fort St. James - user-placed, not preset)
const presetTowers = [[54.446312,-124.252479],[54.446314,-124.254572],[54.446315,-124.256666],[54.446956,-124.250938],[54.449766,-124.252443],[54.449773,-124.256612],[54.442516,-124.251492],[54.442520,-124.252855],[54.442526,-124.254719],[54.443043,-124.256626],[54.443644,-124.257449],[54.444269,-124.258303],[54.444966,-124.259251],[54.447896,-124.250935],[54.448972,-124.250948],[54.446259,-124.259537],[54.442504,-124.246666],[54.449782,-124.260839],[54.443572,-124.250927],[54.442383,-124.244000],[54.442501,-124.245367],[54.444955,-124.250910],[54.449784,-124.262606],[54.442508,-124.248414],[54.442512,-124.250136],[54.445675,-124.260603],[54.445688,-124.250935],[54.446027,-124.262643],[54.449777,-124.258505],[54.440902,-124.247550],[54.443517,-124.253966],[54.439356,-124.245802],[54.448858,-124.256612],[54.448863,-124.260094],[54.447420,-124.262173],[54.440080,-124.252232],[54.441007,-124.252215],[54.440409,-124.246678],[54.439346,-124.244421],[54.437841,-124.246114],[54.448059,-124.248907],[54.440081,-124.253805],[54.444585,-124.256690],[54.441388,-124.248487],[54.440098,-124.244409],[54.445428,-124.254131],[54.450458,-124.249508],[54.441954,-124.247537],[54.443610,-124.252430],[54.447167,-124.252469],[54.448634,-124.252460],[54.438249,-124.251904],[54.448166,-124.261240],[54.437824,-124.254259],[54.440885,-124.253486],[54.441861,-124.253482],[54.437930,-124.247715],[54.448409,-124.253620],[54.442189,-124.256348],[54.447149,-124.256648],[54.447420,-124.258947],[54.438917,-124.249431],[54.440720,-124.249432],[54.451098,-124.263050],[54.450903,-124.260077],[54.446221,-124.249598],[54.446537,-124.248064],[54.446804,-124.246908],[54.439661,-124.247565],[54.447919,-124.256629],[54.444468,-124.251856],[54.449411,-124.249465],[54.441502,-124.243757],[54.437308,-124.252691],[54.437010,-124.257125],[54.437987,-124.256603],[54.436885,-124.248444],[54.439166,-124.253491],[54.439708,-124.256051],[54.440500,-124.255694],[54.441031,-124.256534],[54.436815,-124.246660],[54.443741,-124.256107],[54.445082,-124.255607],[54.444813,-124.252908],[54.450409,-124.250959],[54.438492,-124.250628],[54.439977,-124.250363]];
// Towers disabled on load - use "Load Recommended Layout" or "Place Tower Mode" to add towers
// presetTowers.forEach(function(pos) {
//   addTower(pos[0], pos[1]);
// });
// updateStats();


// ===================== FULLSCREEN TOGGLE =====================
document.addEventListener('DOMContentLoaded', function() {
  const fullscreenBtn = document.getElementById('fullscreen-toggle');
  if (fullscreenBtn) {
    fullscreenBtn.addEventListener('click', function() {
      document.body.classList.toggle('fullscreen-mode');
      
      // Update button icon
      const icon = this.querySelector('.fs-icon');
      if (document.body.classList.contains('fullscreen-mode')) {
        icon.textContent = '‚ä°'; // Exit fullscreen icon
        this.title = 'Exit Fullscreen (Show Dashboard)';
      } else {
        icon.textContent = '‚õ∂'; // Enter fullscreen icon  
        this.title = 'Toggle Fullscreen Map';
      }
      
      // Force map to recalculate size to fill container (fixes gray block issue)
      setTimeout(function() {
        map.invalidateSize();
      }, 350); // Wait for CSS transition to complete
    });
  }
});

// ===================== JACKSON'S PRIORITY AREAS (Feb 2026) =====================
// From Jackson Hooke's email (Feb 10, 2026) - key assets to prioritize for coverage models
// These polygons highlight clusters he identified for limited-coverage deployment scenarios

(function addJacksonPriorityAreas() {
  const priorityStyle = {
    color: '#00BFFF',      // Cyan outline
    weight: 3,
    fillColor: '#00BFFF',
    fillOpacity: 0.15,
    dashArray: '8, 4'
  };

  const nakazdliStyle = {
    color: '#FFD700',      // Gold for Nak'azdli
    weight: 3,
    fillColor: '#FFD700',
    fillOpacity: 0.15,
    dashArray: '8, 4'
  };

  const priorityAreas = [
    // CLUSTER 1: Hospital / Seniors Housing / Hillcrest Apartments
    {
      name: "Hospital & Seniors Cluster",
      desc: "Stuart Lake Memorial Hospital, seniors housing, Hillcrest Apartments",
      priority: "CRITICAL",
      coords: [
        [54.4410, -124.2445], [54.4410, -124.2395],
        [54.4380, -124.2395], [54.4380, -124.2445]
      ],
      style: priorityStyle,
      label: "üè• Hospital / Seniors"
    },
    // CLUSTER 2: Arena / Curling Rink / High School / Goodwin Building
    {
      name: "Recreation & Emergency Shelter Cluster",
      desc: "Arena, curling rink, Fort St James Secondary, Goodwin Building (potential emergency shelter)",
      priority: "CRITICAL",
      coords: [
        [54.4460, -124.2520], [54.4460, -124.2450],
        [54.4425, -124.2450], [54.4425, -124.2520]
      ],
      style: priorityStyle,
      label: "üèüÔ∏è Arena / School / Goodwin"
    },
    // CLUSTER 3: Fire Dept / Save On / Library / Municipal / Business Strip
    {
      name: "Town Services & Commercial Core",
      desc: "Fire Department, Save On Foods, Library, Municipal Office, business strip malls",
      priority: "CRITICAL",
      coords: [
        [54.4470, -124.2620], [54.4470, -124.2540],
        [54.4435, -124.2540], [54.4435, -124.2620]
      ],
      style: priorityStyle,
      label: "üèõÔ∏è Services / Commercial Core"
    },
    // CLUSTER 4: Fort St. James National Historic Site
    {
      name: "National Historic Site",
      desc: "Fort St. James National Historic Site - cultural heritage asset",
      priority: "HIGH",
      coords: [
        [54.4420, -124.2585], [54.4420, -124.2525],
        [54.4390, -124.2525], [54.4390, -124.2585]
      ],
      style: priorityStyle,
      label: "üèõÔ∏è Historic Site"
    },
    // CLUSTER 5: Substation #2 (Elm & Douglas)
    {
      name: "Substation #2",
      desc: "Fort St. James substation #2 - Corner of Elm Street and Douglas Avenue",
      priority: "HIGH",
      coords: [
        [54.4475, -124.2520], [54.4475, -124.2500],
        [54.4460, -124.2500], [54.4460, -124.2520]
      ],
      style: priorityStyle,
      label: "‚ö° Substation #2"
    },
    // CLUSTER 6: Nakalbun Elementary School
    {
      name: "Nak'albun Elementary",
      desc: "Nak'albun Elementary School",
      priority: "HIGH",
      coords: [
        [54.4405, -124.2510], [54.4405, -124.2480],
        [54.4385, -124.2480], [54.4385, -124.2510]
      ],
      style: priorityStyle,
      label: "üè´ Nak'albun Elementary"
    },
    // CLUSTER 7: David Hoy Elementary School
    {
      name: "David Hoy Elementary",
      desc: "David Hoy Elementary School",
      priority: "HIGH",
      coords: [
        [54.4495, -124.2600], [54.4495, -124.2555],
        [54.4465, -124.2555], [54.4465, -124.2600]
      ],
      style: priorityStyle,
      label: "üè´ David Hoy Elementary"
    },
    // CLUSTER 8: Maintenance & Operations Yard (Stones Bay Road)
    {
      name: "Maintenance & Operations Yard",
      desc: "Municipal Maintenance and Operations Yard on Stones Bay Road",
      priority: "MEDIUM",
      coords: [
        [54.4585, -124.2660], [54.4585, -124.2610],
        [54.4565, -124.2610], [54.4565, -124.2660]
      ],
      style: priorityStyle,
      label: "üîß Ops Yard (Stones Bay)"
    },
    // ===== NAK'AZDLI FIRST NATIONS =====
    // CLUSTER 9: Kwah Hall
    {
      name: "Kwah Hall",
      desc: "Nak'azdli Whut'en - Kwah Hall (community gathering)",
      priority: "CRITICAL",
      coords: [
        [54.4400, -124.2480], [54.4400, -124.2440],
        [54.4375, -124.2440], [54.4375, -124.2480]
      ],
      style: nakazdliStyle,
      label: "üè† Kwah Hall (Nak'azdli)"
    },
    // CLUSTER 10: Day Care Center
    {
      name: "Nak'azdli Day Care",
      desc: "Nak'azdli Day Care Center",
      priority: "HIGH",
      coords: [
        [54.4380, -124.2520], [54.4380, -124.2490],
        [54.4365, -124.2490], [54.4365, -124.2520]
      ],
      style: nakazdliStyle,
      label: "üë∂ Day Care (Nak'azdli)"
    },
    // CLUSTER 11: Sanaiah Grocery Store
    {
      name: "Sanaiah Grocery",
      desc: "Sanaiah Grocery Store - essential food supply",
      priority: "HIGH",
      coords: [
        [54.4375, -124.2530], [54.4375, -124.2505],
        [54.4360, -124.2505], [54.4360, -124.2530]
      ],
      style: nakazdliStyle,
      label: "üõí Sanaiah Grocery (Nak'azdli)"
    }
  ];

  // Create layer group for toggling
  var priorityLayerGroup = L.layerGroup();

  priorityAreas.forEach(function(area) {
    var polygon = L.polygon(area.coords, area.style);
    polygon.bindPopup(
      '<div style="min-width:200px">' +
      '<b style="color:' + area.style.color + ';font-size:14px;">' + area.name + '</b><br>' +
      '<span style="color:#FFD700;font-weight:bold;">Priority: ' + area.priority + '</span><br>' +
      '<hr style="border-color:#333;margin:6px 0">' +
      area.desc +
      '<br><br><em style="color:#888;font-size:10px;">Source: Jackson Hooke feedback (Feb 10, 2026)</em>' +
      '</div>'
    );
    priorityLayerGroup.addLayer(polygon);

    // Add label marker at center
    var center = polygon.getBounds().getCenter();
    var label = L.marker(center, {
      icon: L.divIcon({
        className: '',
        html: '<div style="background:rgba(0,0,0,0.75);color:' + area.style.color + ';padding:2px 6px;border-radius:3px;font-size:10px;font-weight:bold;white-space:nowrap;border:1px solid ' + area.style.color + '40;font-family:sans-serif;">' + area.label + '</div>',
        iconSize: [150, 20],
        iconAnchor: [75, 10]
      })
    });
    priorityLayerGroup.addLayer(label);
  });

  priorityLayerGroup.addTo(map);

  // Add toggle control
  var legendDiv = document.createElement('div');
  legendDiv.style.cssText = 'position:fixed;top:80px;right:20px;z-index:10000;background:rgba(0,0,0,0.85);padding:12px 16px;border-radius:8px;border:1px solid #00BFFF40;font-family:sans-serif;color:#fff;font-size:12px;max-width:260px;';
  legendDiv.innerHTML = '<div style="font-weight:bold;color:#00BFFF;margin-bottom:8px;font-size:13px;">üìã Jackson\'s Priority Areas</div>' +
    '<div style="color:#aaa;font-size:10px;margin-bottom:8px;">Key assets identified for limited-coverage deployment models (Feb 10 email)</div>' +
    '<div style="margin-bottom:6px;"><span style="color:#00BFFF;">‚ñ†</span> FSJ Priority Assets (' + priorityAreas.filter(a => a.style === priorityStyle).length + ')</div>' +
    '<div style="margin-bottom:8px;"><span style="color:#FFD700;">‚ñ†</span> Nak\'azdli First Nations (' + priorityAreas.filter(a => a.style === nakazdliStyle).length + ')</div>' +
    '<label style="display:block;cursor:pointer;margin-top:4px;"><input type="checkbox" checked onchange="if(this.checked){map.addLayer(window._priorityLayer)}else{map.removeLayer(window._priorityLayer)}"> Show Priority Zones</label>';
  document.body.appendChild(legendDiv);
  window._priorityLayer = priorityLayerGroup;
})();

</script>
</body>
</html>